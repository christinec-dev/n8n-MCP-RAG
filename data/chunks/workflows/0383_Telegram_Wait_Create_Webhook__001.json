{
  "source": "0383_Telegram_Wait_Create_Webhook.json",
  "index": 1,
  "content": "{\n  \"meta\": {\n    \"instanceId\": \"56d2f4e489ee5971b498fdc86622af934b4f6de5339e9825a61dbe25e604dccd\"\n  },\n  \"nodes\": [\n    {\n      \"id\": \"d2a02884-a082-4d77-8558-b819fdfd8e09\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -1305,\n        -337\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 629.040241216464,\n        \"height\": 1416.261500302191,\n        \"content\": \"## Use **Config Bot** to setup your telegram details, like:\\n1- Telegram Group ID (Don't forget add bot as admin)\\n2- Telegram Channel ID (Don't forget add bot as admin)\\n3- Your telegram Bot Token. (Generate through @BotFather)\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n## Setup data & filter & route to the correct Side.\\n0- None of them - Soon - Wait V2\\n1- Chat Type (`Private`)\\n2- Chat Type (`Supergroup`)\\n3- Chat Type (`Channel`)\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n## Remember:\\n* Do not make your support group public. Every message sent in the group on various topics will be forwarded to the user's ticket.\\n* There is no need to promote your broadcasting channel; the main reason for the channel is to organize and broadcast messages.\\n* You can host a Redis database without any coding/server management skills through Coolify.io.\\n* In the next version, I will add the **edit messages** feature, where the forwarded messages will be updated with the new edited one.\\n\\n## Why use this method?\\n* If you deal with Telegram P2P, anyone can delete messages from both sides. If you run a business, then one of your clients may delete all messages, causing you to lose the history. This solution prevents people from deleting messages; every message forwarded into the support group will not be possible to delete by the sender.\\n* Team collaboration: Why share one account when you can convert the whole group into a ticketing system? With this project, you can invite all your coworkers to reply and provide support to your clients through Telegram.\\n* Integrate with third-party services? Using N8N will pave the way for integrating your Telegram users' data into a CRM. In V2, we will enable the option to force new users to share their leads before receiving support.\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"c45c5efc-9c4d-4373-b267-bb13a01cb1de\",\n      \"name\": \"New User ?\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        -400,\n        -140\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{ $json.isEmpty() }}\",\n              \"value2\": \"true\",\n              \"operation\": \"regex\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"ab015a1f-9ee3-48f6-88c2-02d43fa739bc\",\n      \"name\": \"Format\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        -1260,\n        260\n      ],\n      \"parameters\": {\n        \"jsCode\": \"function escapeRedisJsonSyntax(value) {\\n  if (typeof value === 'string') {\\n    return value.replace(/[\\\"\\\\\\\\/]/g, '\\\\\\\\$&');\\n  }\\n  return value;\\n}\\n\\nconst outputItems = [];\\n\\nfor (let i = 0; i < items.length; i++) {\\n  const item = items[i];\\n  const escapedItem = { TG_USER_: {} };\\n\\n  for (const key in item) {\\n    const value = item[key];\\n    if (Array.isArray(value)) {\\n      escapedItem.TG_USER_[key] = [escapeRedisJsonSyntax(value[0])];\\n    } else if (typeof value === 'object') {\\n      flattenObject(value, escapedItem.TG_USER_, key);\\n    } else {\\n      escapedItem.TG_USER_[key] = escapeRedisJsonSyntax(value);\\n    }\\n  }\\n\\n  outputItems.push(escapedItem);\\n}\\n\\nfunction flattenObject(obj, result, prefix) {\\n  for (const key in obj) {\\n    const newKey = prefix ? `${prefix}_${key}` : key;\\n    const value = obj[key];\\n    if (typeof value === 'object') {\\n      if (Array.isArray(value)) {\\n        result[newKey] = [escapeRedisJsonSyntax(value[0])];\\n      } else {\\n        flattenObject(value, result, newKey);\\n      }\\n    } else {\\n      result[newKey.replace('json_message_', '').replace('json_', '')] = escapeRedisJsonSyntax(value);\\n    }\\n  }\\n}\\n\\nreturn outputItems;\\n\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"18c5126d-6c3e-4b5f-989e-d6830cb73a90\",\n      \"name\": \"Bot-Fields\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        -1120,\n        260\n      ],\n      \"parameters\": {\n        \"mode\": \"raw\",\n        \"include\": \"selected\",\n        \"options\": {},\n        \"jsonOutput\": \"={{ $json.TG_USER_.removeField('BotToken').removeField('pairedItem_item').removeField('Support_Group_ID') }}\"\n      },\n      \"typeVersion\": 3.2\n    },\n    {\n      \"id\": \"0cc142e7-4fbc-4104-9529-1087a7bac68a\",\n      \"name\": \"Create Topic (Chat Ticket)\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        80,\n        -260\n      ],\n      \"parameters\": {\n        \"url\": \"=https://api.telegram.org/bot{{ $('Bot-Config').item.json.BotToken }}/createForumTopic?chat_id={{ $('Bot-Config').item.json[\\\"Support_Group_ID\\\"]}}&name={{ encodeURIComponent(('['+$('Bot-Fields').item.json.from_first_name +'] - [id:'+ $('Bot-Fields').item.json.chat_id +']'))}}&icon_color=9367192&icon_custom_emoji_id=5417915203100613993\",\n        \"options\": {}\n      },\n      \"typeVersion\": 4.1\n    },\n    {\n      \"id\": \"e983994f-7922-49c2-8c4e-73100a030898\",\n      \"name\": \"Save Topic ID\",\n      \"type\": \"n8n-nodes-base.redis\",\n      \"position\": [\n        260,\n        -260\n      ],\n      \"parameters\": {\n        \"key\": \"=TG-USER-{{ $('Bot-Fields').item.json.chat_id }}\",\n        \"value\": \"={\\\"message_thread_id\\\":{{ $json.result.message_thread_id }}}\",\n        \"keyType\": \"hash\",\n        \"operation\": \"set\"\n      },\n      \"credentials\": {\n        \"redis\": {\n          \"id\": \"LNn51V8Wv8nlnOrK\",\n          \"name\": \"Livegram Bot\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"1f3afe0c-3ec4-431f-92b7-f06df5e1b39d\",\n      \"name\": \"Get User Chat Topic\",\n      \"type\": \"n8n-nodes-base.redis\",\n      \"position\": [\n        200,\n        -80\n      ],\n      \"parameters\": {\n        \"key\": \"=TG-USER-{{ $('Bot-Fields').item.json.chat_id }}\",\n        \"keyType\": \"hash\",\n        \"options\": {},\n        \"operation\": \"get\",\n        \"propertyName\": \"result\"\n      },\n      \"credentials\": {\n        \"redis\": {\n          \"id\": \"LNn51V8Wv8nlnOrK\",\n          \"name\": \"Livegram Bot\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"591e1768-58c9-428e-8a0d-69ba4cce7ccc\",\n      \"name\": \"Forward New Message\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"onError\": \"continueErrorOutput\",\n      \"position\": [\n        560,\n        -80\n      ],\n      \"parameters\": {\n        \"url\": \"=https://api.telegram.org/bot{{ $('Bot-Config').item.json.BotToken }}/forwardMessage?chat_id={{ $('Bot-Config').item.json[\\\"Support_Group_ID\\\"] }}&message_thread_id={{ $json[\\\"result\\\"][\\\"message_thread_id\\\"] }}&from_chat_id={{ $('Bot-Fields').item.json[\\\"chat_id\\\"] }}&message_id={{ $('Bot-Fields').item.json[\\\"message_id\\\"] }}\",\n        \"method\": \"POST\",\n        \"options\": {}\n      },\n      \"typeVersion\": 4.1\n    },\n    {\n      \"id\": \"fd063a6d-0caa-4f81-921d-f8fa952d7b9b\",\n      \"name\": \"IF No Topic Created\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        40,\n        320\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{ $json.error.message }}\",\n              \"value2\": \"thread not found\",\n              \"operation\": \"contains\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"ef044803-5e2e-4e54-a10b-21ad5feadb26\",\n      \"name\": \"ReCreate Topic (Chat Ticket)\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        220,\n        220\n      ],\n      \"parameters\": {\n        \"url\": \"=https://api.telegram.org/bot{{ $('Bot-Config').item.json.BotToken }}/createForumTopic?chat_id={{ $('Bot-Config').item.json[\\\"Support_Group_ID\\\"]}}&name={{ encodeURIComponent(('['+$('Bot-Fields').item.json.from_first_name +'] - [id:'+ $('Bot-Fields').item.json.chat_id +']'))}}&icon_color=9367192&icon_custom_emoji_id=5417915203100613993\",\n        \"options\": {}\n      },\n      \"typeVersion\": 4.1\n    },\n    {\n      \"id\": \"691398ab-b434-46d0-b3fe-046235d7cdf8\",\n      \"name\": \"ReSave Topic ID\",\n      \"type\": \"n8n-nodes-base.redis\",\n      \"position\": [\n        380,\n        220\n      ],\n      \"parameters\": {\n        \"key\": \"=TG-USER-{{ $('Bot-Fields').item.json.chat_id }}\",\n        \"value\": \"={\\\"message_thread_id\\\":{{ $json.result.message_thread_id }}}\",\n        \"keyType\": \"hash\",\n        \"operation\": \"set\"\n      },\n      \"credentials\": {\n        \"redis\": {\n          \"id\": \"LNn51V8Wv8nlnOrK\",\n          \"name\": \"Livegram Bot\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"69fc3fe2-a339-4c99-a85b-6facf41526bf\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        20,\n        120.47661481708235\n      ],\n      \"parameters\": {\n        \"color\": 3,\n        \"width\": 734.3067601294108,\n        \"height\": 466.5190319644644,\n        \"content\": \"## Re Create New Topic\\n**Sometimes** in support group may the team delete or close a ticket (topic) in case of that this steps will create topic again for the user, and store the new ticket id (topic/thread ID).\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"4cb855d4-a306-4bd4-b24d-ee5f6db518d4\",\n      \"name\": \"Update User Data\",\n      \"type\": \"n8n-nodes-base.redis\",\n      \"position\": [\n        -140,\n        -80\n      ],\n      \"parameters\": {\n        \"key\": \"=TG-USER-{{ $('Bot-Fields').item.json.chat_id }}\",\n        \"value\": \"={{ $item(\\\"0\\\").$node[\\\"Bot-Fields\\\"].json }}\",\n        \"keyType\": \"hash\",\n        \"operation\": \"set\"\n      },\n      \"credentials\": {\n        \"redis\": {\n          \"id\": \"LNn51V8Wv8nlnOrK\",\n          \"name\": \"Livegram Bot\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"878f0dec-ad7b-4584-b20a-dd3db634d6dd\",\n      \"name\": \"Save User Data\",\n      \"type\": \"n8n-nodes-base.redis\",\n      \"position\": [\n        -140,\n        -260\n      ],\n      \"parameters\": {\n        \"key\": \"=TG-USER-{{ $('Bot-Fields').item.json.chat_id }}\",\n        \"value\": \"={{ $item(\\\"0\\\").$node[\\\"Bot-Fields\\\"].json }}\",\n        \"keyType\": \"hash\",\n        \"operation\": \"set\"\n      },\n      \"credentials\": {\n        \"redis\": {\n          \"id\": \"LNn51V8Wv8nlnOrK\",\n          \"name\": \"Livegram Bot\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"e411b235-74bf-4f1b-9070-da1d0dc15815\",\n      \"name\": \"Support Forum\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        -620,\n        240\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{ $('Bot-Config').item.json.message.chat.id }}\",\n              \"value2\": \"={{ $('Bot-Config').item.json.Support_Group_ID }}\",\n              \"operation\": \"regex\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"05c04455-1406-47aa-8a81-aa2ec914c502\",\n      \"name\": \"From Ticket\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        -420,\n        220\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{ $('Bot-Fields').item.json.message_thread_id }}\",\n              \"operation\": \"isNotEmpty\"\n            },\n            {\n              \"value1\": \"={{ $('Bot-Fields').item.json.reply_to_message_is_topic_message }}\",\n              \"value2\": \"true\",\n              \"operation\": \"regex\"\n            },\n            {\n              \"value1\": \"={{ $('Bot-Fields').item.json.is_topic_message }}\",\n              \"value2\": \"true\",\n              \"operation\": \"regex\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"71b55beb-7c93-40a1-a94b-f411d11eb713\",\n      \"name\": \"Forward Support Reply To User\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        -200,\n        200\n      ],\n      \"parameters\": {\n        \"url\": \"=https://api.telegram.org/bot{{ $('Bot-Config').item.json.BotToken }}/forwardMessage?chat_id={{ $json[\\\"reply_to_message_forward_from_id\\\"] || $('Bot-Fields').item.json.reply_to_message_forum_topic_created_name.match(/\\\\[id:(\\\\d+)\\\\]/)[1] }}&from_chat_id={{ $('Bot-Config').item.json[\\\"Support_Group_ID\\\"] }}&message_id={{ $('Bot-Fields').item.json[\\\"message_id\\\"] }}\",\n        \"method\": \"POST\",\n        \"options\": {}\n      },\n      \"typeVersion\": 4.1\n    },\n    {\n      \"id\": \"aa70a9f6-ac3c-4ac4-a829-ef3e35720f2f\",\n      \"name\": \"IF Topic Created\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        -420,\n        440\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{ $json.forum_topic_created_name.isNotEmpty() }}\",\n              \"value2\": \"true\",\n              \"operation\": \"regex\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"4b1ba81a-6986-48a9-b439-cd79cfe278b7\",\n      \"name\": \"Forward New Message to the recrated topic\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        540,\n        220\n      ],\n      \"parameters\": {\n        \"url\": \"=https://api.telegram.org/bot{{ $('Bot-Config').item.json.BotToken }}/forwardMessage?chat_id={{ $('Bot-Config').item.json[\\\"Support_Group_ID\\\"] }}&message_thread_id={{ $json[\\\"result\\\"][\\\"message_thread_id\\\"] }}&from_chat_id={{ $('Bot-Fields').item.json[\\\"chat_id\\\"] }}&message_id={{ $('Bot-Fields').item.json[\\\"message_id\\\"] }}\",\n        \"method\": \"POST\",\n        \"options\": {}\n      },\n      \"typeVersion\": 4.1\n    },\n    {\n      \"id\": \"7eef7a26-8c59-4020-90f8-45f28e36c43f\",\n      \"name\": \"No Operation, do nothing\",\n      \"type\": \"n8n-nodes-base.noOp\",\n      \"position\": [\n        540,\n        420\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"db77035a-1256-4210-a13d-8333778fb579\",\n      \"name\": \"Check User in Database\",\n      \"type\": \"n8n-nodes-base.redis\",\n      \"notes\": \"Search Key\",\n      \"position\": [\n        -580,\n        -140\n      ],\n      \"parameters\": {\n        \"operation\": \"keys\",\n        \"keyPattern\": \"=TG-USER-{{ $json.chat_id }}\"\n      },\n      \"credentials\": {\n        \"redis\": {\n          \"id\": \"LNn51V8Wv8nlnOrK\",\n          \"name\": \"Livegram Bot\"\n        }\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"c01200b7-8aa4-4d44-a9a9-a802179f3afc\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -660,\n        120\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 656,\n        \"height\": 473,\n        \"content\": \"## Support Side\\n**This Part** is meant to forward replies that sent by support (members in the group)\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"a443f847-248a-4287-8aad-737c4891b344\",\n      \"name\": \"Send User Ticket Created Notification\",\n      \"type\": \"n8n-nodes-base.telegram\",\n      \"position\": [\n        -220,\n        420\n      ],\n      \"parameters\": {\n        \"text\": \"A new ticket has been created for you. Please wait while one of our support team members becomes available to reply.\",\n        \"chatId\": \"={{ $json.forum_topic_created_name.match(/\\\\[id:(\\\\d+)\\\\]/)[1] }}\",\n        \"additionalFields\": {\n          \"appendAttribution\": false\n        }\n      },\n      \"credentials\": {\n        \"telegramApi\": {\n          \"id\": \"dZzfZH7baUnF4hiH\",\n          \"name\": \"The Live Chat Bot\"\n        }\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"2746b480-91ed-4968-809d-9eca523d290a\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -656.2527877074685,\n        -340\n      ],\n      \"parameters\": {\n        \"color\": 3,\n        \"width\": 1409.9137494026593,\n        \"height\": 422,\n        \"content\": \"## User Side\\n**This Part** is meant to save user data on a RAM database which is fast, and in same time forward the message to support after creating a new ticket (Topic) dedciated for the user id in the support group.\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"545d768f-a0b2-465a-a084-c43a6231d31a\",\n      \"name\": \"Bot-Config\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        -880,\n        -200\n      ],\n      \"parameters\": {\n        \"fields\": {\n          \"values\": [\n            {\n              \"name\": \"BotToken\",\n              \"stringValue\": \"Your Bot Token here (Also add credntinals in Telegram Node)\"\n            },\n            {\n              \"name\": \"Support_Group_ID\",\n              \"stringValue\": \"Your Telegram Group here (Don't forget to give BOT admin privileges)\"\n            },\n            {\n              \"name\": \"Boradcast_Channel_ID\",\n              \"stringValue\": \"Your Telegram Channel here (Don't forget to give BOT admin privileges)\"\n            }\n          ]\n        },\n        \"options\": {}\n      },\n      \"typeVersion\": 3.2\n    },\n    {\n      \"id\": \"59145dcd-51e3-4392-ad79-85601c872931\",\n      \"name\": \"Telegram-Bot\",\n      \"type\": \"n8n-nodes-base.telegramTrigger\",\n      \"position\": [\n        -1240,\n        -200\n      ],\n      \"webhookId\": \"d8b773ab-aee9-494b-8749-f0aa80032871\",\n      \"parameters\": {\n        \"updates\": [\n          \"message\",\n          \"channel_post\"\n        ],\n        \"additionalFields\": {}\n      },\n      \"credentials\": {\n        \"telegramApi\": {\n          \"id\": \"dZzfZH7baUnF4hiH\",\n          \"name\": \"The Live Chat Bot\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"14b0ac28-5be5-4878-ab57-f7361291cc8e\",\n      \"name\": \"1st\",\n      \"type\": \"n8n-nodes-base.switch\",\n      \"position\": [\n        -980,\n        260\n      ],\n      \"parameters\": {\n        \"rules\": {\n          \"rules\": [\n            {\n              \"output\": 1,\n              \"value2\": \"private\",\n              \"operation\": \"regex\"\n            },\n            {\n              \"output\": 2,\n              \"value2\": \"supergroup\",\n              \"operation\": \"regex\"\n            },\n            {\n              \"output\": 3,\n              \"value2\": \"channel\",\n              \"operation\": \"regex\"\n            }\n          ]\n        },\n        \"value1\": \"={{ $json.chat_type || $json.channel_post_sender_chat_type }}\",\n        \"dataType\": \"string\",\n        \"fallbackOutput\": 0\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"d91e0fdf-7344-4968-beac-49c2331b5170\",\n      \"name\": \"Split In Batches1\",\n      \"type\": \"n8n-nodes-base.splitInBatches\",\n      \"notes\": \"Telegram Limitation 29/sec\",\n      \"position\": [\n        160,\n        780\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"batchSize\": 29\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"f6ce5dbb-8707-4243-9814-5bd57397e652\",\n      \"name\": \"Wait1\",\n      \"type\": \"n8n-nodes-base.wait\",\n      \"position\": [\n        560,\n        740\n      ],\n      \"webhookId\": \"9f87deed-d502-46d3-8c85-ce99552a0441\",\n      \"parameters\": {\n        \"unit\": \"seconds\",\n        \"amount\": 3\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"640e9ca9-de7d-4dae-a15a-d0232864c877\",\n      \"name\": \"Format Users\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        -200,\n        780\n      ],\n      \"parameters\": {\n        \"jsCode\": \"let response = items[0].json; // get the Redis response\\nlet newItems = []; // to store the new items\\n\\nfor(let key in response) {\\n    if(response.hasOwnProperty(key)) {\\n        newItems.push({\\n            json: {\\n                user: response[key]\\n            }\\n        });\\n    }\\n}\\n\\nreturn newItems;\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"8c330aca-3720-439e-87c6-47d914f828c3\",\n      \"name\": \"Broadcast Channel Post into Users\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"onError\": \"continueErrorOutput\",\n      \"position\": [\n        380,\n        760\n      ],\n      \"parameters\": {\n        \"url\": \"=https://api.telegram.org/bot{{ $('Bot-Config').item.json.BotToken }}/copyMessage?chat_id={{ $('Split In Batches1').item.json[\\\"user\\\"][\\\"chat_id\\\"] }}&from_chat_id={{ $('Bot-Config').item.json[\\\"Boradcast_Channel_ID\\\"] }}&message_id={{ $('Bot-Config').item.json[\\\"channel_post\\\"][\\\"message_id\\\"] }}\",\n        \"method\": \"POST\",\n        \"options\": {}\n      },\n      \"typeVersion\": 4.1\n    },\n    {\n      \"id\": \"3beb15dd-6e76-4350-97c3-22f39d768497\",\n      \"name\": \"Set Blocked Member\",\n      \"type\": \"n8n-nodes-base.redis\",\n      \"position\": [\n        560,\n        900\n      ],\n      \"parameters\": {\n        \"key\": \"=TG-USER-{{ $('Bot-Fields').item.json.chat_id || $('Split In Batches1').item.json.user.chat_id }}\",\n        \"value\": \"={\\\"Blocked\\\":{{ '1' }}}\",\n        \"keyType\": \"hash\",\n        \"operation\": \"set\"\n      },\n      \"credentials\": {\n        \"redis\": {\n          \"id\": \"LNn51V8Wv8nlnOrK\",\n          \"name\": \"Livegram Bot\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"03d457f1-ca11-4134-b0f9-d4d029ce141a\",\n      \"name\": \"IF Verified Channel\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        -558,\n        800\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{ $('Bot-Config').item.json.channel_post.sender_chat.id }}\",\n              \"value2\": \"={{ $('Bot-Config').item.json.Boradcast_Channel_ID }}\",\n              \"operation\": \"regex\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"6f38d2d0-5734-4829-ab97-8aca57827646\",\n      \"name\": \"Filter Blocked Users\",\n      \"type\": \"n8n-nodes-base.filter\",\n      \"position\": [\n        -20,\n        780\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{ $json.user.Blocked }}\",\n              \"value2\": \"1\",\n              \"operation\": \"notRegex\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"37ffb301-0284-493e-abed-aaff293b4a92\",\n      \"name\": \"Sticky Note4\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -660,\n        620\n      ],\n      \"parameters\": {\n        \"color\": 6,\n        \"width\": 1413.320293398532,\n        \"height\": 460.58353708231465,\n        \"content\": \"## Channel Side (Broadcasting)\\n**This Part** where the support of brand broadcasting message to all previous users who used this bot before.\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"d34a0080-6db8-4d29-b6ff-b0b0bf3be8af\",\n      \"name\": \"Retrieve all users in DB\",\n      \"type\": \"n8n-nodes-base.redis\",\n      \"notes\": \"Search Key\",\n      \"position\": [\n        -378,\n        780\n      ],\n      \"parameters\": {\n        \"operation\": \"keys\",\n        \"keyPattern\": \"=TG-USER-*\"\n      },\n      \"credentials\": {\n        \"redis\": {\n          \"id\": \"LNn51V8Wv8nlnOrK\",\n          \"name\": \"Livegram Bot\"\n        }\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1\n    }\n  ],\n  \"pinData\": {},\n  \"connections\": {\n    \"1st\": {\n      \"main\": [\n        null,\n        [\n          {\n            \"node\": \"Check User in Database\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Support Forum\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"IF Verified Channel\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Wait1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Split In Batches1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Format\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Bot-Fields\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Bot-Config\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Format\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Bot-Fields\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"1st\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"New User ?\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Save User Data\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Update User Data\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"From Ticket\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Forward Support Reply To User\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"IF Topic Created\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Format Users\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Filter Blocked Users\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Telegram-Bot\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Bot-Config\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Save Topic ID\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Forward New Message\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Support Forum\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"From Ticket\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Save User Data\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Create Topic (Chat Ticket)\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"ReSave Topic ID\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Forward New Message to the recrated topic\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"IF Topic Created\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Send User Ticket Created Notification\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Update User Data\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get User Chat Topic\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Split In Batches1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Broadcast Channel Post into Users\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Set Blocked Member\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Split In Batches1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Forward New Message\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"No Operation, do nothing\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"IF No Topic Created\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get User Chat Topic\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Forward New Message\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"IF No Topic Created\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"ReCreate Topic (Chat Ticket)\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"No Operation, do nothing\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"IF Verified Channel\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Retrieve all users in DB\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"No Operation, do nothing\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Filter Blocked Users\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Split In Batches1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Check User in Database\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"New User ?\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Retrieve all users in DB\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Format Users\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Create Topic (Chat Ticket)\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Save Topic ID\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"ReCreate Topic (Chat Ticket)\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"ReSave Topic ID\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Forward Support Reply To User\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"No Operation, do nothing\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Broadcast Channel Post into Users\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Wait1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Set Blocked Member\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Send User Ticket Created Notification\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"No Operation, do nothing\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Forward New Message to the recrated topic\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"No Operation, do nothing\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.if",
      "n8n-nodes-base.code",
      "n8n-nodes-base.set",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.redis",
      "n8n-nodes-base.redis",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.if",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.redis",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.redis",
      "n8n-nodes-base.redis",
      "n8n-nodes-base.if",
      "n8n-nodes-base.if",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.if",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.noOp",
      "n8n-nodes-base.redis",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.telegram",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.set",
      "n8n-nodes-base.telegramTrigger",
      "n8n-nodes-base.switch",
      "n8n-nodes-base.splitInBatches",
      "n8n-nodes-base.wait",
      "n8n-nodes-base.code",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.redis",
      "n8n-nodes-base.if",
      "n8n-nodes-base.filter",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.redis"
    ],
    "trigger": null
  }
}