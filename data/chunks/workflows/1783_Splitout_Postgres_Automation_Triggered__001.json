{
  "source": "1783_Splitout_Postgres_Automation_Triggered.json",
  "index": 1,
  "content": "{\n  \"id\": \"ZiIoKEClTk83g1Jt\",\n  \"meta\": {\n    \"instanceId\": \"8a3ba313628b26e4e4cf0504ff23322f235d6b433d92e59bcf8762764730ed80\",\n    \"templateCredsSetupCompleted\": true\n  },\n  \"name\": \"Gmail to Vector Embeddings with PGVector and Ollama\",\n  \"tags\": [],\n  \"nodes\": [\n    {\n      \"id\": \"162b1a8b-2471-4880-9fcb-7f2dcfe175a8\",\n      \"name\": \"Embeddings Ollama\",\n      \"type\": \"@n8n/n8n-nodes-langchain.embeddingsOllama\",\n      \"position\": [\n        1920,\n        -100\n      ],\n      \"parameters\": {\n        \"model\": \"nomic-embed-text:latest\"\n      },\n      \"credentials\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"49eb04b0-3b54-499c-ba46-3251102a4017\",\n      \"name\": \"Default Data Loader\",\n      \"type\": \"@n8n/n8n-nodes-langchain.documentDefaultDataLoader\",\n      \"position\": [\n        2040,\n        -97.5\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"metadata\": {\n            \"metadataValues\": [\n              {\n                \"name\": \"emails_metadata.id\",\n                \"value\": \"={{ $('Extract email fields').item.json.email_id }}\"\n              },\n              {\n                \"name\": \"emails_metadata.thread_id\",\n                \"value\": \"={{ $('Extract email fields').item.json.thread_id }}\"\n              }\n            ]\n          }\n        },\n        \"jsonData\": \"={{ $('Extract email fields').item.json.email_text }}\",\n        \"jsonMode\": \"expressionData\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b4853472-6ac7-4da5-97b3-b22950ddff06\",\n      \"name\": \"Recursive Character Text Splitter\",\n      \"type\": \"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter\",\n      \"position\": [\n        2128,\n        100\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"chunkSize\": 2000,\n        \"chunkOverlap\": 50\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b189f134-f78e-438f-9189-2f2b276b487d\",\n      \"name\": \"Gmail Trigger\",\n      \"type\": \"n8n-nodes-base.gmailTrigger\",\n      \"position\": [\n        1260,\n        280\n      ],\n      \"parameters\": {\n        \"simple\": false,\n        \"filters\": {\n          \"labelIds\": [\n            \"INBOX\"\n          ]\n        },\n        \"options\": {\n          \"downloadAttachments\": true\n        },\n        \"pollTimes\": {\n          \"item\": [\n            {\n              \"mode\": \"everyMinute\"\n            }\n          ]\n        }\n      },\n      \"credentials\": {},\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"81cba4c5-7762-483d-a076-3fa8799f70ce\",\n      \"name\": \"Loop Over Items\",\n      \"type\": \"n8n-nodes-base.splitInBatches\",\n      \"position\": [\n        840,\n        40\n      ],\n      \"parameters\": {\n        \"options\": {}\n      },\n      \"typeVersion\": 3\n    },\n    {\n      \"id\": \"f82243ad-6efd-4be2-bf4e-5001870ae854\",\n      \"name\": \"Split Out\",\n      \"type\": \"n8n-nodes-base.splitOut\",\n      \"position\": [\n        640,\n        40\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"destinationFieldName\": \"after\"\n        },\n        \"fieldToSplitOut\": \"weeks\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"2163d5ec-416f-4299-8a9d-10c26eaef32f\",\n      \"name\": \"Was manually triggered?\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        2416,\n        -145\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"version\": 2,\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"strict\"\n          },\n          \"combinator\": \"and\",\n          \"conditions\": [\n            {\n              \"id\": \"3cbc77e7-1796-4e1b-bbff-6391dd131336\",\n              \"operator\": {\n                \"type\": \"boolean\",\n                \"operation\": \"false\",\n                \"singleValue\": true\n              },\n              \"leftValue\": \"={{ $('Manual Trigger').isExecuted }}\",\n              \"rightValue\": \"\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2.2\n    },\n    {\n      \"id\": \"76557325-c94e-47a9-9384-e6cbea94f67e\",\n      \"name\": \"Manual Trigger\",\n      \"type\": \"n8n-nodes-base.manualTrigger\",\n      \"position\": [\n        0,\n        40\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b9400906-a458-4305-8805-bb6bea17396b\",\n      \"name\": \"No Operation, do nothing\",\n      \"type\": \"n8n-nodes-base.noOp\",\n      \"position\": [\n        2636,\n        -145\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"5f0aa7c2-85b3-4585-8c8c-727af27de61c\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -60,\n        -540\n      ],\n      \"parameters\": {\n        \"color\": 6,\n        \"width\": 1440,\n        \"height\": 780,\n        \"content\": \"## Bulk e-mail import\\n\\nPress the `Test workflow` button to run this once, and bulk import of all your e-mail\\n\\n### IMPORTANT\\nSpecify your Gmail account creation date by editing the code node\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"2b85d362-d40d-49c0-b3a7-27fdbee8e90b\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        360,\n        -100\n      ],\n      \"parameters\": {\n        \"width\": 220,\n        \"height\": 300,\n        \"content\": \"## Edit this ⬇️\\nAnd specify your Gmail account creation date\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"05a9dd25-ae36-4e3c-a249-787ee1047bff\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        740,\n        260\n      ],\n      \"parameters\": {\n        \"color\": 4,\n        \"width\": 640,\n        \"height\": 180,\n        \"content\": \"## Activate the workflow\\nAnd this trigger will check for new mail, every minute\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"3f19abc5-a165-49e8-b97e-233c47949e68\",\n      \"name\": \"Set before and after dates\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1040,\n        -320\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"48e8d703-e52a-46cc-bd72-9b0d3352091b\",\n              \"name\": \"after\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.after }}\"\n            },\n            {\n              \"id\": \"a515cf56-9bc6-4724-a0ef-01a6159606f7\",\n              \"name\": \"before\",\n              \"type\": \"string\",\n              \"value\": \"={{ DateTime.fromISO($json.after).plus(1, 'week').toISODate() }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"af742b17-2086-4698-af3a-32cb7260f380\",\n      \"name\": \"Extract email fields\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1480,\n        -320\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"f818bad8-b000-499c-b137-de22dff4a343\",\n              \"name\": \"email_text\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.text }}\"\n            },\n            {\n              \"id\": \"68c16520-4a26-4ea9-95f7-ee89b9f53c4f\",\n              \"name\": \"email_from\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.from?.text ?? '' }}\"\n            },\n            {\n              \"id\": \"981f1f5b-ba2f-4153-966c-45bb6b535794\",\n              \"name\": \"email_to\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.to?.text ?? '' }}\"\n            },\n            {\n              \"id\": \"b528dd23-a743-4a55-98df-e1ae823b29b3\",\n              \"name\": \"date\",\n              \"type\": \"string\",\n              \"value\": \"={{ DateTime.fromISO($json.date).toISO() }}\"\n            },\n            {\n              \"id\": \"39081032-e503-470b-8d83-b5064238d037\",\n              \"name\": \"email_id\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.id }}\"\n            },\n            {\n              \"id\": \"146e8e72-3c2c-4320-b93a-b109d2e46139\",\n              \"name\": \"thread_id\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.threadId }}\"\n            },\n            {\n              \"id\": \"a49333a5-c565-4d46-8398-d423072b1e4d\",\n              \"name\": \"email_subject\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.subject }}\"\n            },\n            {\n              \"id\": \"806cf930-450e-4221-8061-a71ec8bf9bbe\",\n              \"name\": \"attachments\",\n              \"type\": \"array\",\n              \"value\": \"={{ Object.keys($binary).map(item => $binary[item].fileName).filter(item => !!item) }}\"\n            },\n            {\n              \"id\": \"30a38aaf-04c2-4286-99c9-8bb60ae8b317\",\n              \"name\": \"email_cc\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.cc?.text ?? ''}}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"a51f5d5f-69c7-4153-be7f-492a8694629a\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1640,\n        -540\n      ],\n      \"parameters\": {\n        \"width\": 720,\n        \"height\": 780,\n        \"content\": \"## Magic here 🪄\\n#### (not really, just statistics)\\nE-mail is stored in a `emails_metadata` structured table, and also fed to the [`nomic-embed-text`](https://ollama.com/library/nomic-embed-text) model to be stored in a `emails_embeddings` table as [vector embeddings](https://www.pinecone.io/learn/vector-embeddings/) so similarity searches are possible.\\n\\nThe `email_id` field can be used to make the relation between the structured records and the vector embeddings, as it's stored in their metadata as `emails_metadata.id`.\\nThis is also the case for `thread_id`.\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"809e9269-1275-4c87-8c7f-1840c76f5b22\",\n      \"name\": \"Store structured\",\n      \"type\": \"n8n-nodes-base.postgres\",\n      \"onError\": \"continueErrorOutput\",\n      \"position\": [\n        1700,\n        -320\n      ],\n      \"parameters\": {\n        \"table\": {\n          \"__rl\": true,\n          \"mode\": \"name\",\n          \"value\": \"emails_metadata\"\n        },\n        \"schema\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"public\"\n        },\n        \"columns\": {\n          \"value\": {},\n          \"schema\": [\n            {\n              \"id\": \"email_id\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": true,\n              \"displayName\": \"email_id\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"thread_id\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"thread_id\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"email_from\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"email_from\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"email_to\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"email_to\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"email_cc\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"email_cc\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"date\",\n              \"type\": \"dateTime\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": true,\n              \"displayName\": \"date\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"email_subject\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"email_subject\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"attachments\",\n              \"type\": \"array\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"attachments\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"email_text\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"email_text\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            }\n          ],\n          \"mappingMode\": \"autoMapInputData\",\n          \"matchingColumns\": [\n            \"email_id\"\n          ],\n          \"attemptToConvertTypes\": false,\n          \"convertFieldsToString\": false\n        },\n        \"options\": {\n          \"outputColumns\": [\n            \"*\"\n          ]\n        },\n        \"operation\": \"upsert\"\n      },\n      \"credentials\": {},\n      \"typeVersion\": 2.6\n    },\n    {\n      \"id\": \"1c3dca79-381c-411b-8727-baa297e1ceda\",\n      \"name\": \"Store vectorized\",\n      \"type\": \"@n8n/n8n-nodes-langchain.vectorStorePGVector\",\n      \"onError\": \"continueRegularOutput\",\n      \"position\": [\n        1936,\n        -320\n      ],\n      \"parameters\": {\n        \"mode\": \"insert\",\n        \"options\": {},\n        \"tableName\": \"emails_embeddings\"\n      },\n      \"credentials\": {},\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"3b7e13b2-73e9-42e7-900c-59611fe5af32\",\n      \"name\": \"Create the table\",\n      \"type\": \"n8n-nodes-base.postgres\",\n      \"position\": [\n        200,\n        40\n      ],\n      \"parameters\": {\n        \"query\": \"CREATE TABLE IF NOT EXISTS public.emails_metadata (\\n    email_id character varying(64) NOT NULL,\\n    thread_id character varying(64),\\n    email_from text,\\n    email_to text,\\n    email_cc text,\\n    date timestamp with time zone NOT NULL,\\n    email_subject text,\\n    email_text text,\\n    attachments text[]\\n);\\n\",\n        \"options\": {},\n        \"operation\": \"executeQuery\"\n      },\n      \"credentials\": {},\n      \"typeVersion\": 2.6\n    },\n    {\n      \"id\": \"19c55312-d1da-4d1e-8637-c5b08a9c1a2d\",\n      \"name\": \"Explode interval into weeks\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        420,\n        40\n      ],\n      \"parameters\": {\n        \"mode\": \"runOnceForEachItem\",\n        \"jsCode\": \"// Edit this\\nlet whenDidICreateMyGmailAccount = DateTime.fromISO('2013-11-01')\\n\\n// (don't edit further down)\\nwhenDidICreateMyGmailAccount = whenDidICreateMyGmailAccount.set({day: 1})\\nlet now = $now.set({day: 1})\\nconst weeks = []\\nwhile (Math.floor(Interval.fromDateTimes(whenDidICreateMyGmailAccount, now).length('weeks')) > -1) {\\n  weeks.push(now.toISODate())\\n  now = now.minus({weeks: 1})\\n}\\n\\nreturn {json: { weeks }};\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"aed43a77-6d58-41ba-b0b0-fdd3e9fe777a\",\n      \"name\": \"Get a batch of messages\",\n      \"type\": \"n8n-nodes-base.gmail\",\n      \"position\": [\n        1260,\n        -320\n      ],\n      \"webhookId\": \"bace3678-df5b-4a9c-a1ef-1c219e3fd07b\",\n      \"parameters\": {\n        \"simple\": false,\n        \"filters\": {\n          \"receivedAfter\": \"={{ $json.after }}\",\n          \"receivedBefore\": \"={{ $json.before }}\"\n        },\n        \"options\": {\n          \"downloadAttachments\": true\n        },\n        \"operation\": \"getAll\",\n        \"returnAll\": true\n      },\n      \"credentials\": {},\n      \"typeVersion\": 2.1\n    }\n  ],\n  \"active\": false,\n  \"pinData\": {\n    \"Manual Trigger\": [\n      {\n        \"json\": {}\n      }\n    ]\n  },\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"versionId\": \"3c337d42-a3bb-4b71-ac36-deaf0cdf6019\",\n  \"connections\": {\n    \"Split Out\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Loop Over Items\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Gmail Trigger\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract email fields\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Manual Trigger\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Create the table\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Loop Over Items\": {\n      \"main\": [\n        [],\n        [\n          {\n            \"node\": \"Set before and after dates\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Create the table\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Explode interval into weeks\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Store structured\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Store vectorized\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Loop Over Items\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Store vectorized\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Was manually triggered?\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        []\n      ]\n    },\n    \"Embeddings Ollama\": {\n      \"ai_embedding\": [\n        [\n          {\n            \"node\": \"Store vectorized\",\n            \"type\": \"ai_embedding\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Default Data Loader\": {\n      \"ai_document\": [\n        [\n          {\n            \"node\": \"Store vectorized\",\n            \"type\": \"ai_document\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Extract email fields\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Store structured\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get a batch of messages\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract email fields\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Was manually triggered?\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"No Operation, do nothing\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Loop Over Items\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Set before and after dates\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get a batch of messages\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Explode interval into weeks\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Split Out\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Recursive Character Text Splitter\": {\n      \"ai_textSplitter\": [\n        [\n          {\n            \"node\": \"Default Data Loader\",\n            \"type\": \"ai_textSplitter\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "n8n-nodes-base.gmailTrigger",
      "n8n-nodes-base.splitInBatches",
      "n8n-nodes-base.splitOut",
      "n8n-nodes-base.if",
      "n8n-nodes-base.manualTrigger",
      "n8n-nodes-base.noOp",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.set",
      "n8n-nodes-base.set",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.postgres",
      "@n8n/n8n-nodes-langchain.vectorStorePGVector",
      "n8n-nodes-base.postgres",
      "n8n-nodes-base.code",
      "n8n-nodes-base.gmail"
    ],
    "trigger": "gmail trigger"
  }
}