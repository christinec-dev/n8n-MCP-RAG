{
  "source": "0139_HTTP_Mysql_Automation_Webhook.json",
  "index": 1,
  "content": "{\n  \"nodes\": [\n    {\n      \"name\": \"emitirEtiqueta\",\n      \"type\": \"n8n-nodes-base.webhook\",\n      \"position\": [\n        440,\n        1290\n      ],\n      \"webhookId\": \"4431a14c-62c6-4602-8e20-e661f1d3d706\",\n      \"parameters\": {\n        \"path\": \"emitirEtiqueta\",\n        \"options\": {},\n        \"httpMethod\": \"POST\",\n        \"responseData\": \"allEntries\",\n        \"responseMode\": \"lastNode\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"dadosProduto\",\n      \"type\": \"n8n-nodes-base.mySql\",\n      \"position\": [\n        1270,\n        1440\n      ],\n      \"parameters\": {\n        \"query\": \"=-- CONSULTA DO PRODUTO GRADE\\nWITH pg as (\\n\\tSELECT\\n\\t\\tid,\\n\\t\\tid_produto,\\n\\t\\tid_gradex,\\n\\t\\tid_gradey,\\n\\t\\tcodigo \\n\\tFROM\\n\\t\\tproduto_grade \\n\\tWHERE\\n\\t\\tid = '{{$node[\\\"emitirEtiqueta\\\"].json[\\\"body\\\"][\\\"id_produto_grade\\\"]}}'\\n),\\n\\n-- CONSULTA DO PRODUTO\\np as (\\n\\tSELECT * FROM produto \\n\\tWHERE id IN ( SELECT id_produto  FROM pg)\\n\\tAND situacao = 'ATIVO'\\n),\\n\\n-- CONSULTA TECIDO\\nt as (\\n\\tSELECT\\n\\t\\ttoken,\\n\\t\\t JSON_UNQUOTE(json_extract( objeto, '$.largura')) AS largura\\n\\tFROM\\n\\t\\t`{{$node[\\\"PegarConfiguracaoImpressao\\\"].json[\\\"params\\\"][\\\"bancoRelatorio\\\"]}}`.`i_objeto` \\n\\tWHERE\\n\\t\\tmodulo = 'produto_grade_tecido'\\n\\t\\tand token in (select id from pg)\\n\\t\\tand situacao = 'ATIVO'\\n),\\n\\n\\n-- CONSULTA COMPOSICAO\\ncp as (\\n\\t\\n\\tSELECT\\n\\t  token,\\n    group_concat(concat(cps.participacao,'% ',cps.descricao)) as composicao\\n\\tFROM\\n\\t\\t`{{$node[\\\"PegarConfiguracaoImpressao\\\"].json[\\\"params\\\"][\\\"bancoRelatorio\\\"]}}`.`i_objeto`,\\n\\t\\tJSON_TABLE (\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tobjeto,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t'$[*]' COLUMNS (  \\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tparticipacao INT path '$.participacao',\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tdescricao TEXT path '$.descricao'\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t) AS cps \\n\\t\\tWHERE modulo = 'produto_grade_tecido_composicao'\\n\\t\\tAND token in (select id from pg)\\n\\t\\tAND situacao = 'ATIVO'\\n\\t\\tAND cps.participacao > 0\\n\\t\\tGROUP BY token\\n\\t\\tORDER BY participacao desc\\n\\t\\t\\n)\\n\\n\\n-- CONSULTA RELATORIO\\nSELECT\\n{{$node[\\\"emitirEtiqueta\\\"].json[\\\"body\\\"][\\\"id_movimentacao_detalhe\\\"]}} as id_movimentacao_detalhe ,\\n     pg.id, \\n\\tpg.codigo,\\n\\tp.descricao,\\n\\tm.nome as marca,\\n\\tgx.nome as gradex,\\n\\tgy.nome as gradey,\\n\\tcurdate() as data_entrada,\\n  t.largura,\\n\\tcp.composicao\\nFROM\\n\\tpg inner join p on (p.id = pg.id_produto)\\n\\tinner join marca m on(m.id = p.id_marca)\\n\\tleft join grade gx on (gx.id = pg.id_gradex)\\n\\tleft join grade gy on (gy.id = pg.id_gradey)\\n\\tleft join t on (t.token = pg.id)\\n\\tleft join cp on (cp.token = pg.id)\",\n        \"operation\": \"executeQuery\"\n      },\n      \"credentials\": {\n        \"mySql\": {\n          \"id\": \"2\",\n          \"name\": \"illi\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"PegarConfiguracaoImpressao\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        730,\n        1290\n      ],\n      \"parameters\": {\n        \"url\": \"http://localhost:1337/parse/config\",\n        \"options\": {},\n        \"jsonParameters\": true,\n        \"headerParametersJson\": \"{\\\"X-Parse-Application-Id\\\": \\\"iwms\\\"}\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"dadosRolo\",\n      \"type\": \"n8n-nodes-base.postgres\",\n      \"position\": [\n        1260,\n        1220\n      ],\n      \"parameters\": {\n        \"query\": \"=select * from \\\"tecido_rolo\\\"\\nwhere \\\"objectId\\\" in ('{{$json[\\\"idRolos\\\"].join(\\\"','\\\")}}')\",\n        \"operation\": \"executeQuery\",\n        \"additionalFields\": {}\n      },\n      \"credentials\": {\n        \"postgres\": {\n          \"id\": \"1\",\n          \"name\": \"Postgres account\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"trataRetorno\",\n      \"type\": \"n8n-nodes-base.function\",\n      \"position\": [\n        1010,\n        1220\n      ],\n      \"parameters\": {\n        \"functionCode\": \"// Code here will run only once, no matter how many input items there are.\\n// More info and help: https://docs.n8n.io/nodes/n8n-nodes-base.function\\n\\n\\n// var produto = items[0].json;\\n\\n\\nvar rolos = $node[\\\"emitirEtiqueta\\\"].json[\\\"body\\\"][\\\"rolos\\\"];\\n\\n\\nvar idRolos = rolos.map(\\n    function(rolo){\\n        return rolo.objectId\\n    });\\n    \\nvar retorno = [];\\n\\nretorno.push({json:{\\n   // produto:produto,\\n    idRolos:idRolos \\n}})\\n\\nreturn retorno;\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"roloProduto\",\n      \"type\": \"n8n-nodes-base.merge\",\n      \"position\": [\n        1640,\n        1330\n      ],\n      \"parameters\": {\n        \"mode\": \"mergeByKey\",\n        \"propertyName1\": \"id_movimentacao_detalhe\",\n        \"propertyName2\": \"id_movimentacao_detalhe\"\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"connections\": {\n    \"dadosRolo\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"roloProduto\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"dadosProduto\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"roloProduto\",\n            \"type\": \"main\",\n            \"index\": 1\n          }\n        ]\n      ]\n    },\n    \"trataRetorno\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"dadosRolo\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"emitirEtiqueta\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"PegarConfiguracaoImpressao\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"PegarConfiguracaoImpressao\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"dadosProduto\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"trataRetorno\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.webhook",
      "n8n-nodes-base.mySql",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.postgres",
      "n8n-nodes-base.function",
      "n8n-nodes-base.merge"
    ],
    "trigger": null
  }
}