{
  "source": "0178_Functionitem_Executecommand_Automation_Webhook.json",
  "index": 1,
  "content": "{\n  \"id\": \"14\",\n  \"name\": \"extract_swifts\",\n  \"nodes\": [\n    {\n      \"name\": \"On clicking 'execute'\",\n      \"type\": \"n8n-nodes-base.manualTrigger\",\n      \"position\": [\n        -140,\n        820\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"HTTP Request\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        320,\n        820\n      ],\n      \"parameters\": {\n        \"url\": \"https://www.theswiftcodes.com/browse-by-country/\",\n        \"options\": {},\n        \"responseFormat\": \"string\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"HTML Extract\",\n      \"type\": \"n8n-nodes-base.htmlExtract\",\n      \"position\": [\n        510,\n        820\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"extractionValues\": {\n          \"values\": [\n            {\n              \"key\": \"countries\",\n              \"attribute\": \"href\",\n              \"cssSelector\": \"ol > li > a\",\n              \"returnArray\": true,\n              \"returnValue\": \"attribute\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"SplitInBatches\",\n      \"type\": \"n8n-nodes-base.splitInBatches\",\n      \"position\": [\n        910,\n        820\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"reset\": false\n        },\n        \"batchSize\": 1\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"HTTP Request1\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        2250,\n        740\n      ],\n      \"parameters\": {\n        \"url\": \"={{$node[\\\"Set\\\"].json[\\\"url\\\"]}}\",\n        \"options\": {},\n        \"responseFormat\": \"file\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"HTML Extract1\",\n      \"type\": \"n8n-nodes-base.htmlExtract\",\n      \"position\": [\n        2750,\n        590\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"sourceData\": \"binary\",\n        \"extractionValues\": {\n          \"values\": [\n            {\n              \"key\": \"next_button\",\n              \"attribute\": \"href\",\n              \"cssSelector\": \"span.next > a\",\n              \"returnValue\": \"attribute\"\n            },\n            {\n              \"key\": \"names\",\n              \"cssSelector\": \"td.table-name\",\n              \"returnArray\": true\n            },\n            {\n              \"key\": \"swifts\",\n              \"cssSelector\": \"td.table-swift\",\n              \"returnArray\": true\n            },\n            {\n              \"key\": \"cities\",\n              \"cssSelector\": \"td.table-city\",\n              \"returnArray\": true\n            },\n            {\n              \"key\": \"branches\",\n              \"cssSelector\": \"td.table-branch\",\n              \"returnArray\": true\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"MongoDB1\",\n      \"type\": \"n8n-nodes-base.mongoDb\",\n      \"position\": [\n        3280,\n        590\n      ],\n      \"parameters\": {\n        \"fields\": \"iso_code,country,page,name,branch,city,swift_code,createdAt,updatedAt\",\n        \"options\": {\n          \"dateFields\": \"createdAt,updatedAt\"\n        },\n        \"operation\": \"insert\",\n        \"collection\": \"swifts.meetup\"\n      },\n      \"credentials\": {\n        \"mongoDb\": \"db-mongo\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"uProc\",\n      \"type\": \"n8n-nodes-base.uproc\",\n      \"position\": [\n        1100,\n        820\n      ],\n      \"parameters\": {\n        \"tool\": \"getCountryNormalized\",\n        \"group\": \"geographic\",\n        \"country\": \"={{$node[\\\"SplitInBatches\\\"].json[\\\"country\\\"].replace(/[\\\\/0-9]/g, \\\"\\\")}}\",\n        \"additionalOptions\": {}\n      },\n      \"credentials\": {\n        \"uprocApi\": \"uproc-miquel\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Prepare Documents\",\n      \"type\": \"n8n-nodes-base.function\",\n      \"position\": [\n        2930,\n        590\n      ],\n      \"parameters\": {\n        \"functionCode\": \"var newItems = [];\\n\\nfor (i = 0; i < items[0].json.swifts.length; i++) {\\n  var item = {\\n    iso_code: $node['uProc'].json.message.code,\\n    country: $node['SplitInBatches'].json.country.replace(/[-\\\\/0-9]/g, \\\"\\\"),\\n    page: $node['Set Page to Scrape'].json.page,\\n    name: items[0].json.names[i],\\n    city: items[0].json.cities[i],\\n    branch: items[0].json.branches[i],\\n    swift_code: items[0].json.swifts[i],\\n    createdAt: new Date(),\\n    updatedAt: new Date()\\n  }\\n  newItems.push({json: item});\\n}\\n\\nreturn newItems;\\n\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"More Countries\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        2810,\n        1100\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{$node[\\\"SplitInBatches\\\"].context[\\\"noItemsLeft\\\"] + \\\"\\\"}}\",\n              \"value2\": \"true\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Set Page to Scrape\",\n      \"type\": \"n8n-nodes-base.functionItem\",\n      \"position\": [\n        1290,\n        680\n      ],\n      \"parameters\": {\n        \"functionCode\": \"const staticData = getWorkflowStaticData('global');\\n\\nitem.page = \\\"\\\";\\nif (staticData.page && staticData.page.length) {\\n  item.page = staticData.page;\\n} else {\\n  item.page = $node['SplitInBatches'].json.country;\\n}\\nreturn item;\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"More Pages\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        3070,\n        1020\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{$json[\\\"more_pages\\\"] + \\\"\\\"}}\",\n              \"value2\": \"true\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Set More Pages\",\n      \"type\": \"n8n-nodes-base.function\",\n      \"position\": [\n        3470,\n        590\n      ],\n      \"parameters\": {\n        \"functionCode\": \"var next_page = $node['HTML Extract1'].json.next_button && $node['HTML Extract1'].json.next_button.length ? $node['HTML Extract1'].json.next_button : \\\"\\\";\\nvar more_pages = next_page.length > 0;\\nconst staticData = getWorkflowStaticData('global');\\n\\n//all current items are after date: needs pagination\\nif (more_pages) {\\n  staticData.page = next_page;\\n} else {\\n  //don't check more items in previous pages;\\n  delete staticData.page;\\n}\\n\\nreturn [\\n  {\\n    json: {\\n      more_pages: more_pages\\n    }\\n  }\\n];\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Set\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1440,\n        680\n      ],\n      \"parameters\": {\n        \"values\": {\n          \"string\": [\n            {\n              \"name\": \"url\",\n              \"value\": \"=https://www.theswiftcodes.com{{$node[\\\"Set Page to Scrape\\\"].json[\\\"page\\\"]}}\"\n            }\n          ]\n        },\n        \"options\": {}\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Generate filename\",\n      \"type\": \"n8n-nodes-base.functionItem\",\n      \"position\": [\n        1600,\n        610\n      ],\n      \"parameters\": {\n        \"functionCode\": \"var generateNameFromUrl = function(url){\\n    return url.replace(/[^a-z0-9]/gi, \\\"_\\\");\\n}\\n\\nitem.file = generateNameFromUrl(item.url) + \\\".html\\\"\\nreturn item;\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Read Binary File\",\n      \"type\": \"n8n-nodes-base.readBinaryFile\",\n      \"position\": [\n        1770,\n        610\n      ],\n      \"parameters\": {\n        \"filePath\": \"=/home/node/.cache/scrapper/{{$json[\\\"file\\\"]}}\"\n      },\n      \"typeVersion\": 1,\n      \"continueOnFail\": true,\n      \"alwaysOutputData\": true\n    },\n    {\n      \"name\": \"File exists?\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        1950,\n        610\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{$node[\\\"Read Binary File\\\"].binary.data.mimeType}}\",\n              \"value2\": \"text/html\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Write Binary File\",\n      \"type\": \"n8n-nodes-base.writeBinaryFile\",\n      \"position\": [\n        2400,\n        740\n      ],\n      \"parameters\": {\n        \"fileName\": \"=/home/node/.cache/scrapper/{{$node[\\\"Generate filename\\\"].json[\\\"file\\\"]}}\",\n        \"dataPropertyName\": \"=data\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Read Binary File1\",\n      \"type\": \"n8n-nodes-base.readBinaryFile\",\n      \"position\": [\n        2570,\n        590\n      ],\n      \"parameters\": {\n        \"filePath\": \"=/home/node/.cache/scrapper/{{$json[\\\"file\\\"]}}\"\n      },\n      \"typeVersion\": 1,\n      \"continueOnFail\": true,\n      \"alwaysOutputData\": true\n    },\n    {\n      \"name\": \"Wait\",\n      \"type\": \"n8n-nodes-base.function\",\n      \"position\": [\n        2090,\n        740\n      ],\n      \"parameters\": {\n        \"functionCode\": \"const waitTimeSeconds = 1;\\n\\nreturn new Promise((resolve) => {\\n  setTimeout(() => {\\n    resolve([]);\\n  }, waitTimeSeconds * 1000);\\n});\\n\"\n      },\n      \"typeVersion\": 1,\n      \"continueOnFail\": true,\n      \"alwaysOutputData\": true\n    },\n    {\n      \"name\": \"Prepare countries\",\n      \"type\": \"n8n-nodes-base.function\",\n      \"position\": [\n        700,\n        820\n      ],\n      \"parameters\": {\n        \"functionCode\": \"return items[0].json.countries.map(function(country) {\\n  return {\\n  json: {country: country}\\n  }\\n});\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Create Directory\",\n      \"type\": \"n8n-nodes-base.executeCommand\",\n      \"position\": [\n        70,\n        820\n      ],\n      \"parameters\": {\n        \"command\": \"mkdir -p  /home/node/.cache/scrapper/\"\n      },\n      \"typeVersion\": 1,\n      \"continueOnFail\": true\n    },\n    {\n      \"name\": \"MongoDB\",\n      \"type\": \"n8n-nodes-base.mongoDb\",\n      \"disabled\": true,\n      \"position\": [\n        3100,\n        520\n      ],\n      \"parameters\": {\n        \"query\": \"={\\\"swift_code\\\": \\\"{{$json[\\\"swift_code\\\"]}}\\\"}\",\n        \"options\": {},\n        \"collection\": \"swifts.meetup\"\n      },\n      \"credentials\": {\n        \"mongoDb\": \"db-mongo\"\n      },\n      \"executeOnce\": false,\n      \"typeVersion\": 1,\n      \"alwaysOutputData\": true\n    }\n  ],\n  \"active\": false,\n  \"settings\": {},\n  \"connections\": {\n    \"Set\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Generate filename\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Wait\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"HTTP Request1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"uProc\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Set Page to Scrape\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"MongoDB\": {\n      \"main\": [\n        []\n      ]\n    },\n    \"MongoDB1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Set More Pages\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"More Pages\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Set Page to Scrape\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"More Countries\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"File exists?\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Read Binary File1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Wait\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"HTML Extract\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Prepare countries\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"HTTP Request\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"HTML Extract\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"HTML Extract1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Prepare Documents\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"HTTP Request1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Write Binary File\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"More Countries\": {\n      \"main\": [\n        [],\n        [\n          {\n            \"node\": \"SplitInBatches\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Set More Pages\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"More Pages\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"SplitInBatches\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"uProc\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Create Directory\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"HTTP Request\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Read Binary File\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"File exists?\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Generate filename\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Read Binary File\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Prepare Documents\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"MongoDB1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Prepare countries\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"SplitInBatches\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Read Binary File1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"HTML Extract1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Write Binary File\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Read Binary File1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Set Page to Scrape\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Set\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"On clicking 'execute'\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Create Directory\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.manualTrigger",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.htmlExtract",
      "n8n-nodes-base.splitInBatches",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.htmlExtract",
      "n8n-nodes-base.mongoDb",
      "n8n-nodes-base.uproc",
      "n8n-nodes-base.function",
      "n8n-nodes-base.if",
      "n8n-nodes-base.functionItem",
      "n8n-nodes-base.if",
      "n8n-nodes-base.function",
      "n8n-nodes-base.set",
      "n8n-nodes-base.functionItem",
      "n8n-nodes-base.readBinaryFile",
      "n8n-nodes-base.if",
      "n8n-nodes-base.writeBinaryFile",
      "n8n-nodes-base.readBinaryFile",
      "n8n-nodes-base.function",
      "n8n-nodes-base.function",
      "n8n-nodes-base.executeCommand",
      "n8n-nodes-base.mongoDb"
    ],
    "trigger": null
  }
}