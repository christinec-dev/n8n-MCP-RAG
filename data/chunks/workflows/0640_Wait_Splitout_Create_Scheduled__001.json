{
  "source": "0640_Wait_Splitout_Create_Scheduled.json",
  "index": 1,
  "content": "{\n  \"nodes\": [\n    {\n      \"id\": \"6aa059e4-e78f-4bbd-a707-994a39840f97\",\n      \"name\": \"Create Session\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        -520,\n        240\n      ],\n      \"parameters\": {\n        \"url\": \"https://bsky.social/xrpc/com.atproto.server.createSession\",\n        \"method\": \"POST\",\n        \"options\": {},\n        \"sendBody\": true,\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"identifier\",\n              \"value\": \"youruser.bsky.social\"\n            },\n            {\n              \"name\": \"password\",\n              \"value\": \"your-app-passord-here\"\n            }\n          ]\n        }\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 4.1\n    },\n    {\n      \"id\": \"143e37b0-de79-4329-99a2-51484c9609a8\",\n      \"name\": \"List followers\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        -280,\n        240\n      ],\n      \"parameters\": {\n        \"url\": \"https://bsky.social/xrpc/app.bsky.graph.getFollowers\",\n        \"options\": {\n          \"response\": {\n            \"response\": {\n              \"responseFormat\": \"json\"\n            }\n          },\n          \"pagination\": {\n            \"pagination\": {\n              \"parameters\": {\n                \"parameters\": [\n                  {\n                    \"name\": \"cursor\",\n                    \"value\": \"={{ $response.body.cursor }}\"\n                  }\n                ]\n              },\n              \"maxRequests\": 2,\n              \"requestInterval\": 250,\n              \"limitPagesFetched\": true\n            }\n          }\n        },\n        \"sendQuery\": true,\n        \"sendHeaders\": true,\n        \"queryParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"actor\",\n              \"value\": \"={{ $json.did }}\"\n            },\n            {\n              \"name\": \"limit\",\n              \"value\": \"100\"\n            }\n          ]\n        },\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Authorization\",\n              \"value\": \"=Bearer {{ $item(\\\"0\\\").$node[\\\"Create Session\\\"].json[\\\"accessJwt\\\"] }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"f1436a63-a23f-4082-9209-12c21a26ad91\",\n      \"name\": \"Convert to File\",\n      \"type\": \"n8n-nodes-base.convertToFile\",\n      \"position\": [\n        100,\n        620\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"fileName\": \"followers-basuracero.json\"\n        },\n        \"operation\": \"toJson\"\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"f8beea47-6f36-4dfb-b2e7-bf94adb63e66\",\n      \"name\": \"Extract from File\",\n      \"type\": \"n8n-nodes-base.extractFromFile\",\n      \"position\": [\n        100,\n        240\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"operation\": \"fromJson\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"41658372-3054-4909-850b-3bffd1b1b79c\",\n      \"name\": \"Split Out\",\n      \"type\": \"n8n-nodes-base.splitOut\",\n      \"position\": [\n        520,\n        240\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"destinationFieldName\": \"did\"\n        },\n        \"fieldToSplitOut\": \"newDids\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"c94aa8e9-06db-4b24-a20a-5615b7129023\",\n      \"name\": \"Loop Over Items\",\n      \"type\": \"n8n-nodes-base.splitInBatches\",\n      \"position\": [\n        740,\n        240\n      ],\n      \"parameters\": {\n        \"options\": {}\n      },\n      \"typeVersion\": 3\n    },\n    {\n      \"id\": \"4d1c6a2f-3acd-4783-96d4-693ced06fd97\",\n      \"name\": \"Wait\",\n      \"type\": \"n8n-nodes-base.wait\",\n      \"position\": [\n        -100,\n        620\n      ],\n      \"webhookId\": \"b1608475-db84-4f23-acd6-d003f5094afd\",\n      \"parameters\": {},\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"e4125cb8-8eb5-4cf0-b00d-e7ce4ec8236e\",\n      \"name\": \"Find new followers\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        280,\n        240\n      ],\n      \"parameters\": {\n        \"jsCode\": \"// Datos de entrada\\nconst listFollowers = $('List followers').all()[0].json.followers;\\nconst extractFromFile = $('Extract from File').all()[0].json.data[0].followers;\\n\\n// Verificar que tenemos acceso a los datos\\nconsole.log('listFollowers length:', Array.isArray(listFollowers) ? listFollowers.length : 'no es array');\\nconsole.log('extractFromFile length:', Array.isArray(extractFromFile) ? extractFromFile.length : 'no es array');\\n\\n// Mostrar algunos ejemplos de cada lista\\nconsole.log('Ejemplo de listFollowers:', listFollowers?.slice(0, 2));\\nconsole.log('Ejemplo de extractFromFile:', extractFromFile?.slice(0, 2));\\n\\n// Crear conjunto de DIDs del archivo extraÃ­do\\nconst existingDids = new Set(extractFromFile?.map(item => item.did) || []);\\nconsole.log('DIDs existentes:', Array.from(existingDids).slice(0, 5));\\n\\n// Filtrar listFollowers\\nconst newFollowers = listFollowers?.filter(follower => !existingDids.has(follower.did)) || [];\\n\\nreturn {\\n  json: {\\n    debug: {\\n      listFollowersCount: listFollowers?.length || 0,\\n      extractFromFileCount: extractFromFile?.length || 0,\\n      existingDidsCount: existingDids.size,\\n      newFollowersCount: newFollowers.length\\n    },\\n    newFollowers,\\n    newDids: newFollowers.map(follower => follower.did),\\n    count: newFollowers.length\\n  }\\n}\"\n      },\n      \"typeVersion\": 2,\n      \"alwaysOutputData\": true\n    },\n    {\n      \"id\": \"a28accb5-ee47-431f-83e4-376425e9899e\",\n      \"name\": \"Read followers from file\",\n      \"type\": \"n8n-nodes-base.readWriteFile\",\n      \"position\": [\n        -80,\n        240\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"fileSelector\": \"=followers-{{ $('Create Session').item.json.handle }}.json\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"aa2ab5e1-eb6f-4657-9a9a-66417ffa421e\",\n      \"name\": \"Save followers to file\",\n      \"type\": \"n8n-nodes-base.readWriteFile\",\n      \"position\": [\n        280,\n        620\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"append\": false\n        },\n        \"fileName\": \"=followers-{{ $('Create Session').item.json.handle }}.json\",\n        \"operation\": \"write\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"9a4fb5e5-f2f6-4aa1-846e-8d6460ad7765\",\n      \"name\": \"Define welcome message\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        980,\n        260\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"afe7fe9b-3bd4-4429-afe9-81e5fe934e07\",\n              \"name\": \"text\",\n              \"type\": \"string\",\n              \"value\": \"Hello, thanks for your follow. You can read more about my over my site:\"\n            },\n            {\n              \"id\": \"97590cd1-9d85-442b-baa3-bad849ff9be0\",\n              \"name\": \"link\",\n              \"type\": \"string\",\n              \"value\": \"https://yoursite.com\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"594ce66f-acbd-4c31-806c-382aa9a98ed0\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        920,\n        160\n      ],\n      \"parameters\": {\n        \"width\": 230,\n        \"height\": 266,\n        \"content\": \"### 2. Define your welcome message and link here\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"c24a7971-11a7-4164-9f2d-78335264f250\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        220,\n        460\n      ],\n      \"parameters\": {\n        \"width\": 231,\n        \"height\": 338,\n        \"content\": \"### 3. **Important** \\n\\nYou need to manually run \\\"Save followers to file\\\" once before the first time so you populate your list of existing followers\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"c6e766cf-a118-4db0-8e3c-32662c40737b\",\n      \"name\": \"Send message\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1360,\n        260\n      ],\n      \"parameters\": {\n        \"url\": \"={{ $item(\\\"0\\\").$node[\\\"Create Session\\\"].json.didDoc.service[0].serviceEndpoint }}/xrpc/chat.bsky.convo.sendMessage\",\n        \"method\": \"POST\",\n        \"options\": {},\n        \"jsonBody\": \"={\\n  \\\"convoId\\\" : \\\"{{ $json.convo.id }}\\\",\\n  \\\"message\\\" : {\\n    \\\"text\\\" : \\\"{{ $('Define welcome message').item.json.text }}\\\\n\\\\n{{ $('Define welcome message').item.json.link }}\\\",\\n    \\\"facets\\\" : [\\n     {\\n      \\\"index\\\" : {\\n        \\\"byteStart\\\": {{ $('Define welcome message').item.json.text.length }},\\n        \\\"byteEnd\\\": {{ $('Define welcome message').item.json.text.length + 3 + $('Define welcome message').item.json.link.length}}\\n      },\\n      \\\"features\\\": [\\n          {\\n            \\\"$type\\\": \\\"app.bsky.richtext.facet#link\\\",\\n            \\\"uri\\\": \\\"{{ $('Define welcome message').item.json.link }}\\\"\\n          }\\n        ]\\n      }\\n    ]\\n  }\\n}\",\n        \"sendBody\": true,\n        \"sendHeaders\": true,\n        \"specifyBody\": \"json\",\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Authorization\",\n              \"value\": \"=Bearer {{ $item(\\\"0\\\").$node[\\\"Create Session\\\"].json[\\\"accessJwt\\\"] }}\"\n            },\n            {\n              \"name\": \"Atproto-Proxy\",\n              \"value\": \"did:web:api.bsky.chat#bsky_chat\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"33aa7e0c-58fe-4527-a94e-49bec0e06325\",\n      \"name\": \"Get conversation ID\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1200,\n        260\n      ],\n      \"parameters\": {\n        \"url\": \"={{ $item(\\\"0\\\").$node[\\\"Create Session\\\"].json.didDoc.service[0].serviceEndpoint }}/xrpc/chat.bsky.convo.getConvoForMembers\",\n        \"options\": {},\n        \"sendQuery\": true,\n        \"sendHeaders\": true,\n        \"queryParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"members\",\n              \"value\": \"={{ $('Split Out').item.json.did }}\"\n            }\n          ]\n        },\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Authorization\",\n              \"value\": \"=Bearer {{ $item(\\\"0\\\").$node[\\\"Create Session\\\"].json[\\\"accessJwt\\\"] }}\"\n            },\n            {\n              \"name\": \"Atproto-Proxy\",\n              \"value\": \"did:web:api.bsky.chat#bsky_chat\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"066f1d0d-319a-4676-9c0a-5b00d206ffd2\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -40,\n        -100\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 479,\n        \"height\": 307,\n        \"content\": \"## Send a welcome private message to your new BlueSky followers\\n\\nThis flow will save your current followers in a file and check for new ones on the next execution, sending them the Defined message an link as a private message.\\n\\nOnce messages are sent, the new list of followers will be saved into the file.\\n\\n**Important: Follow the yellow notes in order before enabling the full flow for the first time**\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"a61e301e-a0ca-48e9-9a46-05975662aa90\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -560,\n        40\n      ],\n      \"parameters\": {\n        \"width\": 181,\n        \"height\": 364,\n        \"content\": \"### 1. Define your Bluesky user and app password first\\n\\nThe App password should have access to private messages\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"1b1dcd74-7a71-49e4-99e8-c079b692aca5\",\n      \"name\": \"Each 60 minutes\",\n      \"type\": \"n8n-nodes-base.scheduleTrigger\",\n      \"position\": [\n        -720,\n        240\n      ],\n      \"parameters\": {\n        \"rule\": {\n          \"interval\": [\n            {\n              \"field\": \"minutes\",\n              \"minutesInterval\": 60\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"6acf153c-cdc6-42c1-85f9-2692c8777eef\",\n      \"name\": \"No Operation, do nothing\",\n      \"type\": \"n8n-nodes-base.noOp\",\n      \"position\": [\n        520,\n        620\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    }\n  ],\n  \"pinData\": {},\n  \"connections\": {\n    \"Wait\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Convert to File\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Split Out\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Loop Over Items\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Send message\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Loop Over Items\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Create Session\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"List followers\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"List followers\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Read followers from file\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Wait\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Convert to File\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Save followers to file\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Each 60 minutes\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Create Session\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Loop Over Items\": {\n      \"main\": [\n        [],\n        [\n          {\n            \"node\": \"Define welcome message\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Extract from File\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Find new followers\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Find new followers\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Split Out\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get conversation ID\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Send message\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Define welcome message\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get conversation ID\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Save followers to file\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"No Operation, do nothing\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Read followers from file\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract from File\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.convertToFile",
      "n8n-nodes-base.extractFromFile",
      "n8n-nodes-base.splitOut",
      "n8n-nodes-base.splitInBatches",
      "n8n-nodes-base.wait",
      "n8n-nodes-base.code",
      "n8n-nodes-base.readWriteFile",
      "n8n-nodes-base.readWriteFile",
      "n8n-nodes-base.set",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.scheduleTrigger",
      "n8n-nodes-base.noOp"
    ],
    "trigger": null
  }
}