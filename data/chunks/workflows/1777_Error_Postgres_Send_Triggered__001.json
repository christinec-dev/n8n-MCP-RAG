{
  "source": "1777_Error_Postgres_Send_Triggered.json",
  "index": 1,
  "content": "{\n  \"id\": \"YybYYc430rmZWJPJ\",\n  \"meta\": {\n    \"instanceId\": \"febfa0961d1e55a48938f0337f348b73a50538aa16673607611ead85d95f662c\",\n    \"templateCredsSetupCompleted\": true\n  },\n  \"name\": \"Log errors and avoid sending too many emails\",\n  \"tags\": [\n    {\n      \"id\": \"7YoU4oTsaGGEtWJj\",\n      \"name\": \"sample\",\n      \"createdAt\": \"2025-01-31T16:41:27.407Z\",\n      \"updatedAt\": \"2025-01-31T16:41:27.407Z\"\n    }\n  ],\n  \"nodes\": [\n    {\n      \"id\": \"0e44df4c-00d2-4545-89ae-844a590de369\",\n      \"name\": \"Error Trigger\",\n      \"type\": \"n8n-nodes-base.errorTrigger\",\n      \"position\": [\n        -1200,\n        90\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"7101542a-5146-4917-a1f2-13686cad197e\",\n      \"name\": \"Insert Log\",\n      \"type\": \"n8n-nodes-base.postgres\",\n      \"position\": [\n        -980,\n        40\n      ],\n      \"parameters\": {\n        \"table\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"N8Err\",\n          \"cachedResultName\": \"N8Err\"\n        },\n        \"schema\": {\n          \"__rl\": true,\n          \"mode\": \"name\",\n          \"value\": \"p1gq6ljdsam3x1m\"\n        },\n        \"columns\": {\n          \"value\": {\n            \"URL\": \"={{ $json.execution.url }}\",\n            \"json\": \"={{ JSON.stringify($json) }}\",\n            \"Stack\": \"={{ $json.execution.error.stack }}\",\n            \"title\": \"={{ $json.workflow.name }}\",\n            \"Message\": \"={{ $json.execution.error.message }}\",\n            \"LastNode\": \"={{ $json.execution.lastNodeExecuted }}\",\n            \"created_at\": \"={{ $now }}\"\n          },\n          \"schema\": [\n            {\n              \"id\": \"id\",\n              \"type\": \"number\",\n              \"display\": true,\n              \"removed\": true,\n              \"required\": false,\n              \"displayName\": \"id\",\n              \"defaultMatch\": true,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"created_at\",\n              \"type\": \"dateTime\",\n              \"display\": true,\n              \"required\": false,\n              \"displayName\": \"created_at\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"updated_at\",\n              \"type\": \"dateTime\",\n              \"display\": true,\n              \"removed\": true,\n              \"required\": false,\n              \"displayName\": \"updated_at\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"created_by\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": true,\n              \"required\": false,\n              \"displayName\": \"created_by\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"updated_by\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": true,\n              \"required\": false,\n              \"displayName\": \"updated_by\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"nc_order\",\n              \"type\": \"number\",\n              \"display\": true,\n              \"removed\": true,\n              \"required\": false,\n              \"displayName\": \"nc_order\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"title\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"required\": false,\n              \"displayName\": \"title\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"URL\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"required\": false,\n              \"displayName\": \"URL\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"Stack\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"required\": false,\n              \"displayName\": \"Stack\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"json\",\n              \"type\": \"object\",\n              \"display\": true,\n              \"required\": false,\n              \"displayName\": \"json\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"Message\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"required\": false,\n              \"displayName\": \"Message\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"LastNode\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"required\": false,\n              \"displayName\": \"LastNode\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            }\n          ],\n          \"mappingMode\": \"defineBelow\",\n          \"matchingColumns\": [\n            \"id\"\n          ],\n          \"attemptToConvertTypes\": false,\n          \"convertFieldsToString\": false\n        },\n        \"options\": {}\n      },\n      \"credentials\": {\n        \"postgres\": {\n          \"id\": \"2VsRB7eDnG0FA3z2\",\n          \"name\": \"Postgres Nocodb\"\n        }\n      },\n      \"typeVersion\": 2.6\n    },\n    {\n      \"id\": \"8fb1201c-353e-466c-8d08-fd969e6b10b1\",\n      \"name\": \"Count for 5 minutes\",\n      \"type\": \"n8n-nodes-base.postgres\",\n      \"position\": [\n        -980,\n        -210\n      ],\n      \"parameters\": {\n        \"query\": \"SELECT count(*) FROM p1gq6ljdsam3x1m.\\\"N8Err\\\" where created_at >= $1;\\n\",\n        \"options\": {\n          \"queryReplacement\": \"={{ $now.minus(5, 'minutes').toString() }}\"\n        },\n        \"operation\": \"executeQuery\"\n      },\n      \"credentials\": {\n        \"postgres\": {\n          \"id\": \"2VsRB7eDnG0FA3z2\",\n          \"name\": \"Postgres Nocodb\"\n        }\n      },\n      \"typeVersion\": 2.6\n    },\n    {\n      \"id\": \"89f836dc-8141-4c20-a758-bf7ff261a87b\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -2260,\n        -300\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 820,\n        \"height\": 1140,\n        \"content\": \"# Log errors and avoid sending too many emails\\n\\n## Use case\\n\\nMost of the time, it’s necessary to log all errors that occur. However, in some cases, a scheduled task or service consuming excessive resources might trigger a surge of errors.\\n\\nTo address this, we can log all errors but limit alerts to a maximum of one notification every 5 minutes.\\n\\n## What this workflow does\\n\\nThis workflow can be configured to receive error events, or you can integrate it **before your own error-handling logic.**  \\n\\nIf used as the **primary error handler**, note that this flow will **only add a database log entry** and take no further action. You’ll need to add your own alerts (e.g., email or push notifications). Below is an example of a notification setup I prefer to use.  \\n\\nAt the end, there’s an **error cleanup** option. This feature is particularly useful in development environments.  \\n\\nIf you already have an error-handling workflow, you can call this one as a **sub-workflow**. Its final steps include cleanup logic to reset the execution state and terminate the workflow.\\n\\n## Setup\\n\\n**Verify all Postgres nodes and credentials when using the 'Error Handling Sample'**\\n\\n## How to adjust it to your needs\\n\\n1) You can set this workflow as a sub-workflow within your existing error-handling setup.\\n\\n2) Alternatively, you can add the \\\"Error Handling Sample\\\" at the end of this workflow, which sends email and push notifications.\\n\\nConfiguration Requirements:\\n\\n⚠️ You must create a database table for this to work!\\n\\n\\n\\nDDL of this sample:\\n\\ncreate table p1gq6ljdsam3x1m.\\\"N8Err\\\"\\n(\\n    id         serial\\n        primary key,\\n    created_at timestamp,\\n    updated_at timestamp,\\n    created_by varchar,\\n    updated_by varchar,\\n    nc_order   numeric,\\n    title      text,\\n    \\\"URL\\\"      text,\\n    \\\"Stack\\\"    text,\\n    json       json,\\n    \\\"Message\\\"  text,\\n    \\\"LastNode\\\" text\\n);\\n\\nalter table p1gq6ljdsam3x1m.\\\"N8Err\\\"\\n    owner to postgres;\\n\\ncreate index \\\"N8Err_order_idx\\\"\\n    on p1gq6ljdsam3x1m.\\\"N8Err\\\" (nc_order);\\n\\nby Davi Saranszky Mesquita\\nhttps://www.linkedin.com/in/mesquitadavi/\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"fba7fec5-5285-46bd-9cc7-270b7dcc8c5f\",\n      \"name\": \"Principal E-Mail\",\n      \"type\": \"n8n-nodes-base.emailSend\",\n      \"onError\": \"continueErrorOutput\",\n      \"disabled\": true,\n      \"position\": [\n        -980,\n        350\n      ],\n      \"webhookId\": \"d76d2e82-b0a8-4e35-88f9-1815d4ce6c79\",\n      \"parameters\": {\n        \"text\": \"={{ $(\\\"Error Trigger\\\").item.json.execution.url }}\\n\\n{{ $(\\\"Error Trigger\\\").item.json.execution.lastNodeExecuted }}\\n\\n{{ $(\\\"Error Trigger\\\").item.json.execution.error.message }}\\n{{ $(\\\"Error Trigger\\\").item.json.execution.error.stack }}\",\n        \"options\": {\n          \"appendAttribution\": false\n        },\n        \"subject\": \"=Erro -  {{ $(\\\"Error Trigger\\\").item.json.workflow.name }}\",\n        \"toEmail\": \"davimesquita@gmail.com\",\n        \"fromEmail\": \"suporte@ideias.casa\",\n        \"emailFormat\": \"text\"\n      },\n      \"credentials\": {\n        \"smtp\": {\n          \"id\": \"0YIoKeISQNR2kxwO\",\n          \"name\": \"SMTP Resent\"\n        }\n      },\n      \"typeVersion\": 2.1\n    },\n    {\n      \"id\": \"979d0e82-42e8-450a-95b1-3c204ad61a50\",\n      \"name\": \"Fallback E-Mail\",\n      \"type\": \"n8n-nodes-base.emailSend\",\n      \"disabled\": true,\n      \"position\": [\n        -760,\n        350\n      ],\n      \"webhookId\": \"d76d2e82-b0a8-4e35-88f9-1815d4ce6c79\",\n      \"parameters\": {\n        \"text\": \"={{ $(\\\"Error Trigger\\\").item.json.execution.url }}\\n\\n{{ $(\\\"Error Trigger\\\").item.json.execution.lastNodeExecuted }}\\n\\n{{ $(\\\"Error Trigger\\\").item.json.execution.error.message }}\\n{{ $(\\\"Error Trigger\\\").item.json.execution.error.stack }}\",\n        \"options\": {\n          \"appendAttribution\": false\n        },\n        \"subject\": \"=Erro -  {{ $(\\\"Error Trigger\\\").item.json.workflow.name }}\",\n        \"toEmail\": \"davimesquita@gmail.com\",\n        \"fromEmail\": \"contato@ideias.casa\",\n        \"emailFormat\": \"text\"\n      },\n      \"credentials\": {\n        \"smtp\": {\n          \"id\": \"UvWloRL7Jyqt8tm9\",\n          \"name\": \"SMTP Contato\"\n        }\n      },\n      \"typeVersion\": 2.1\n    },\n    {\n      \"id\": \"6c073c03-e00e-45b1-8f14-faa29fd58472\",\n      \"name\": \"Push mobile notification\",\n      \"type\": \"n8n-nodes-base.pushover\",\n      \"disabled\": true,\n      \"position\": [\n        -980,\n        550\n      ],\n      \"parameters\": {\n        \"message\": \"={{ $(\\\"Error Trigger\\\").item.json.workflow.name }} - {{ $(\\\"Error Trigger\\\").item.json.execution.url }}\\n\\n{{ $(\\\"Error Trigger\\\").item.json.execution.lastNodeExecuted }}\\n\\n{{ $(\\\"Error Trigger\\\").item.json.execution.error.message }}\\n{{ $(\\\"Error Trigger\\\").item.json.execution.error.stack }}\",\n        \"userKey\": \"=u4RMqXQR9EFdeSQBfaL1riBy1Qd953\",\n        \"additionalFields\": {}\n      },\n      \"credentials\": {\n        \"pushoverApi\": {\n          \"id\": \"ae8Jsj87n2hSWDbs\",\n          \"name\": \"Pushover account\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"4ca939e4-dcb1-40bd-b5eb-4cd00cb403fb\",\n      \"name\": \"Truncate Log Database\",\n      \"type\": \"n8n-nodes-base.postgres\",\n      \"position\": [\n        -980,\n        810\n      ],\n      \"parameters\": {\n        \"table\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"N8Err\",\n          \"cachedResultName\": \"N8Err\"\n        },\n        \"schema\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"p1gq6ljdsam3x1m\",\n          \"cachedResultName\": \"p1gq6ljdsam3x1m\"\n        },\n        \"options\": {},\n        \"operation\": \"deleteTable\",\n        \"restartSequences\": true\n      },\n      \"credentials\": {\n        \"postgres\": {\n          \"id\": \"2VsRB7eDnG0FA3z2\",\n          \"name\": \"Postgres Nocodb\"\n        }\n      },\n      \"typeVersion\": 2.6\n    },\n    {\n      \"id\": \"1eaf67ca-fb77-4b76-8ee3-ae65d4b79182\",\n      \"name\": \"Sometimes... just cleanup\",\n      \"type\": \"n8n-nodes-base.manualTrigger\",\n      \"position\": [\n        -1200,\n        810\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"01e5a7dd-41a2-43f1-bbf5-241e6791cf18\",\n      \"name\": \"Call this Sample - Prepend to your error catcher\",\n      \"type\": \"n8n-nodes-base.executeWorkflow\",\n      \"disabled\": true,\n      \"position\": [\n        -1200,\n        450\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"workflowId\": {\n          \"__rl\": true,\n          \"mode\": \"id\",\n          \"value\": \"\"\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"4386788d-5f10-468a-8a02-cff45a4a7ed5\",\n      \"name\": \"See below to prepend this at your error handling\",\n      \"type\": \"n8n-nodes-base.executeWorkflowTrigger\",\n      \"position\": [\n        -1200,\n        -260\n      ],\n      \"parameters\": {\n        \"inputSource\": \"passthrough\"\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"d6aed974-4a36-4edd-809d-867a95d0f6ef\",\n      \"name\": \"If there is no logs in 5 minutes\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        -760,\n        -210\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"version\": 2,\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"loose\"\n          },\n          \"combinator\": \"and\",\n          \"conditions\": [\n            {\n              \"id\": \"a17b915d-f581-4774-a78a-48bc386aebc9\",\n              \"operator\": {\n                \"type\": \"number\",\n                \"operation\": \"lte\"\n              },\n              \"leftValue\": \"={{ $json.count }}\",\n              \"rightValue\": 0\n            }\n          ]\n        },\n        \"looseTypeValidation\": true\n      },\n      \"typeVersion\": 2.2\n    },\n    {\n      \"id\": \"3c49f611-f1a6-409a-a4c6-903dadb27165\",\n      \"name\": \"CleanUp execution. See below if you will prepend this workflow\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        -540,\n        -10\n      ],\n      \"parameters\": {\n        \"jsCode\": \"return [];\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"192443fc-c032-4815-acc7-c8cf6040cc34\",\n      \"name\": \"Insert your error handling logic after this\",\n      \"type\": \"n8n-nodes-base.noOp\",\n      \"position\": [\n        -540,\n        -260\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"2f87907f-816f-4054-8517-bb713a203131\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -1350,\n        250\n      ],\n      \"parameters\": {\n        \"width\": 840,\n        \"height\": 460,\n        \"content\": \"# Error handling sample\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b173898f-d1d8-4f83-b7b7-ba52cab7651e\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -1610,\n        630\n      ],\n      \"parameters\": {\n        \"width\": 1140,\n        \"height\": 340,\n        \"content\": \"# Database Cleanup: Useful in DEV, but DO NOT run in production\"\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"active\": false,\n  \"pinData\": {\n    \"Error Trigger\": [\n      {\n        \"json\": {\n          \"workflow\": {\n            \"id\": \"1\",\n            \"name\": \"Example Workflow\"\n          },\n          \"execution\": {\n            \"id\": 231,\n            \"url\": \"https://work.ideias.casa/execution/workflow/1/231\",\n            \"mode\": \"manual\",\n            \"error\": {\n              \"stack\": \"Stacktrace\",\n              \"message\": \"Example Error Message\"\n            },\n            \"retryOf\": \"34\",\n            \"lastNodeExecuted\": \"Node With Error\"\n          }\n        }\n      }\n    ]\n  },\n  \"settings\": {\n    \"callerPolicy\": \"workflowsFromSameOwner\",\n    \"executionOrder\": \"v1\",\n    \"saveManualExecutions\": false,\n    \"saveExecutionProgress\": false,\n    \"saveDataErrorExecution\": \"all\",\n    \"saveDataSuccessExecution\": \"none\"\n  },\n  \"versionId\": \"07c6795a-f906-4e22-a15a-4f1984e540a3\",\n  \"connections\": {\n    \"Insert Log\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"CleanUp execution. See below if you will prepend this workflow\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Error Trigger\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Insert Log\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Count for 5 minutes\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Principal E-Mail\": {\n      \"main\": [\n        [],\n        [\n          {\n            \"node\": \"Fallback E-Mail\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Count for 5 minutes\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"If there is no logs in 5 minutes\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Sometimes... just cleanup\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Truncate Log Database\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"If there is no logs in 5 minutes\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Insert your error handling logic after this\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"CleanUp execution. See below if you will prepend this workflow\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Call this Sample - Prepend to your error catcher\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Principal E-Mail\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Push mobile notification\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"See below to prepend this at your error handling\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Insert Log\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Count for 5 minutes\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"CleanUp execution. See below if you will prepend this workflow\": {\n      \"main\": [\n        []\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.errorTrigger",
      "n8n-nodes-base.postgres",
      "n8n-nodes-base.postgres",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.emailSend",
      "n8n-nodes-base.emailSend",
      "n8n-nodes-base.pushover",
      "n8n-nodes-base.postgres",
      "n8n-nodes-base.manualTrigger",
      "n8n-nodes-base.executeWorkflow",
      "n8n-nodes-base.executeWorkflowTrigger",
      "n8n-nodes-base.if",
      "n8n-nodes-base.code",
      "n8n-nodes-base.noOp",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote"
    ],
    "trigger": "error trigger"
  }
}