{
  "source": "1157_Functionitem_Executecommand_Update_Webhook.json",
  "index": 1,
  "content": "{\n  \"nodes\": [\n    {\n      \"name\": \"HTML Extract\",\n      \"type\": \"n8n-nodes-base.htmlExtract\",\n      \"position\": [\n        -220,\n        -390\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"extractionValues\": {\n          \"values\": [\n            {\n              \"key\": \"price\",\n              \"cssSelector\": \"={{$node[\\\"initItem\\\"].json[\\\"selector\\\"]}}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Cron\",\n      \"type\": \"n8n-nodes-base.cron\",\n      \"position\": [\n        -1290,\n        -390\n      ],\n      \"parameters\": {\n        \"triggerTimes\": {\n          \"item\": [\n            {\n              \"mode\": \"everyX\",\n              \"unit\": \"minutes\",\n              \"value\": 15\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"getActualPrice\",\n      \"type\": \"n8n-nodes-base.functionItem\",\n      \"position\": [\n        -20,\n        -390\n      ],\n      \"parameters\": {\n        \"functionCode\": \"const globalData = getWorkflowStaticData('global');\\n\\nvar price = String(item.price).replace(\\\",\\\", \\\".\\\");\\nprice = parseFloat(price);\\n//price = price.replace(/\\\\D/g, '');\\n//item.price = String(item.price).replace(\\\",\\\", \\\".\\\");\\n//item.price = parseFloat(item.price);\\n\\nitem.priceExists = (price > 0 ? true : false)\\nitem.price = price;\\n\\n// Update its data\\nglobalData.actualPrice = item;\\n\\nreturn item;\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"fetchWeb\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        -410,\n        -390\n      ],\n      \"parameters\": {\n        \"url\": \"={{$node[\\\"initItem\\\"].json[\\\"link\\\"]}}\",\n        \"options\": {},\n        \"responseFormat\": \"string\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"FunctionItem\",\n      \"type\": \"n8n-nodes-base.functionItem\",\n      \"position\": [\n        1020,\n        -390\n      ],\n      \"parameters\": {\n        \"functionCode\": \"const globalData = getWorkflowStaticData('global');\\n\\nglobalData.iteration = 0;\\n//var thiselem = $node[\\\"initItem\\\"].json;\\n\\n//const s1 = {'slug': thiselem.slug, \\\"link\\\": thiselem.link, \\\"selector\\\": thiselem.selector, \\\"price\\\":$node[\\\"getActualPrice\\\"].json.price, \\\"currency\\\": thiselem.currency};\\n//const s2 = {'slug': thiselem.slug+'2', \\\"link\\\": thiselem.link, \\\"selector\\\": thiselem.selector, \\\"price\\\":$node[\\\"getActualPrice\\\"].json.price, \\\"currency\\\": thiselem.currency};\\n//const s3 = {'slug': thiselem.slug+'3', \\\"link\\\": thiselem.link, \\\"selector\\\": thiselem.selector, \\\"price\\\":$node[\\\"getActualPrice\\\"].json.price, \\\"currency\\\": thiselem.currency};\\n\\nreturn $node[\\\"changeME\\\"].json.myWatchers;\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Write Binary File1\",\n      \"type\": \"n8n-nodes-base.writeBinaryFile\",\n      \"position\": [\n        1850,\n        -390\n      ],\n      \"parameters\": {\n        \"fileName\": \"/data/kopacky.json\",\n        \"dataPropertyName\": \"=price\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Move Binary Data1\",\n      \"type\": \"n8n-nodes-base.moveBinaryData\",\n      \"position\": [\n        1420,\n        -390\n      ],\n      \"parameters\": {\n        \"mode\": \"jsonToBinary\",\n        \"options\": {},\n        \"destinationKey\": \"price\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"IF1\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        550,\n        -370\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{$node[\\\"checkifexists\\\"].json[\\\"stdout\\\"]}}\",\n              \"value2\": \"Exists\",\n              \"operation\": \"notEqual\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"checkifexists\",\n      \"type\": \"n8n-nodes-base.executeCommand\",\n      \"position\": [\n        410,\n        -370\n      ],\n      \"parameters\": {\n        \"command\": \"if [ -r /data/kopacky.json ]; then echo Exists; fi\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"IF3\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        680,\n        110\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{$node[\\\"checkifexists\\\"].json[\\\"stdout\\\"]}}\",\n              \"value2\": \"Exists\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"SaveToFile\",\n      \"type\": \"n8n-nodes-base.writeBinaryFile\",\n      \"position\": [\n        1650,\n        110\n      ],\n      \"parameters\": {\n        \"fileName\": \"/data/kopacky.json\",\n        \"dataPropertyName\": \"=price\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"JsonToBinary\",\n      \"type\": \"n8n-nodes-base.moveBinaryData\",\n      \"position\": [\n        1500,\n        110\n      ],\n      \"parameters\": {\n        \"mode\": \"jsonToBinary\",\n        \"options\": {},\n        \"destinationKey\": \"price\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"changeME\",\n      \"type\": \"n8n-nodes-base.functionItem\",\n      \"color\": \"#3BDD33\",\n      \"position\": [\n        -830,\n        -390\n      ],\n      \"parameters\": {\n        \"functionCode\": \"const globalData = getWorkflowStaticData('global');\\n\\n//{'slug': 'kopacky', 'link': 'https://www.adsport.sk/kopacky-lisovky-adidas-x-19-3-ll-fg-ef0598/#1131861', 'currency': 'EUR'}[]\\nvar myWatchers = [\\n{'slug': 'kopacky', 'link': 'https://www.adsport.sk/kopacky-lisovky-adidas-x-19-3-ll-fg-ef0598/#1131861', 'selector':'.prices > strong:nth-child(1) > span:nth-child(1)', 'currency': 'EUR'},\\n{'slug': 'kopacky2', 'link': 'https://www.adsport.sk/turfy-adidas-ace-tango-17-3-tf-by2203/', 'selector':'.col-xs-4 > strong:nth-child(1) > span:nth-child(1)', 'currency': 'EUR'},\\n{'slug': 'mobilcek', 'link': 'https://mobil.bazos.sk/inzerat/112253662/predam-odolny-doogee-s60-52-4g-lte-nfc.php', 'selector':'.listadvlevo > table:nth-child(1) > tbody:nth-child(1) > tr:nth-child(5) > td:nth-child(2) > b:nth-child(2)', 'currency': 'EUR'},\\n{'slug': 'ADIZERO RC 2', 'link': 'https://www.adsport.sk/panske-bezecke-topanky-adidas-adizero-rc-2-eg1187/', 'selector':'.col-xs-4 > strong:nth-child(1) > span:nth-child(1)', 'currency': 'EUR'}\\n];\\n\\nitem.myWatchers = myWatchers;\\nitem.watchersCount = myWatchers.length;\\nglobalData.myWatchers = myWatchers;\\n\\nreturn item;\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"initItem\",\n      \"type\": \"n8n-nodes-base.functionItem\",\n      \"position\": [\n        -620,\n        -390\n      ],\n      \"parameters\": {\n        \"functionCode\": \"const globalData = getWorkflowStaticData('global');\\n\\nvar counter = globalData.iteration;\\n\\nitem.myWatchers[counter].watchersCount = item.watchersCount;\\nitem.myWatchers[counter].canContinue = (globalData.iteration < item.watchersCount-1 ? true : false);\\n//item.myWatchers[counter].canContinue = false;\\n\\nglobalData.iteration = counter + 1;\\n\\nreturn item.myWatchers[counter];\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"savedItems\",\n      \"type\": \"n8n-nodes-base.readBinaryFile\",\n      \"position\": [\n        850,\n        -20\n      ],\n      \"parameters\": {\n        \"filePath\": \"/data/kopacky.json\",\n        \"dataPropertyName\": \"savedItems\"\n      },\n      \"typeVersion\": 1,\n      \"continueOnFail\": true,\n      \"alwaysOutputData\": true\n    },\n    {\n      \"name\": \"itemsToJSON\",\n      \"type\": \"n8n-nodes-base.moveBinaryData\",\n      \"position\": [\n        1020,\n        -20\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"sourceKey\": \"savedItems\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"IF\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        2190,\n        -90\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [],\n          \"boolean\": [\n            {\n              \"value1\": \"={{$node[\\\"initItem\\\"].json[\\\"canContinue\\\"]}}\",\n              \"value2\": true\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"initItem1\",\n      \"type\": \"n8n-nodes-base.functionItem\",\n      \"position\": [\n        -1060,\n        -390\n      ],\n      \"parameters\": {\n        \"functionCode\": \"const globalData = getWorkflowStaticData('global');\\n\\nglobalData.iteration = 0;\\n\\nreturn item;\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"IF2\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        1850,\n        110\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"number\": [\n            {\n              \"value1\": \"={{$node[\\\"getActualPrice\\\"].json[\\\"price\\\"]}}\",\n              \"value2\": \"={{$node[\\\"updateSavedItems1\\\"].json[\\\"oldPrice\\\"]}}\"\n            }\n          ],\n          \"string\": []\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"updateSavedItems\",\n      \"type\": \"n8n-nodes-base.functionItem\",\n      \"position\": [\n        1350,\n        110\n      ],\n      \"parameters\": {\n        \"functionCode\": \"const globalData = getWorkflowStaticData('global');\\n\\nvar myitems = [];\\nvar i;\\nfor (i = 0; i < item.items.length; i++) { \\n  if($node[\\\"initItem\\\"].json.slug == item.items[i].slug && $node[\\\"getActualPrice\\\"].json.price < item.items[i].price) {\\n    item.items[i].price = $node[\\\"getActualPrice\\\"].json.price;\\n  }\\n  myitems.push(item.items[i]);\\n} \\n\\nreturn myitems;\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"updateSavedItems1\",\n      \"type\": \"n8n-nodes-base.functionItem\",\n      \"position\": [\n        1200,\n        -20\n      ],\n      \"parameters\": {\n        \"functionCode\": \"const globalData = getWorkflowStaticData('global');\\nvar oldPrice = null;\\nvar myitems = [];\\nvar i;\\nfor (i = 0; i < item.length; i++) {\\n  if($node[\\\"initItem\\\"].json.slug == item[i].slug) {\\n\\n    item[i].link = $node[\\\"initItem\\\"].json.link;\\n    item[i].selector = $node[\\\"initItem\\\"].json.selector;\\n    item[i].currency = $node[\\\"initItem\\\"].json.currency;\\n    \\n    if(!item[i].price){\\n      item[i].price = $node[\\\"getActualPrice\\\"].json.price;\\n    }\\n    \\n    if($node[\\\"getActualPrice\\\"].json.price < item[i].price){\\n      oldPrice = item[i].price;\\n      item[i].price = $node[\\\"getActualPrice\\\"].json.price;\\n    }\\n    \\n    \\n  }\\n  \\n  myitems.push(item[i]);\\n} \\n\\n//item.somar = $node[\\\"initItem\\\"].json;\\n//return globalData.actualPrice;\\n\\nvar itemm = {};\\nitemm.items = myitems;\\nitemm.oldPrice = oldPrice;\\nreturn itemm;\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"cleanData\",\n      \"type\": \"n8n-nodes-base.executeCommand\",\n      \"notes\": \"This will remove all storaged data.\",\n      \"position\": [\n        -1290,\n        -560\n      ],\n      \"parameters\": {\n        \"command\": \"file=\\\"/data/kopacky.json\\\"\\n[ -f $file ] && rm $file\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"IF4\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        150,\n        -390\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [],\n          \"boolean\": [\n            {\n              \"value1\": \"={{$node[\\\"getActualPrice\\\"].json[\\\"priceExists\\\"]}}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"NotifyBetterPrice\",\n      \"type\": \"n8n-nodes-base.emailSend\",\n      \"position\": [\n        1850,\n        -90\n      ],\n      \"parameters\": {\n        \"html\": \"=<h2>Nová cena je: {{$node[\\\"getActualPrice\\\"].json[\\\"price\\\"]}} {{$node[\\\"initItem\\\"].json[\\\"currency\\\"]}}</h2><br>\\nPôvodná cena bola: {{$node[\\\"updateSavedItems1\\\"].json[\\\"oldPrice\\\"]}} {{$node[\\\"initItem\\\"].json[\\\"currency\\\"]}}<br>\\nURL: {{$node[\\\"initItem\\\"].json[\\\"link\\\"]}}\",\n        \"text\": \"=\",\n        \"options\": {},\n        \"subject\": \"=Nová cena - {{$node[\\\"initItem\\\"].json[\\\"slug\\\"]}} - {{$node[\\\"getActualPrice\\\"].json[\\\"price\\\"]}} {{$node[\\\"initItem\\\"].json[\\\"currency\\\"]}}\",\n        \"toEmail\": \"sthosstudio@gmail.com\",\n        \"fromEmail\": \"hostovecky@weyou.sk\"\n      },\n      \"credentials\": {\n        \"smtp\": \"hostovecky@weyou.sk\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"NotifyIncorrectPrice\",\n      \"type\": \"n8n-nodes-base.emailSend\",\n      \"position\": [\n        270,\n        -690\n      ],\n      \"parameters\": {\n        \"html\": \"=Please check the link or selector for the item with slug <strong>{{$node[\\\"initItem\\\"].json[\\\"slug\\\"]}}</strong><br>\\nURL: {{$node[\\\"initItem\\\"].json[\\\"link\\\"]}}\",\n        \"text\": \"=\",\n        \"options\": {},\n        \"subject\": \"={{$node[\\\"initItem\\\"].json[\\\"slug\\\"]}} - Getting price issue.\",\n        \"toEmail\": \"sthosstudio@gmail.com\",\n        \"fromEmail\": \"hostovecky@weyou.sk\"\n      },\n      \"credentials\": {\n        \"smtp\": \"hostovecky@weyou.sk\"\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"connections\": {\n    \"IF\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"changeME\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"IF1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"FunctionItem\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"IF3\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"IF2\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"NotifyBetterPrice\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"IF\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"IF3\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"savedItems\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"IF4\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"NotifyIncorrectPrice\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"checkifexists\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Cron\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"initItem1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"changeME\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"initItem\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"fetchWeb\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"HTML Extract\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"initItem\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"fetchWeb\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"initItem1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"changeME\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"SaveToFile\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"IF2\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"savedItems\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"itemsToJSON\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"itemsToJSON\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"updateSavedItems1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"FunctionItem\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Move Binary Data1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"HTML Extract\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"getActualPrice\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"JsonToBinary\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"SaveToFile\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"checkifexists\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"IF1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"getActualPrice\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"IF4\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"updateSavedItems\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"JsonToBinary\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Move Binary Data1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Write Binary File1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"NotifyBetterPrice\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"IF\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"updateSavedItems1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"updateSavedItems\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Write Binary File1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"IF\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"NotifyIncorrectPrice\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"checkifexists\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.htmlExtract",
      "n8n-nodes-base.cron",
      "n8n-nodes-base.functionItem",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.functionItem",
      "n8n-nodes-base.writeBinaryFile",
      "n8n-nodes-base.moveBinaryData",
      "n8n-nodes-base.if",
      "n8n-nodes-base.executeCommand",
      "n8n-nodes-base.if",
      "n8n-nodes-base.writeBinaryFile",
      "n8n-nodes-base.moveBinaryData",
      "n8n-nodes-base.functionItem",
      "n8n-nodes-base.functionItem",
      "n8n-nodes-base.readBinaryFile",
      "n8n-nodes-base.moveBinaryData",
      "n8n-nodes-base.if",
      "n8n-nodes-base.functionItem",
      "n8n-nodes-base.if",
      "n8n-nodes-base.functionItem",
      "n8n-nodes-base.functionItem",
      "n8n-nodes-base.executeCommand",
      "n8n-nodes-base.if",
      "n8n-nodes-base.emailSend",
      "n8n-nodes-base.emailSend"
    ],
    "trigger": null
  }
}