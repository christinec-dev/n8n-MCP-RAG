{
  "source": "0774_Splitout_Code_Automate_Webhook.json",
  "index": 1,
  "content": "{\n  \"meta\": {\n    \"instanceId\": \"4bcdfa475d937e8c2fc1d40936bca36ec49bdb2525076e1bd53cc12fc6c8756d\"\n  },\n  \"name\": \"My workflow 2\",\n  \"tags\": [],\n  \"nodes\": [\n    {\n      \"id\": \"1562791c-33a9-425c-a774-32e328bd4715\",\n      \"name\": \"Token Request\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"notes\": \"Get the token from Dartagnan that expires after 60 minutes\",\n      \"position\": [\n        60,\n        200\n      ],\n      \"parameters\": {\n        \"url\": \"https://app.dartagnan.io/oauth/v2/token\",\n        \"method\": \"POST\",\n        \"options\": {\n          \"redirect\": {\n            \"redirect\": {}\n          }\n        },\n        \"sendBody\": true,\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"client_id\",\n              \"value\": \"={{ $('Assign Credentials').item.json.client_id }}\"\n            },\n            {\n              \"name\": \"client_secret\",\n              \"value\": \"={{ $('Assign Credentials').item.json.client_secret }}\"\n            },\n            {\n              \"name\": \"grant_type\",\n              \"value\": \"client_credentials\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"2d81394c-9898-419a-a832-339e66d56a29\",\n      \"name\": \"Assign Credentials\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        -400,\n        300\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"debe5309-40f6-411d-8c4d-3b282cf1bba9\",\n              \"name\": \"client_id\",\n              \"type\": \"string\",\n              \"value\": \"Enter your Dartagnan client_id\"\n            },\n            {\n              \"id\": \"6028c0c0-a701-449e-952e-46895280e4ef\",\n              \"name\": \"client_secret\",\n              \"type\": \"string\",\n              \"value\": \"Enter your Dartagnan client_secret\"\n            },\n            {\n              \"id\": \"7e82aa01-18ff-4b76-802b-cc8cae987614\",\n              \"name\": \"instance_url\",\n              \"type\": \"string\",\n              \"value\": \"Enter your Braze instance_url like https://rest.fra-02.braze.eu for example\"\n            },\n            {\n              \"id\": \"a3c641d7-fdbd-4e96-a845-e2c5aad93398\",\n              \"name\": \"api_key\",\n              \"type\": \"string\",\n              \"value\": \"Enter your Braze API key\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"b80a8eda-bbf6-4560-8665-5128a97db217\",\n      \"name\": \"Dartagnan Project list\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        360,\n        200\n      ],\n      \"parameters\": {\n        \"url\": \"https://app.dartagnan.io/api/public/projects\",\n        \"options\": {\n          \"redirect\": {\n            \"redirect\": {}\n          }\n        },\n        \"sendHeaders\": true,\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Authorization\",\n              \"value\": \"=Bearer {{ $json.access_token }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"909eb4f9-d67e-4f5e-bdb6-67ef2da813a4\",\n      \"name\": \"Create email template\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        2420,\n        400\n      ],\n      \"parameters\": {\n        \"url\": \"=https://{{ $item(\\\"0\\\").$node[\\\"Assign Credentials\\\"].json[\\\"instance_url\\\"] }}/templates/email/create\",\n        \"method\": \"POST\",\n        \"options\": {\n          \"redirect\": {\n            \"redirect\": {}\n          }\n        },\n        \"jsonBody\": \"={\\n  \\\"template_name\\\": \\\"{{ $('Filter Braze vs Dartagnan').item.json.unified_name }}\\\",\\n  \\\"subject\\\": \\\"Subject Line\\\",\\n  \\\"body\\\": {{ $json.encoded_html }},\\n  \\\"plaintext_body\\\":{{ $json.encoded_plaintext_body }}\\n}\",\n        \"sendBody\": true,\n        \"sendHeaders\": true,\n        \"specifyBody\": \"json\",\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Authorization\",\n              \"value\": \"=Bearer {{ $item(\\\"0\\\").$node[\\\"Assign Credentials\\\"].json[\\\"api_key\\\"] }}\"\n            },\n            {\n              \"name\": \"Content-Type\",\n              \"value\": \"application/json\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"0820220a-5ea6-42eb-bfd2-f697dcf37a8a\",\n      \"name\": \"List Available Email Template Braze\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        60,\n        420\n      ],\n      \"parameters\": {\n        \"url\": \"=https://{{ $('Assign Credentials').item.json.instance_url }}/templates/email/list \",\n        \"options\": {\n          \"redirect\": {\n            \"redirect\": {}\n          }\n        },\n        \"sendQuery\": true,\n        \"sendHeaders\": true,\n        \"queryParameters\": {\n          \"parameters\": [\n            {}\n          ]\n        },\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Authorization\",\n              \"value\": \"=Bearer {{ $('Assign Credentials').item.json.api_key }}\"\n            }\n          ]\n        }\n      },\n      \"executeOnce\": false,\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"dcfec31d-c42c-4545-91a0-3b2e3350d375\",\n      \"name\": \"Filtered Project Campaign\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"notes\": \"POC Avec la derniere valeur avant iteration sur une boucle for dans la v2\",\n      \"position\": [\n        640,\n        200\n      ],\n      \"parameters\": {\n        \"url\": \"=https://app.dartagnan.io/api/public/projects/{{ $json.id }}\",\n        \"options\": {\n          \"redirect\": {\n            \"redirect\": {}\n          }\n        },\n        \"sendHeaders\": true,\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Authorization\",\n              \"value\": \"=Bearer  {{ $('Token Request').item.json.access_token }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"1aba6e4c-d3b0-49f8-8bcb-bece8cce4b4d\",\n      \"name\": \"Filtering Dartagnan Campaigns\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        840,\n        200\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"e82823f9-e094-48e6-9d10-8d10c126ffa8\",\n              \"name\": \"id\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.campaigns[0].id }}\"\n            },\n            {\n              \"id\": \"31ddce2b-7366-448c-a68f-bfea4dcb057b\",\n              \"name\": \"campaign_name\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.campaigns[0].name }}\"\n            },\n            {\n              \"id\": \"0eb93a91-fbd5-45f9-b47c-89340f716909\",\n              \"name\": \"=unified_name\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.campaigns[0].name }}-{{ $json.campaigns[0].id }}\"\n            },\n            {\n              \"id\": \"e784ad19-301f-45f7-b90b-27bcce06b6dc\",\n              \"name\": \"creation_date\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.campaigns[0].created }}\"\n            },\n            {\n              \"id\": \"8e99802a-1342-4482-afc7-fbe22df6cffc\",\n              \"name\": \"update_date\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.campaigns[0].updated }}\"\n            },\n            {\n              \"id\": \"f5814048-5cb6-465f-a95a-c56913c9ed2d\",\n              \"name\": \"created_by\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.campaigns[0].createdBy.firstname }} {{ $json.campaigns[0].createdBy.lastname }}\"\n            },\n            {\n              \"id\": \"19442a15-bf61-47e1-987f-709de70f8f08\",\n              \"name\": \"modified_by\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.campaigns[0].updatedBy.firstname }} {{ $json.campaigns[0].updatedBy.lastname }}\"\n            },\n            {\n              \"id\": \"b75db148-0006-4327-a418-49347da5b970\",\n              \"name\": \"access_token\",\n              \"type\": \"string\",\n              \"value\": \"={{ $('Token Request').item.json.access_token }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"ee26ca98-2c42-4e69-ab34-cc2d737c22f8\",\n      \"name\": \"Split Out\",\n      \"type\": \"n8n-nodes-base.splitOut\",\n      \"position\": [\n        360,\n        420\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"fieldToSplitOut\": \"templates\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"08d8372f-38cb-4722-95aa-c89bfcc36dff\",\n      \"name\": \"Filtering Braze Email Template\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        800,\n        420\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"920fd95b-bf48-494d-9d55-d5d961fd459f\",\n              \"name\": \"braze_template_name\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.template_name }}\"\n            },\n            {\n              \"id\": \"8425c3c2-07c3-4c3d-a58e-e8d1460fea9c\",\n              \"name\": \"email_template_id\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.email_template_id }}\"\n            },\n            {\n              \"id\": \"1944b20a-147b-4b4d-9558-f2927de9b2f2\",\n              \"name\": \"created_at\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.created_at }}\"\n            },\n            {\n              \"id\": \"850a4a0a-d27b-43cb-a8a3-2d810a5fdc13\",\n              \"name\": \"updated_at\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.updated_at }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"3e07fa37-8afd-4d88-85a3-53a4f000f898\",\n      \"name\": \"Not existing In Braze\",\n      \"type\": \"n8n-nodes-base.merge\",\n      \"position\": [\n        1160,\n        420\n      ],\n      \"parameters\": {\n        \"mode\": \"combine\",\n        \"options\": {},\n        \"advanced\": true,\n        \"joinMode\": \"keepNonMatches\",\n        \"mergeByFields\": {\n          \"values\": [\n            {\n              \"field1\": \"unified_name\",\n              \"field2\": \"braze_template_name\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3\n    },\n    {\n      \"id\": \"210a9d44-f58f-4788-89bd-934dfc0fca41\",\n      \"name\": \"Existing In Braze\",\n      \"type\": \"n8n-nodes-base.merge\",\n      \"position\": [\n        1140,\n        200\n      ],\n      \"parameters\": {\n        \"mode\": \"combine\",\n        \"options\": {},\n        \"advanced\": true,\n        \"mergeByFields\": {\n          \"values\": [\n            {\n              \"field1\": \"unified_name\",\n              \"field2\": \"braze_template_name\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3\n    },\n    {\n      \"id\": \"59f8270b-b988-452b-aaf0-0e7b35490449\",\n      \"name\": \"Dartagnan HTML & MEDIA To Update\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1740,\n        180\n      ],\n      \"parameters\": {\n        \"url\": \"=https://app.dartagnan.io/api/public/campaigns/{{ $json.id }}\",\n        \"options\": {\n          \"redirect\": {\n            \"redirect\": {}\n          }\n        },\n        \"sendQuery\": true,\n        \"sendHeaders\": true,\n        \"queryParameters\": {\n          \"parameters\": [\n            {}\n          ]\n        },\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Authorization\",\n              \"value\": \"=Bearer  {{ $('Token Request').item.json.access_token }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"04b26314-cb00-4a90-a7fe-019936a5ba2a\",\n      \"name\": \"Encode Content To Update\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        2180,\n        180\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"fb308822-842f-4559-b5c9-96853c79e00e\",\n              \"name\": \"encoded_html\",\n              \"type\": \"string\",\n              \"value\": \"={{JSON.stringify( $json.html  )}} \"\n            },\n            {\n              \"id\": \"390b747b-967d-45f4-9faf-3aaed605d769\",\n              \"name\": \"encoded_plaintext_body\",\n              \"type\": \"string\",\n              \"value\": \"={{JSON.stringify($json.text)}} \"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"1455fd2e-85ee-4844-8c4b-755870dc9cee\",\n      \"name\": \"Dartagnan HTML & MEDIA Campagne to Create\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1760,\n        400\n      ],\n      \"parameters\": {\n        \"url\": \"=https://app.dartagnan.io/api/public/campaigns/{{ $json.id }}\",\n        \"options\": {\n          \"redirect\": {\n            \"redirect\": {}\n          }\n        },\n        \"sendQuery\": true,\n        \"sendHeaders\": true,\n        \"queryParameters\": {\n          \"parameters\": [\n            {}\n          ]\n        },\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Authorization\",\n              \"value\": \"=Bearer  {{ $('Token Request').item.json.access_token }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"214d8b4b-c512-4d1f-8115-8491f6fc9272\",\n      \"name\": \"Encode Content to Create\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        2200,\n        400\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"fb308822-842f-4559-b5c9-96853c79e00e\",\n              \"name\": \"encoded_html\",\n              \"type\": \"string\",\n              \"value\": \"={{JSON.stringify( $json.html  )}} \"\n            },\n            {\n              \"id\": \"390b747b-967d-45f4-9faf-3aaed605d769\",\n              \"name\": \"encoded_plaintext_body\",\n              \"type\": \"string\",\n              \"value\": \"={{JSON.stringify($json.text)}} \"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"90158667-eeda-4d44-b45c-c6e7fa02e664\",\n      \"name\": \"If campaign is modified recently\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        1420,\n        200\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"version\": 2,\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"strict\"\n          },\n          \"combinator\": \"and\",\n          \"conditions\": [\n            {\n              \"id\": \"7e9c9fd3-2ef9-47ce-bccb-9b3320472d36\",\n              \"operator\": {\n                \"type\": \"dateTime\",\n                \"operation\": \"after\"\n              },\n              \"leftValue\": \"={{ $json.update_date }}\",\n              \"rightValue\": \"={{ $json.updated_at }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2.2\n    },\n    {\n      \"id\": \"55aecc9b-d5a6-4a6b-a986-3ddfae200b94\",\n      \"name\": \"Filter Braze vs Dartagnan\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        1440,\n        420\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"version\": 2,\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"strict\"\n          },\n          \"combinator\": \"and\",\n          \"conditions\": [\n            {\n              \"id\": \"7e9c9fd3-2ef9-47ce-bccb-9b3320472d36\",\n              \"operator\": {\n                \"type\": \"string\",\n                \"operation\": \"exists\",\n                \"singleValue\": true\n              },\n              \"leftValue\": \"={{ $json.unified_name }}\",\n              \"rightValue\": \"=\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2.2\n    },\n    {\n      \"id\": \"ff2a47df-983f-42f5-9c96-431fccbdb8ef\",\n      \"name\": \"Embed image in HTML\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        1960,\n        180\n      ],\n      \"parameters\": {\n        \"jsCode\": \"// n8n Code Node: HTML Image URL Replacer\\n// This script replaces all image references in HTML with their direct URLs\\n// It's designed to work with the data structure you provided\\n\\n/**\\n * Main function to process the incoming data in n8n\\n * Expects an item with html and medias properties\\n */\\nfunction processData(item) {\\n  // Extract the HTML and media mappings from the item\\n  const { html, medias } = item.json;\\n\\n  // Process the HTML and replace all image references\\n  const processedHtml = replaceImageReferences(html, medias);\\n\\n  // Return the processed data\\n  return {\\n    json: {\\n      ...item.json,\\n      html: processedHtml\\n    }\\n  };\\n}\\n\\n/**\\n * Replace all image references in HTML with direct URLs\\n * @param {string} html - The HTML content to process\\n * @param {Object} medias - Key-value pairs mapping image paths to direct URLs\\n * @returns {string} - Processed HTML with direct URLs\\n */\\nfunction replaceImageReferences(html, medias) {\\n  if (!html || !medias) {\\n    throw new Error('Missing required parameters: html or medias');\\n  }\\n  \\n  let updatedHtml = html;\\n  \\n  // Process each media URL\\n  Object.entries(medias).forEach(([imagePath, directUrl]) => {\\n    // For safety, escape special regex characters in the image path\\n    const escapedPath = imagePath.replace(/[.*+?^${}()|[\\\\]\\\\\\\\]/g, '\\\\\\\\$&');\\n    \\n    // 1. Replace in img src attributes\\n    updatedHtml = updatedHtml.replace(\\n      new RegExp(`src=[\\\"']${escapedPath}[\\\"']`, 'g'), \\n      match => match.replace(imagePath, directUrl)\\n    );\\n    \\n    // 2. Replace in background attributes\\n    updatedHtml = updatedHtml.replace(\\n      new RegExp(`background=[\\\"']${escapedPath}[\\\"']`, 'g'), \\n      match => match.replace(imagePath, directUrl)\\n    );\\n    \\n    // 3. Replace in v:fill src attributes (for Outlook)\\n    updatedHtml = updatedHtml.replace(\\n      new RegExp(`<v:fill[^>]*src=[\\\"']${escapedPath}[\\\"'][^>]*>`, 'g'), \\n      match => match.replace(imagePath, directUrl)\\n    );\\n    \\n    // 4. Replace in CSS background and background-image styles\\n    // Handle various quote styles and syntax patterns\\n    const backgroundPatterns = [\\n      `background-image:\\\\\\\\s*url\\\\\\\\(['\\\"]?${escapedPath}['\\\"]?\\\\\\\\)`,\\n      `background:\\\\\\\\s*url\\\\\\\\(['\\\"]?${escapedPath}['\\\"]?\\\\\\\\)`,\\n      `background:\\\\\\\\s*[^;]*url\\\\\\\\(['\\\"]?${escapedPath}['\\\"]?\\\\\\\\)`,\\n    ];\\n    \\n    backgroundPatterns.forEach(pattern => {\\n      updatedHtml = updatedHtml.replace(\\n        new RegExp(pattern, 'g'),\\n        match => match.replace(imagePath, directUrl)\\n      );\\n    });\\n    \\n    // 5. Replace in CSS class references\\n    // This is more complex and depends on your HTML structure\\n    // Extract file name for matching class names\\n    const fileNameMatch = imagePath.match(/\\\\/([^\\\\/]+)\\\\.([^\\\\.]+)$/);\\n    if (fileNameMatch) {\\n      const fileName = fileNameMatch[1];\\n      const fileExt = fileNameMatch[2];\\n      \\n      // Handle class names like \\\"bgiurlimagesdiv2dpng\\\"\\n      const classPatterns = [\\n        `bgiurlimagesdiv${fileName}d${fileExt}`,\\n        `bgurlimagesdiv${fileName}d${fileExt}`\\n      ];\\n      \\n      classPatterns.forEach(pattern => {\\n        // Replace the class name and also update the associated styles if needed\\n        updatedHtml = updatedHtml.replace(\\n          new RegExp(`class=[\\\"'][^\\\"']*${pattern}[^\\\"']*[\\\"']`, 'g'),\\n          match => match.replace(pattern, `direct-url-${Date.now()}`)\\n        );\\n      });\\n    }\\n  });\\n  \\n  return updatedHtml;\\n}\\n\\n// This is the main execution for n8n\\n// It processes each item in the incoming array and returns the results\\nreturn items.map(processData);\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"0fbdb7d6-64a3-40ae-8187-8afcb76451e8\",\n      \"name\": \"Embed image in HTML 1\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        1960,\n        400\n      ],\n      \"parameters\": {\n        \"jsCode\": \"// n8n Code Node: HTML Image URL Replacer\\n// This script replaces all image references in HTML with their direct URLs\\n// It's designed to work with the data structure you provided\\n\\n/**\\n * Main function to process the incoming data in n8n\\n * Expects an item with html and medias properties\\n */\\nfunction processData(item) {\\n  // Extract the HTML and media mappings from the item\\n  const { html, medias } = item.json;\\n\\n  // Process the HTML and replace all image references\\n  const processedHtml = replaceImageReferences(html, medias);\\n\\n  // Return the processed data\\n  return {\\n    json: {\\n      ...item.json,\\n      html: processedHtml\\n    }\\n  };\\n}\\n\\n/**\\n * Replace all image references in HTML with direct URLs\\n * @param {string} html - The HTML content to process\\n * @param {Object} medias - Key-value pairs mapping image paths to direct URLs\\n * @returns {string} - Processed HTML with direct URLs\\n */\\nfunction replaceImageReferences(html, medias) {\\n  if (!html || !medias) {\\n    throw new Error('Missing required parameters: html or medias');\\n  }\\n  \\n  let updatedHtml = html;\\n  \\n  // Process each media URL\\n  Object.entries(medias).forEach(([imagePath, directUrl]) => {\\n    // For safety, escape special regex characters in the image path\\n    const escapedPath = imagePath.replace(/[.*+?^${}()|[\\\\]\\\\\\\\]/g, '\\\\\\\\$&');\\n    \\n    // 1. Replace in img src attributes\\n    updatedHtml = updatedHtml.replace(\\n      new RegExp(`src=[\\\"']${escapedPath}[\\\"']`, 'g'), \\n      match => match.replace(imagePath, directUrl)\\n    );\\n    \\n    // 2. Replace in background attributes\\n    updatedHtml = updatedHtml.replace(\\n      new RegExp(`background=[\\\"']${escapedPath}[\\\"']`, 'g'), \\n      match => match.replace(imagePath, directUrl)\\n    );\\n    \\n    // 3. Replace in v:fill src attributes (for Outlook)\\n    updatedHtml = updatedHtml.replace(\\n      new RegExp(`<v:fill[^>]*src=[\\\"']${escapedPath}[\\\"'][^>]*>`, 'g'), \\n      match => match.replace(imagePath, directUrl)\\n    );\\n    \\n    // 4. Replace in CSS background and background-image styles\\n    // Handle various quote styles and syntax patterns\\n    const backgroundPatterns = [\\n      `background-image:\\\\\\\\s*url\\\\\\\\(['\\\"]?${escapedPath}['\\\"]?\\\\\\\\)`,\\n      `background:\\\\\\\\s*url\\\\\\\\(['\\\"]?${escapedPath}['\\\"]?\\\\\\\\)`,\\n      `background:\\\\\\\\s*[^;]*url\\\\\\\\(['\\\"]?${escapedPath}['\\\"]?\\\\\\\\)`,\\n    ];\\n    \\n    backgroundPatterns.forEach(pattern => {\\n      updatedHtml = updatedHtml.replace(\\n        new RegExp(pattern, 'g'),\\n        match => match.replace(imagePath, directUrl)\\n      );\\n    });\\n    \\n    // 5. Replace in CSS class references\\n    // This is more complex and depends on your HTML structure\\n    // Extract file name for matching class names\\n    const fileNameMatch = imagePath.match(/\\\\/([^\\\\/]+)\\\\.([^\\\\.]+)$/);\\n    if (fileNameMatch) {\\n      const fileName = fileNameMatch[1];\\n      const fileExt = fileNameMatch[2];\\n      \\n      // Handle class names like \\\"bgiurlimagesdiv2dpng\\\"\\n      const classPatterns = [\\n        `bgiurlimagesdiv${fileName}d${fileExt}`,\\n        `bgurlimagesdiv${fileName}d${fileExt}`\\n      ];\\n      \\n      classPatterns.forEach(pattern => {\\n        // Replace the class name and also update the associated styles if needed\\n        updatedHtml = updatedHtml.replace(\\n          new RegExp(`class=[\\\"'][^\\\"']*${pattern}[^\\\"']*[\\\"']`, 'g'),\\n          match => match.replace(pattern, `direct-url-${Date.now()}`)\\n        );\\n      });\\n    }\\n  });\\n  \\n  return updatedHtml;\\n}\\n\\n// This is the main execution for n8n\\n// It processes each item in the incoming array and returns the results\\nreturn items.map(processData);\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"89acf2f3-940b-47e9-81e3-2d458d3018ee\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -460,\n        80\n      ],\n      \"parameters\": {\n        \"height\": 400,\n        \"content\": \"## Authentication Set Up\\n\\nObtain an access token from Dartagnan\\nPrepare credentials for both Dartagnan and Braze\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"317cd699-6686-42a0-ba6d-8f6405338356\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        60,\n        480\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 960,\n        \"height\": 380,\n        \"content\": \"\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n## Template Discovery\\n\\n\\nList all existing email templates in Braze\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"d59b0dac-439e-4160-8879-b306ccd18773\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        0,\n        0\n      ],\n      \"parameters\": {\n        \"width\": 260,\n        \"height\": 380,\n        \"content\": \"## Authentication Token\\n\\nObtain an access token from Dartagnan\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"dc38ec97-ca50-4944-89f1-535f23420cfc\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        300,\n        0\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 460,\n        \"height\": 380,\n        \"content\": \"## Template Discovery\\n\\nRetrieve project and campaign details from Dartagnan\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"5fd7d7dc-f314-411a-ba0a-4af14874f96b\",\n      \"name\": \"Sticky Note4\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1040,\n        0\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 600,\n        \"height\": 680,\n        \"content\": \"## Comparison and Sync\\n\\nCompare Dartagnan templates with existing Braze templates\\nIdentify templates to update (top Branch) or create ( Lower Branch)\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"e198dca0-0278-4b67-9807-90796ff2d644\",\n      \"name\": \"Sticky Note5\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1660,\n        0\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 980,\n        \"height\": 680,\n        \"content\": \"## Template Processing\\n\\nExtract HTML and media from Dartagnan templates\\nReplace image references with direct URLs\\nPrepare templates for Braze\\nUpdate existing templates in Braze ( upper branch ) \\nCreate new templates in Braze as needed ( lower branch ) \"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"321eb50a-66a2-4951-b61b-e0869a91b6a0\",\n      \"name\": \"Sticky Note6\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -980,\n        80\n      ],\n      \"parameters\": {\n        \"color\": 4,\n        \"width\": 460,\n        \"height\": 380,\n        \"content\": \"## Trigger\\n\\nTrigger is scheduled to run every 5 minutes, you can change this, but bear in mind to stay in the API rate limits of each vendor\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"8e0984c5-ec70-4ca5-97fe-0bdd24acd95c\",\n      \"name\": \"Every 5 minutes start\",\n      \"type\": \"n8n-nodes-base.scheduleTrigger\",\n      \"notes\": \"This node is a scheduled trigger that will synchronize ever\",\n      \"position\": [\n        -660,\n        300\n      ],\n      \"parameters\": {\n        \"rule\": {\n          \"interval\": [\n            {\n              \"field\": \"minutes\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"adb2c227-d27e-44fc-8f6e-0b3d02952ef9\",\n      \"name\": \"Update existing email template in Braze\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        2400,\n        180\n      ],\n      \"parameters\": {\n        \"url\": \"=https://{{ $('Assign Credentials').item.json.instance_url }}/templates/email/update \",\n        \"method\": \"POST\",\n        \"options\": {},\n        \"jsonBody\": \"={\\n  \\\"email_template_id\\\": {{ $('If campaign is modified recently').item.json.campaign_name }},\\n  \\\"template_name\\\": \\\"{{ $('If campaign is modified recently').item.json.unified_name }}\\\",\\n  \\\"subject\\\": \\\"Subject Line\\\",\\n  \\\"body\\\":{{ $json.encoded_html }} ,\\n  \\\"plaintext_body\\\": {{ $json.encoded_plaintext_body }}\\n} \",\n        \"sendBody\": true,\n        \"sendHeaders\": true,\n        \"specifyBody\": \"json\",\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"Content-Type\",\n              \"value\": \"application/json\"\n            },\n            {\n              \"name\": \"Authorization\",\n              \"value\": \"=Bearer  {{ $('Assign Credentials').item.json.api_key }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2\n    }\n  ],\n  \"active\": false,\n  \"pinData\": {},\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"versionId\": \"\",\n  \"connections\": {\n    \"Split Out\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Filtering Braze Email Template\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Token Request\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Dartagnan Project list\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Existing In Braze\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"If campaign is modified recently\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Assign Credentials\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"List Available Email Template Braze\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Token Request\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Embed image in HTML\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Encode Content To Update\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Embed image in HTML 1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Encode Content to Create\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Every 5 minutes start\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Assign Credentials\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Not existing In Braze\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Filter Braze vs Dartagnan\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Dartagnan Project list\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Filtered Project Campaign\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Encode Content To Update\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Update existing email template in Braze\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Encode Content to Create\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Create email template\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Filter Braze vs Dartagnan\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Dartagnan HTML & MEDIA Campagne to Create\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Filtered Project Campaign\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Filtering Dartagnan Campaigns\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Filtering Dartagnan Campaigns\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Existing In Braze\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Not existing In Braze\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Filtering Braze Email Template\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Existing In Braze\",\n            \"type\": \"main\",\n            \"index\": 1\n          },\n          {\n            \"node\": \"Not existing In Braze\",\n            \"type\": \"main\",\n            \"index\": 1\n          }\n        ]\n      ]\n    },\n    \"Dartagnan HTML & MEDIA To Update\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Embed image in HTML\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"If campaign is modified recently\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Dartagnan HTML & MEDIA To Update\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"List Available Email Template Braze\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Split Out\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Dartagnan HTML & MEDIA Campagne to Create\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Embed image in HTML 1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.set",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.set",
      "n8n-nodes-base.splitOut",
      "n8n-nodes-base.set",
      "n8n-nodes-base.merge",
      "n8n-nodes-base.merge",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.set",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.set",
      "n8n-nodes-base.if",
      "n8n-nodes-base.if",
      "n8n-nodes-base.code",
      "n8n-nodes-base.code",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.scheduleTrigger",
      "n8n-nodes-base.httpRequest"
    ],
    "trigger": null
  }
}