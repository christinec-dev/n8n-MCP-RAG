{
  "source": "1411_Telegram_Wait_Automation_Triggered.json",
  "index": 1,
  "content": "{\n  \"id\": \"DnHvQ3KL8v8r5L5Z\",\n  \"meta\": {\n    \"instanceId\": \"ac63467607103d9c95dd644384984672b90b1cb03e07edbaf18fe72b2a6c45bb\",\n    \"templateCredsSetupCompleted\": true\n  },\n  \"name\": \"Telegram Chat with Buffering\",\n  \"tags\": [],\n  \"nodes\": [\n    {\n      \"id\": \"a3cc74e9-c696-48de-a04e-d48555641897\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -1640,\n        -800\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 220,\n        \"height\": 280,\n        \"content\": \"## 1. Receive Message\\n\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"ff18667d-0a31-4768-acf8-ed0d53b2f382\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        160,\n        -840\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 600,\n        \"height\": 520,\n        \"content\": \"## 3. AI Assistant\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"ce90f954-19b6-4224-ae88-b20c4da639e6\",\n      \"name\": \"Reply\",\n      \"type\": \"n8n-nodes-base.telegram\",\n      \"position\": [\n        920,\n        -700\n      ],\n      \"webhookId\": \"e3313c88-0d56-4d06-81cf-b48870dfe2fe\",\n      \"parameters\": {\n        \"text\": \"={{ $json.output }}\",\n        \"chatId\": \"={{ $('Receive Message').item.json.message.chat.id }}\",\n        \"additionalFields\": {\n          \"appendAttribution\": false\n        }\n      },\n      \"credentials\": {\n        \"telegramApi\": {\n          \"id\": \"lvrGkOs0ywXp5agp\",\n          \"name\": \"Telegram bsde.ai\"\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"6f46d89b-034c-47ea-a217-8d007bec1531\",\n      \"name\": \"Receive Message\",\n      \"type\": \"n8n-nodes-base.telegramTrigger\",\n      \"position\": [\n        -1580,\n        -680\n      ],\n      \"webhookId\": \"5047a673-ca1d-4e87-b51b-893108de0a59\",\n      \"parameters\": {\n        \"updates\": [\n          \"message\"\n        ],\n        \"additionalFields\": {}\n      },\n      \"credentials\": {\n        \"telegramApi\": {\n          \"id\": \"lvrGkOs0ywXp5agp\",\n          \"name\": \"Telegram bsde.ai\"\n        }\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"0f391daa-0e74-4058-8923-52f3c050c9ad\",\n      \"name\": \"Wait 10 Seconds\",\n      \"type\": \"n8n-nodes-base.wait\",\n      \"position\": [\n        -1000,\n        -580\n      ],\n      \"webhookId\": \"87994c9a-fd20-48b6-8dbe-9af36dc40b2f\",\n      \"parameters\": {\n        \"amount\": 10\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"8e6495d8-db6e-4692-ade5-45239049de34\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -1320,\n        -760\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 1400,\n        \"height\": 440,\n        \"content\": \"## 2. Buffer Incoming Messages\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"d4876fd2-2e0b-4f82-9dc3-553f926310bd\",\n      \"name\": \"Add to Queued Messages\",\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"position\": [\n        -1240,\n        -680\n      ],\n      \"parameters\": {\n        \"tableId\": \"message_queue\",\n        \"fieldsUi\": {\n          \"fieldValues\": [\n            {\n              \"fieldId\": \"user_id\",\n              \"fieldValue\": \"={{ $json.message.chat.id }}\"\n            },\n            {\n              \"fieldId\": \"message\",\n              \"fieldValue\": \"={{ $json.message.text }}\"\n            },\n            {\n              \"fieldId\": \"message_id\",\n              \"fieldValue\": \"={{ $json.message.message_id }}\"\n            }\n          ]\n        }\n      },\n      \"credentials\": {\n        \"supabaseApi\": {\n          \"id\": \"1iEg1EzFrF29iqp2\",\n          \"name\": \"Supabase (bsde.ai)\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"a2eeb77f-2d74-44ac-9812-c3659d2e2803\",\n      \"name\": \"No Operation, do nothing\",\n      \"type\": \"n8n-nodes-base.noOp\",\n      \"position\": [\n        -340,\n        -460\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"638fc82e-aba1-4deb-b506-33dcf4746896\",\n      \"name\": \"Aggregate\",\n      \"type\": \"n8n-nodes-base.aggregate\",\n      \"position\": [\n        220,\n        -700\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"fieldsToAggregate\": {\n          \"fieldToAggregate\": [\n            {\n              \"fieldToAggregate\": \"message\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"772f60e5-e52f-4779-aa03-e4d532ee4b5c\",\n      \"name\": \"Delete Queued Messages\",\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"position\": [\n        -100,\n        -700\n      ],\n      \"parameters\": {\n        \"filters\": {\n          \"conditions\": [\n            {\n              \"keyName\": \"user_id\",\n              \"keyValue\": \"={{ $json.user_id }}\",\n              \"condition\": \"eq\"\n            }\n          ]\n        },\n        \"tableId\": \"message_queue\",\n        \"operation\": \"delete\"\n      },\n      \"credentials\": {\n        \"supabaseApi\": {\n          \"id\": \"1iEg1EzFrF29iqp2\",\n          \"name\": \"Supabase (bsde.ai)\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"16b46a70-85a0-4c8c-94ba-172ebe9aafa4\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        860,\n        -780\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 280,\n        \"height\": 260,\n        \"content\": \"## 4. Send Reply\\n\\n\\n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"9162f110-465f-4cd6-9f03-17751d7e43a4\",\n      \"name\": \"OpenAI Chat Model\",\n      \"type\": \"@n8n/n8n-nodes-langchain.lmChatOpenAi\",\n      \"position\": [\n        380,\n        -460\n      ],\n      \"parameters\": {\n        \"model\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"gpt-4o-mini\"\n        },\n        \"options\": {}\n      },\n      \"credentials\": {\n        \"openAiApi\": {\n          \"id\": \"1OMpAMAKR9l3eUDI\",\n          \"name\": \"OpenAi account\"\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"b47ef0c9-725b-4837-b9e9-96a4ff2b3636\",\n      \"name\": \"Sort by Message ID\",\n      \"type\": \"n8n-nodes-base.sort\",\n      \"position\": [\n        -580,\n        -680\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"sortFieldsUi\": {\n          \"sortField\": [\n            {\n              \"fieldName\": \"message_id\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"1aa80c99-eec8-4174-bcf3-c6873354ed0f\",\n      \"name\": \"Get Queued Messages\",\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"position\": [\n        -780,\n        -680\n      ],\n      \"parameters\": {\n        \"filters\": {\n          \"conditions\": [\n            {\n              \"keyName\": \"user_id\",\n              \"keyValue\": \"={{ $('Receive Message').item.json.message.from.id }}\",\n              \"condition\": \"eq\"\n            }\n          ]\n        },\n        \"tableId\": \"message_queue\",\n        \"operation\": \"getAll\",\n        \"returnAll\": true\n      },\n      \"credentials\": {\n        \"supabaseApi\": {\n          \"id\": \"1iEg1EzFrF29iqp2\",\n          \"name\": \"Supabase (bsde.ai)\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"85050328-b5aa-47fe-802c-7d9f31f225cb\",\n      \"name\": \"Check Most Recent Message\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        -360,\n        -680\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"version\": 2,\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"loose\"\n          },\n          \"combinator\": \"and\",\n          \"conditions\": [\n            {\n              \"id\": \"8852bab7-230e-442a-a4a2-994e979c8f9f\",\n              \"operator\": {\n                \"type\": \"number\",\n                \"operation\": \"equals\"\n              },\n              \"leftValue\": \"={{ $input.last().json.message_id }}\\n\",\n              \"rightValue\": \"={{ $('Receive Message').item.json.message.message_id }}\"\n            }\n          ]\n        },\n        \"looseTypeValidation\": true\n      },\n      \"typeVersion\": 2.2\n    },\n    {\n      \"id\": \"bed86d81-bb57-42ce-aaa7-4bdc21e1651c\",\n      \"name\": \"AI Agent\",\n      \"type\": \"@n8n/n8n-nodes-langchain.agent\",\n      \"position\": [\n        420,\n        -700\n      ],\n      \"parameters\": {\n        \"text\": \"={{ $json.message.join(String.fromCharCode(10)) }}\",\n        \"options\": {},\n        \"promptType\": \"define\"\n      },\n      \"typeVersion\": 1.7\n    },\n    {\n      \"id\": \"4f468a14-fbea-44ec-a2b8-e4b3785c0362\",\n      \"name\": \"Postgres Chat Memory\",\n      \"type\": \"@n8n/n8n-nodes-langchain.memoryPostgresChat\",\n      \"position\": [\n        560,\n        -460\n      ],\n      \"parameters\": {\n        \"sessionKey\": \"={{ $('Receive Message').item.json.message.chat.id }}\",\n        \"sessionIdType\": \"customKey\"\n      },\n      \"credentials\": {\n        \"postgres\": {\n          \"id\": \"tzLXHvhykxvYghPC\",\n          \"name\": \"bsde.ai Supabase (Session Pooler)\"\n        }\n      },\n      \"typeVersion\": 1.3\n    },\n    {\n      \"id\": \"610516e8-d4ad-448e-ac97-17aad1a31862\",\n      \"name\": \"Sticky Note4\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -2420,\n        -820\n      ],\n      \"parameters\": {\n        \"width\": 700,\n        \"height\": 420,\n        \"content\": \"## Allow Users to Send a Sequence of Messages to an AI Agent in Telegram with Supabase\\n### Use Case\\nWhen creating chatbots that interface through applications such as **Telegram** and **WhatsApp**, users can often sends multiple shorter messages in quick succession, in place of a single, longer message. This workflow accounts for this behaviour.\\n### What it Does\\nThis workflow allows users to send several messages in quick succession, treating them as one coherent conversation instead of separate messages requiring individual responses. \\n### How it Works\\n1. When messages arrive, they are stored in a **Supabase PostgreSQL** table\\n2. The system waits briefly to see if additional messages arrive\\n3. If no new messages arrive within the waiting period, all queued messages are:\\n   - Combined and processed as a single conversation\\n   - Responded to with one unified reply\\n   - Deleted from the queue\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"c8bd8777-fb0f-4941-8674-f5bb7c264506\",\n      \"name\": \"Sticky Note5\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -1640,\n        -1060\n      ],\n      \"parameters\": {\n        \"width\": 520,\n        \"height\": 220,\n        \"content\": \"### Setup\\n1. Create a table in Supabase called **message_queue**. It needs to have the following columns: **user_id** (`uint8`), **message** (`text`), and **message_id** (`uint8`)\\n2. Add your **Telegram**, **Supabase**, **OpenAI**, and **PostgreSQL** credentials\\n3. Activate the workflow and test by sending multiple messages the Telegram bot in one go\\n4. Wait ten seconds after which you will receive a single reply to all of your messages\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"24604fc7-7957-4e20-8303-b31f2ce1e257\",\n      \"name\": \"Sticky Note6\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -1060,\n        -700\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 220,\n        \"height\": 280,\n        \"content\": \"### Modification\\nChange the value of *Wait Amount* to vary the buffering window\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"24f388f3-5655-4bd4-9c30-978efb2dc400\",\n      \"name\": \"Sticky Note8\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        180,\n        -480\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 340,\n        \"height\": 140,\n        \"content\": \"### Modification\\nReplace this sub-node \\nto use a different language\\n model\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"3db12526-6b97-4e3a-b53d-987f5d20c46e\",\n      \"name\": \"Sticky Note9\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        380,\n        -800\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 340,\n        \"height\": 240,\n        \"content\": \"### Modification\\nAdd a **System Message** to tailor the chatbot to your use case\"\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"active\": true,\n  \"pinData\": {},\n  \"settings\": {\n    \"callerPolicy\": \"workflowsFromSameOwner\",\n    \"executionOrder\": \"v1\"\n  },\n  \"versionId\": \"e415eb18-1bb9-426b-b759-0ba269db1f8f\",\n  \"connections\": {\n    \"AI Agent\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Reply\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Aggregate\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"AI Agent\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Receive Message\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Add to Queued Messages\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Wait 10 Seconds\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Queued Messages\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"OpenAI Chat Model\": {\n      \"ai_languageModel\": [\n        [\n          {\n            \"node\": \"AI Agent\",\n            \"type\": \"ai_languageModel\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Sort by Message ID\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Check Most Recent Message\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get Queued Messages\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Sort by Message ID\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Postgres Chat Memory\": {\n      \"ai_memory\": [\n        [\n          {\n            \"node\": \"AI Agent\",\n            \"type\": \"ai_memory\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Add to Queued Messages\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Wait 10 Seconds\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Delete Queued Messages\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Aggregate\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Check Most Recent Message\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Delete Queued Messages\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"No Operation, do nothing\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.telegram",
      "n8n-nodes-base.telegramTrigger",
      "n8n-nodes-base.wait",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.supabase",
      "n8n-nodes-base.noOp",
      "n8n-nodes-base.aggregate",
      "n8n-nodes-base.supabase",
      "n8n-nodes-base.stickyNote",
      "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "n8n-nodes-base.sort",
      "n8n-nodes-base.supabase",
      "n8n-nodes-base.if",
      "@n8n/n8n-nodes-langchain.agent",
      "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote"
    ],
    "trigger": null
  }
}