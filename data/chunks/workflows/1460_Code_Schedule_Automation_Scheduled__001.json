{
  "source": "1460_Code_Schedule_Automation_Scheduled.json",
  "index": 1,
  "content": "{\n  \"id\": \"G0hO05fypS8n8uYu\",\n  \"meta\": {\n    \"instanceId\": \"8fb286e504ea5ce6aeb12bf5c0c97ce11908b5b1aaa495ddfa0ef349661b832e\"\n  },\n  \"name\": \"INSEE Enrichment for Agile CRM\",\n  \"tags\": [],\n  \"nodes\": [\n    {\n      \"id\": \"a45b34c1-514e-4221-b363-abf2d4de43c4\",\n      \"name\": \"When clicking ‚ÄòTest workflow‚Äô\",\n      \"type\": \"n8n-nodes-base.manualTrigger\",\n      \"position\": [\n        -3440,\n        -320\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"d406941b-80a1-43a3-ba19-2e29570192f2\",\n      \"name\": \"Find Company in SIREN database\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"onError\": \"continueErrorOutput\",\n      \"position\": [\n        -2660,\n        -220\n      ],\n      \"parameters\": {\n        \"url\": \"=https://api.insee.fr/api-sirene/3.11/siren?q=periode(denominationUniteLegale:\\\"{{ $json.denominationUniteLegale }}\\\")\",\n        \"options\": {},\n        \"sendHeaders\": true,\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"accept\",\n              \"value\": \"application/json\"\n            },\n            {\n              \"name\": \"X-INSEE-Api-Key-Integration\",\n              \"value\": \"={{ $('Set Insee API Key').all()[0].json['X-INSEE-Api-Key-Integration']  }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2,\n      \"alwaysOutputData\": false\n    },\n    {\n      \"id\": \"6ab3818b-2f09-44e2-874a-87c51478572b\",\n      \"name\": \"Request all data from SIREN database\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        -2420,\n        -240\n      ],\n      \"parameters\": {\n        \"url\": \"=https://api.insee.fr/api-sirene/3.11/siret/{{ $json.unitesLegales[0].siren }}{{ $json.unitesLegales[0].periodesUniteLegale[0].nicSiegeUniteLegale }}\",\n        \"options\": {},\n        \"sendHeaders\": true,\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"accept\",\n              \"value\": \"application/json\"\n            },\n            {\n              \"name\": \"X-INSEE-Api-Key-Integration\",\n              \"value\": \"={{ $('Set Insee API Key').all()[0].json['X-INSEE-Api-Key-Integration']  }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"89c223fe-289b-4d0f-922a-e9c0ad672b51\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -3420,\n        -640\n      ],\n      \"parameters\": {\n        \"width\": 460,\n        \"height\": 240,\n        \"content\": \"### Enrich CRM data with data from French INSEE OpenDatabase API\\nThis workflow takes all company entries from **Agile CRM** and enriches their data using the French [Insee Opendata API](https://portail-api.insee.fr/) (Free Access)\\n\\n__This will update :__ \\n1) Official Address of the company headquarters\\n2) Add government company id number (SIREN) in a Custom Field\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"0bdc49dd-6f26-447f-a8ba-c2ba615dc7ec\",\n      \"name\": \"FilterOut all Company that have the ReadOnly Key set\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        -2880,\n        -220\n      ],\n      \"parameters\": {\n        \"jsCode\": \"// Get input data\\nconst input = $input.all();\\nconst output = input.filter(item => {\\n    const properties = item.json.properties || [];\\n    return !properties.some(property => property.name === \\\"RO\\\" && property.value === \\\"1\\\"); // Remove all ReadOnly entries\\n}).map(item => {\\n    const companyId = item.json.id;\\n    const denominationUniteLegale = item.json.properties[0]?.value || null; \\n    return {\\n        json: {\\n            companyId,\\n            denominationUniteLegale\\n        }\\n    };\\n});\\n\\n// Return the transformed output\\nreturn output;\\n\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"0ef184f7-219c-4eb3-bfe0-4e68d2ce0b43\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -2940,\n        -640\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 647,\n        \"height\": 232,\n        \"content\": \"### üë®‚Äçüé§ Setup\\n1. Add your **Agile CRM** credentials\\n2. Link each AgileCRM node to the correct **Agile CRM** credentials\\n3. Add your **INSEE** API Key to the **\\\"Set Insee API Key\\\"** node\\n4. Make sure the **Custom Fields** for the **companies** are set as below (Admin Settings):\\n   - Label : \\\"SIREN\\\", Type : \\\"Text Field\\\", Description \\\"N¬∞ de SIREN\\\"\\n   - Label : \\\"RO\\\", Type : \\\"Number\\\", Description \\\"Locks entry from update\\\"\\n5. Click on **Test Workflow** to make sure everything is working\\n6. Configure schedule if needed and don't forget to change status to **Active**\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"78255253-195d-472d-a76c-ab63ceac126b\",\n      \"name\": \"Set Insee API Key\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        -3260,\n        -220\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"e993e665-cf31-48b1-8ca8-a4829dc82642\",\n              \"name\": \"X-INSEE-Api-Key-Integration\",\n              \"type\": \"string\",\n              \"value\": \"put-your-insee-api-key-here\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"90b13481-6570-4bfc-b3dc-4b6017c6c8b5\",\n      \"name\": \"Schedule Trigger\",\n      \"type\": \"n8n-nodes-base.scheduleTrigger\",\n      \"position\": [\n        -3440,\n        -140\n      ],\n      \"parameters\": {\n        \"rule\": {\n          \"interval\": [\n            {}\n          ]\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"88c8a6c6-2175-42c3-bfdb-f1d32a5d1c2d\",\n      \"name\": \"clean_route\",\n      \"type\": \"n8n-nodes-base.noOp\",\n      \"position\": [\n        -2660,\n        -360\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"522d83f6-752e-40b4-a889-334f0a96998b\",\n      \"name\": \"Get all Compagnies from Agile CRM\",\n      \"type\": \"n8n-nodes-base.agileCrm\",\n      \"position\": [\n        -3080,\n        -220\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"resource\": \"company\",\n        \"operation\": \"getAll\"\n      },\n      \"credentials\": {\n        \"agileCrmApi\": {\n          \"id\": \"wb0EgiQFLQbiFuy4\",\n          \"name\": \"AgileCRM account\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"8ff0632b-6aca-47d8-b611-72dbc8dec09b\",\n      \"name\": \"Enrich CRM with INSEE Data\",\n      \"type\": \"n8n-nodes-base.agileCrm\",\n      \"position\": [\n        -1960,\n        -340\n      ],\n      \"parameters\": {\n        \"resource\": \"company\",\n        \"companyId\": \"={{ $json.companyId }}\",\n        \"operation\": \"update\",\n        \"additionalFields\": {\n          \"addressOptions\": {\n            \"addressProperties\": [\n              {\n                \"address\": \"={{ $json.etablissement.adresseEtablissement.complementAdresseEtablissement }}\\n{{ $json.etablissement.adresseEtablissement.typeVoieEtablissement }} {{ $json.etablissement.adresseEtablissement.libelleVoieEtablissement }}\\n{{ $json.etablissement.adresseEtablissement.codePostalEtablissement }}{{ $json.etablissement.adresseEtablissement.libelleCommuneEtablissement }}\",\n                \"subtype\": \"office\"\n              }\n            ]\n          },\n          \"customProperties\": {\n            \"customProperty\": [\n              {\n                \"name\": \"SIREN\",\n                \"value\": \"={{ $json.etablissement.siren }}\",\n                \"subtype\": \"TEXT\"\n              }\n            ]\n          }\n        }\n      },\n      \"credentials\": {\n        \"agileCrmApi\": {\n          \"id\": \"wb0EgiQFLQbiFuy4\",\n          \"name\": \"AgileCRM account\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"8720be96-8181-4ea7-b114-ce0f5b8e09c1\",\n      \"name\": \"Merge data from CRM and SIREN database with enriched for the CRM\",\n      \"type\": \"n8n-nodes-base.merge\",\n      \"position\": [\n        -2180,\n        -340\n      ],\n      \"parameters\": {\n        \"mode\": \"combine\",\n        \"options\": {},\n        \"advanced\": true,\n        \"mergeByFields\": {\n          \"values\": [\n            {\n              \"field1\": \"denominationUniteLegale\",\n              \"field2\": \"etablissement.uniteLegale.denominationUniteLegale\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3\n    },\n    {\n      \"id\": \"855a39e2-83ef-49d9-b630-ec31aaa96e72\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -3460,\n        20\n      ],\n      \"parameters\": {\n        \"height\": 80,\n        \"content\": \"üëÜ You can use any of those two Trigger to start the process.\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b003c1b8-6244-4b72-bbb0-025f563b5d71\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -2260,\n        -640\n      ],\n      \"parameters\": {\n        \"width\": 380,\n        \"height\": 240,\n        \"content\": \"### üóíÔ∏è Notes : \\n1. This workflow is made to write over any entry already present. You can change this for each company by setting the **\\\"RO\\\"** Custom Field to **1**, making it read-only for this workflow.\\n\\n2. If you want to make it readonly after the update from this workflow, then **add a custom property** in the last node **Enrich CRM with INSEE Data** named **\\\"RO\\\"**, SubType **\\\"Number\\\"** and Value **\\\"1\\\"**\"\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"active\": false,\n  \"pinData\": {},\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"versionId\": \"9f328182-d131-4300-a1f4-2cb3dfe91632\",\n  \"connections\": {\n    \"clean_route\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Merge data from CRM and SIREN database with enriched for the CRM\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Schedule Trigger\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Set Insee API Key\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Set Insee API Key\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get all Compagnies from Agile CRM\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Find Company in SIREN database\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Request all data from SIREN database\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get all Compagnies from Agile CRM\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"FilterOut all Company that have the ReadOnly Key set\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"When clicking ‚ÄòTest workflow‚Äô\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Set Insee API Key\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Request all data from SIREN database\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Merge data from CRM and SIREN database with enriched for the CRM\",\n            \"type\": \"main\",\n            \"index\": 1\n          }\n        ]\n      ]\n    },\n    \"FilterOut all Company that have the ReadOnly Key set\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Find Company in SIREN database\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"clean_route\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Merge data from CRM and SIREN database with enriched for the CRM\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Enrich CRM with INSEE Data\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.manualTrigger",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.code",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.set",
      "n8n-nodes-base.scheduleTrigger",
      "n8n-nodes-base.noOp",
      "n8n-nodes-base.agileCrm",
      "n8n-nodes-base.agileCrm",
      "n8n-nodes-base.merge",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote"
    ],
    "trigger": "schedule trigger"
  }
}