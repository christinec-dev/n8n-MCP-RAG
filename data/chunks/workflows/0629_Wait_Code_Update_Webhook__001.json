{
  "source": "0629_Wait_Code_Update_Webhook.json",
  "index": 1,
  "content": "{\n  \"nodes\": [\n    {\n      \"id\": \"0d911b91-bb9a-4177-8cd5-12ddddf1bc61\",\n      \"name\": \"When clicking ‘Test workflow’\",\n      \"type\": \"n8n-nodes-base.manualTrigger\",\n      \"position\": [\n        580,\n        405\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"d13f78f7-4093-435f-8b38-722f4a5c7a1f\",\n      \"name\": \"Loop Over Items\",\n      \"type\": \"n8n-nodes-base.splitInBatches\",\n      \"position\": [\n        1020,\n        405\n      ],\n      \"parameters\": {\n        \"options\": {}\n      },\n      \"typeVersion\": 3\n    },\n    {\n      \"id\": \"97d26220-a85f-4c40-b97c-b36f2d235776\",\n      \"name\": \"Webhook Callback Wait\",\n      \"type\": \"n8n-nodes-base.wait\",\n      \"position\": [\n        1720,\n        445\n      ],\n      \"webhookId\": \"5cd058b4-48c8-449a-9c09-959a5b8a2b48\",\n      \"parameters\": {\n        \"resume\": \"webhook\",\n        \"options\": {},\n        \"httpMethod\": \"POST\",\n        \"responseMode\": \"responseNode\"\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"ee02d5cb-8151-4b24-a630-77a677b1434a\",\n      \"name\": \"Update finishedSet\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        1940,\n        445\n      ],\n      \"parameters\": {\n        \"jsCode\": \"let json = $('If All Finished').first().json;\\nif (!json.finishedSet) json.finishedSet = [];\\nlet finishedItemId = $('Webhook Callback Wait').item.json.body.finishedItemId;\\nif (!json.finishedSet[finishedItemId]) json.finishedSet.push(finishedItemId);\\nreturn [json];\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"09f1cf3f-9e32-43f2-9e57-d7a33970dac4\",\n      \"name\": \"Initialize finishedSet\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1240,\n        285\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"193ab8f1-0e23-491c-914e-b8b26b0160f7\",\n              \"name\": \"finishedSet\",\n              \"type\": \"array\",\n              \"value\": \"[]\"\n            }\n          ]\n        }\n      },\n      \"executeOnce\": true,\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"105d8f64-8ade-4e02-8722-587a35f2b046\",\n      \"name\": \"Simulate Multi-Item for Parallel Processing\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        780,\n        405\n      ],\n      \"parameters\": {\n        \"jsCode\": \"return [\\n  {requestId: 'req4567'},\\n  {requestId: 'req8765'},\\n  {requestId: 'req1234'}\\n];\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"c5f72fa0-693e-4134-910f-8fd0767861d1\",\n      \"name\": \"If All Finished\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        1460,\n        285\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"version\": 1,\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"strict\"\n          },\n          \"combinator\": \"and\",\n          \"conditions\": [\n            {\n              \"id\": \"385c3149-3623-4dd2-9022-770c32f82421\",\n              \"operator\": {\n                \"type\": \"number\",\n                \"operation\": \"gte\"\n              },\n              \"leftValue\": \"={{ $json.finishedSet.length }}\",\n              \"rightValue\": \"={{ $('Simulate Multi-Item for Parallel Processing').all().length }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"20d16393-8573-4cc1-adc0-034f0f1def70\",\n      \"name\": \"Start Sub-Workflow via Webhook\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1180,\n        645\n      ],\n      \"parameters\": {\n        \"url\": \"={{ $env.WEBHOOK_URL }}/webhook/parallel-subworkflow-target\",\n        \"method\": \"POST\",\n        \"options\": {},\n        \"sendBody\": true,\n        \"sendHeaders\": true,\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"requestItemId\",\n              \"value\": \"={{ $json.requestId }}\"\n            }\n          ]\n        },\n        \"headerParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"callbackurl\",\n              \"value\": \"={{ $execution.resumeUrl }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"4ad48520-39b3-4016-a6a9-dd789c079e08\",\n      \"name\": \"Acknowledge Finished\",\n      \"type\": \"n8n-nodes-base.respondToWebhook\",\n      \"position\": [\n        1780,\n        665\n      ],\n      \"parameters\": {\n        \"options\": {}\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"ad1018a1-3b9d-4613-b23f-136763a514ba\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        720,\n        605\n      ],\n      \"parameters\": {\n        \"color\": 3,\n        \"width\": 390,\n        \"height\": 109,\n        \"content\": \"### Start Multiple Sub-Workflows Asynchronously\\n* Note: Callback/Webhook \\\"internal\\\" Base-URL should be configured in the n8n instance to reference the k8s service name and internal port.\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"f4171d39-8bfe-4e3a-9b94-87d969abda2d\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1740,\n        365\n      ],\n      \"parameters\": {\n        \"color\": 3,\n        \"width\": 283,\n        \"height\": 80,\n        \"content\": \"### Pseudo-Synchronously Wait for All Sub-Workflows to finish\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"98657cd3-968c-4d66-aea0-4e3180f8508f\",\n      \"name\": \"Continue Workflow (noop)\",\n      \"type\": \"n8n-nodes-base.noOp\",\n      \"position\": [\n        1780,\n        205\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"5a9518ea-456e-4975-bf6f-71bf9ed0a6e1\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        540,\n        180\n      ],\n      \"parameters\": {\n        \"width\": 1577.931818181817,\n        \"height\": 684.1818181818179,\n        \"content\": \"## Main/Parent Workflow\\n* This starts multiple executions of the sub-workflow in parallel and then loops until they all report back.\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"13ad3423-c3bf-4144-b76d-03daa8877bed\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        560,\n        900\n      ],\n      \"parameters\": {\n        \"width\": 1477.331211260329,\n        \"height\": 189.2194473140495,\n        \"content\": \"### Sub-Workflow\\n**Cut/Paste this into a separate workflow, and activate it!!!**\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"e92865b0-b3e9-4195-ae16-5c199875a04b\",\n      \"name\": \"Wait\",\n      \"type\": \"n8n-nodes-base.wait\",\n      \"position\": [\n        1440,\n        940\n      ],\n      \"webhookId\": \"2d62e5c2-ad4a-4e90-a075-7ca5212e015a\",\n      \"parameters\": {},\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"710456c8-394d-4c45-8d8e-16e0a4095dc3\",\n      \"name\": \"Call Resume on Parent Workflow\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"notes\": \"The callback resumes the parent workflow and reports which item finished.  There could be a race condition if the parent workflow was just resumed by a different sub-workflow but hasn't entered a webhook-wait again yet.  The delay and retry mitigates for the possibility that multiple subtasks complete and call back at once.\",\n      \"position\": [\n        1660,\n        940\n      ],\n      \"parameters\": {\n        \"url\": \"={{ $('Webhook').item.json.headers.callbackurl }}\",\n        \"method\": \"POST\",\n        \"options\": {},\n        \"sendBody\": true,\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"finishedItemId\",\n              \"value\": \"={{ $('Webhook').item.json.body.requestItemId }}\"\n            }\n          ]\n        }\n      },\n      \"retryOnFail\": true,\n      \"typeVersion\": 4.2,\n      \"waitBetweenTries\": 3000\n    },\n    {\n      \"id\": \"2ee41b1a-89f0-4d2f-b2ff-74aef5baaa70\",\n      \"name\": \"Respond to Webhook\",\n      \"type\": \"n8n-nodes-base.respondToWebhook\",\n      \"position\": [\n        1220,\n        940\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"respondWith\": \"json\",\n        \"responseBody\": \"={{ \\n{\\n  \\\"finishedItemId\\\": $json.body.requestItemId\\n}\\n}}\"\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"04445a9a-61f9-468e-8589-3eeb403f2553\",\n      \"name\": \"Webhook\",\n      \"type\": \"n8n-nodes-base.webhook\",\n      \"position\": [\n        1000,\n        940\n      ],\n      \"webhookId\": \"14776b45-77d7-4220-808f-2d0a38bec4de\",\n      \"parameters\": {\n        \"path\": \"parallel-subworkflow-target\",\n        \"options\": {},\n        \"httpMethod\": \"POST\",\n        \"responseMode\": \"responseNode\"\n      },\n      \"typeVersion\": 2\n    }\n  ],\n  \"pinData\": {},\n  \"connections\": {\n    \"Wait\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Call Resume on Parent Workflow\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Webhook\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Respond to Webhook\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"If All Finished\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Continue Workflow (noop)\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Webhook Callback Wait\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Loop Over Items\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Initialize finishedSet\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Start Sub-Workflow via Webhook\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Respond to Webhook\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Wait\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Update finishedSet\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Acknowledge Finished\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Acknowledge Finished\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"If All Finished\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Webhook Callback Wait\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Update finishedSet\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Initialize finishedSet\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"If All Finished\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Start Sub-Workflow via Webhook\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Loop Over Items\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"When clicking ‘Test workflow’\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Simulate Multi-Item for Parallel Processing\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Simulate Multi-Item for Parallel Processing\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Loop Over Items\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.manualTrigger",
      "n8n-nodes-base.splitInBatches",
      "n8n-nodes-base.wait",
      "n8n-nodes-base.code",
      "n8n-nodes-base.set",
      "n8n-nodes-base.code",
      "n8n-nodes-base.if",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.respondToWebhook",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.noOp",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.wait",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.respondToWebhook",
      "n8n-nodes-base.webhook"
    ],
    "trigger": null
  }
}