{
  "source": "1296_Datetime_Splitout_Process.json",
  "index": 1,
  "content": "{\n  \"id\": \"ATxZ5QYhdJq9mZDO\",\n  \"meta\": {\n    \"instanceId\": \"bdce9ec27bbe2b742054f01d034b8b468d2e7758edd716403ad5bd4583a8f649\",\n    \"templateCredsSetupCompleted\": true\n  },\n  \"name\": \"Parse DMARC reports\",\n  \"tags\": [\n    {\n      \"id\": \"w055QEEFrp6ZYNCr\",\n      \"name\": \"DevOps\",\n      \"createdAt\": \"2023-12-19T18:45:02.513Z\",\n      \"updatedAt\": \"2023-12-19T18:45:02.513Z\"\n    }\n  ],\n  \"nodes\": [\n    {\n      \"id\": \"ce9ce59c-3cf6-45db-97fc-825cb8516da8\",\n      \"name\": \"Email Trigger (IMAP)\",\n      \"type\": \"n8n-nodes-base.emailReadImap\",\n      \"position\": [\n        580,\n        300\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"downloadAttachments\": true\n      },\n      \"credentials\": {\n        \"imap\": {\n          \"id\": \"vx30lEB3JcemyffM\",\n          \"name\": \"IMAP account\"\n        }\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"903f949d-ab1e-48ec-a903-a1ebde4cfbe9\",\n      \"name\": \"End date format\",\n      \"type\": \"n8n-nodes-base.dateTime\",\n      \"position\": [\n        800,\n        880\n      ],\n      \"parameters\": {\n        \"date\": \"={{ $json.date_range_end.toDateTime('s') }}\",\n        \"format\": \"custom\",\n        \"options\": {\n          \"includeInputFields\": true\n        },\n        \"operation\": \"formatDate\",\n        \"customFormat\": \"yyyy-MM-dd hh:mm:ss\",\n        \"outputFieldName\": \"=date_range_end\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"3303e551-8557-4220-ab24-48fcb0859a26\",\n      \"name\": \"If multiple records to parse\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        560,\n        620\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"strict\"\n          },\n          \"combinator\": \"and\",\n          \"conditions\": [\n            {\n              \"id\": \"b809e758-c3d2-4cbf-bab8-54d278a435dd\",\n              \"operator\": {\n                \"type\": \"object\",\n                \"operation\": \"exists\",\n                \"singleValue\": true\n              },\n              \"leftValue\": \"={{ $json.feedback.record[0] }}\",\n              \"rightValue\": \"\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"513864bc-c124-452d-8be3-44feb73454ed\",\n      \"name\": \"Map fields for DB input and parse\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1200,\n        660\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"ignoreConversionErrors\": true\n        },\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"621508ee-fbea-4233-aaf3-96b573a60bd5\",\n              \"name\": \"full_data\",\n              \"type\": \"object\",\n              \"value\": \"={{ $json.feedback }}\"\n            },\n            {\n              \"id\": \"d605e93a-0e0a-4584-aa1e-e38b49f264e7\",\n              \"name\": \"org_name\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.feedback.report_metadata.org_name }}\"\n            },\n            {\n              \"id\": \"604a5573-67db-4bb6-80d8-4421dce2406b\",\n              \"name\": \"date_range_begin\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.feedback.report_metadata.date_range.begin }}\"\n            },\n            {\n              \"id\": \"b9d7244f-9d58-43fc-a477-f0750c31e5e2\",\n              \"name\": \"date_range_end\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.feedback.report_metadata.date_range.end }}\"\n            },\n            {\n              \"id\": \"3570869a-9dc9-4b20-b48c-5f382825d021\",\n              \"name\": \"domain\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.feedback.policy_published.domain }}\"\n            },\n            {\n              \"id\": \"979e4eb4-6e39-4a3c-8f0a-21ecf8086a3c\",\n              \"name\": \"policy_published\",\n              \"type\": \"object\",\n              \"value\": \"={{ $json.feedback.policy_published }}\"\n            },\n            {\n              \"id\": \"91cdfa19-49c6-4e5d-a423-d76bbb61eddc\",\n              \"name\": \"source_ip\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json['fbr'].row.source_ip }}\"\n            },\n            {\n              \"id\": \"2434b04e-3c5e-4e61-8be9-1f9c1ec2a6ce\",\n              \"name\": \"mail_count\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json['fbr'].row.count }}\"\n            },\n            {\n              \"id\": \"09b73b84-0f6a-443b-8da0-c7ad9742a9c1\",\n              \"name\": \"evaluated_disposition\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json['fbr'].row.policy_evaluated.disposition }}\"\n            },\n            {\n              \"id\": \"6c8e81ab-abc6-497c-8919-6b2e8008a1e8\",\n              \"name\": \"evaluated_dkim\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json['fbr'].row.policy_evaluated.dkim }}\"\n            },\n            {\n              \"id\": \"fa8ca9d6-5e1b-402c-9afc-e6bf42e2c6ad\",\n              \"name\": \"evaluated_spf\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json['fbr'].row.policy_evaluated.spf }}\"\n            },\n            {\n              \"id\": \"42f269c3-978a-45f6-bfe5-1fa1536500fb\",\n              \"name\": \"identifiers\",\n              \"type\": \"object\",\n              \"value\": \"={{ $json['fbr'].identifiers }}\"\n            },\n            {\n              \"id\": \"3375dc26-a739-4bf9-8a46-2f6739337921\",\n              \"name\": \"auth_results\",\n              \"type\": \"object\",\n              \"value\": \"={{ $json['fbr'].auth_results }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"00cca3ae-1f0a-4ea9-8fb7-ac52d35c261b\",\n      \"name\": \"Begin format date\",\n      \"type\": \"n8n-nodes-base.dateTime\",\n      \"position\": [\n        560,\n        880\n      ],\n      \"parameters\": {\n        \"date\": \"={{ $json.date_range_begin.toDateTime('s') }}\",\n        \"format\": \"custom\",\n        \"options\": {\n          \"includeInputFields\": true\n        },\n        \"operation\": \"formatDate\",\n        \"customFormat\": \"yyyy-MM-dd hh:mm:ss\",\n        \"outputFieldName\": \"=date_range_begin\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"18c2305a-db44-4e4d-97b9-1f04018085b0\",\n      \"name\": \"Input into database\",\n      \"type\": \"n8n-nodes-base.mySql\",\n      \"position\": [\n        620,\n        1100\n      ],\n      \"parameters\": {\n        \"table\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"dmarc\",\n          \"cachedResultName\": \"dmarc\"\n        },\n        \"options\": {\n          \"detailedOutput\": true\n        },\n        \"dataMode\": \"defineBelow\",\n        \"valuesToSend\": {\n          \"values\": [\n            {\n              \"value\": \"={{ $json.full_data.toJsonString() }}\",\n              \"column\": \"full_data\"\n            },\n            {\n              \"value\": \"={{ $json.org_name }}\",\n              \"column\": \"org_name\"\n            },\n            {\n              \"value\": \"={{ $json.date_range_begin }}\",\n              \"column\": \"date_range_begin\"\n            },\n            {\n              \"value\": \"={{ $json.date_range_end }}\",\n              \"column\": \"date_range_end\"\n            },\n            {\n              \"value\": \"={{ $json.domain }}\",\n              \"column\": \"domain\"\n            },\n            {\n              \"value\": \"={{ $json.policy_published.toJsonString() }}\",\n              \"column\": \"policy_published\"\n            },\n            {\n              \"value\": \"={{ $json.source_ip }}\",\n              \"column\": \"source_ip\"\n            },\n            {\n              \"value\": \"={{ $json.mail_count }}\",\n              \"column\": \"mail_count\"\n            },\n            {\n              \"value\": \"={{ $json.evaluated_disposition }}\",\n              \"column\": \"evaluated_disposition\"\n            },\n            {\n              \"value\": \"={{ $json.evaluated_dkim }}\",\n              \"column\": \"evaluated_dkim\"\n            },\n            {\n              \"value\": \"={{ $json.evaluated_spf }}\",\n              \"column\": \"evaluated_spf\"\n            },\n            {\n              \"value\": \"={{ $json.identifiers == null ? null : $json.identifiers.toJsonString() }}\",\n              \"column\": \"identifiers\"\n            },\n            {\n              \"value\": \"={{ $json.auth_results == null ? null : $json.auth_results.toJsonString() }}\",\n              \"column\": \"auth_results\"\n            }\n          ]\n        }\n      },\n      \"credentials\": {\n        \"mySql\": {\n          \"id\": \"HFwF4pL62FWEFHqR\",\n          \"name\": \"MySQL account\"\n        }\n      },\n      \"typeVersion\": 2.4\n    },\n    {\n      \"id\": \"c65c4cfb-3912-4b45-a5e0-3ab787e018c8\",\n      \"name\": \"If issue with DKIM or SPF\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        580,\n        1260\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"strict\"\n          },\n          \"combinator\": \"or\",\n          \"conditions\": [\n            {\n              \"id\": \"818b461b-4bdc-4842-9f89-d1d8966b8c0a\",\n              \"operator\": {\n                \"type\": \"string\",\n                \"operation\": \"notEquals\"\n              },\n              \"leftValue\": \"={{ $json.evaluated_dkim }}\",\n              \"rightValue\": \"pass\"\n            },\n            {\n              \"id\": \"4322cb26-5ff1-4278-94ae-7ff278c61c6c\",\n              \"operator\": {\n                \"type\": \"string\",\n                \"operation\": \"notEquals\"\n              },\n              \"leftValue\": \"={{ $json.evaluated_spf }}\",\n              \"rightValue\": \"pass\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"5d17bf15-ecef-40e8-acc4-6af5ad1c712d\",\n      \"name\": \"Rename Keys\",\n      \"type\": \"n8n-nodes-base.renameKeys\",\n      \"position\": [\n        1000,\n        500\n      ],\n      \"parameters\": {\n        \"keys\": {\n          \"key\": [\n            {\n              \"newKey\": \"fbr\",\n              \"currentKey\": \"feedback.record\"\n            }\n          ]\n        },\n        \"additionalOptions\": {}\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"0e2b8c73-0f53-46f9-9692-cbe87c97862d\",\n      \"name\": \"Rename column for consistency\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        800,\n        660\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"f563d673-bc82-4863-b132-d431ebe8f651\",\n              \"name\": \"fbr\",\n              \"type\": \"object\",\n              \"value\": \"={{ $json.feedback.record }}\"\n            }\n          ]\n        },\n        \"includeOtherFields\": true\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"5796c124-645d-460e-88df-0a909a33b6b1\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        100,\n        300\n      ],\n      \"parameters\": {\n        \"width\": 394.2691415313225,\n        \"height\": 304.36194895591655,\n        \"content\": \"## How it works\\n- monitor postmaster email for DKIM reprots\\n- unpack report and parse XML\\n- map and format fields for DB input\\n\\t- input into database\\n\\t- send notification on DKIM or SPF failure\\n\\n## Remember to set up\\n- email input mailbox\\n- notification channels\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"1457272e-630e-44ee-bb18-ac650d192cbf\",\n      \"name\": \"Unzip File\",\n      \"type\": \"n8n-nodes-base.compression\",\n      \"position\": [\n        800,\n        300\n      ],\n      \"parameters\": {\n        \"binaryPropertyName\": \"attachment_0\"\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"89ade90c-c7e3-4c6f-89cf-0e7ce1e55333\",\n      \"name\": \"Extract XML data\",\n      \"type\": \"n8n-nodes-base.extractFromFile\",\n      \"position\": [\n        1020,\n        300\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"operation\": \"xml\",\n        \"binaryPropertyName\": \"file_0\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"8fd70f3c-53d5-4d99-ad2c-d526089fe0f5\",\n      \"name\": \"Parse XML data to JSON\",\n      \"type\": \"n8n-nodes-base.xml\",\n      \"position\": [\n        1220,\n        300\n      ],\n      \"parameters\": {\n        \"options\": {}\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b17352d9-135a-4c26-993f-0c1fdafc1fa3\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1420,\n        300\n      ],\n      \"parameters\": {\n        \"width\": 394.2691415313225,\n        \"height\": 159.80531276753783,\n        \"content\": \"## Preparation\\nThis line is responsible for taking data from email and parsing it into JSON understandable by n8n\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"31d2f822-aea6-41b4-bb1e-25b48cb3e972\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1420,\n        500\n      ],\n      \"parameters\": {\n        \"width\": 394.2691415313225,\n        \"height\": 316.3177609714967,\n        \"content\": \"## Mapping\\nThis line is responsible for treating cases when XML has multiple info for domain. One DMARC report can contain more than one entries.\\n\\nLast node is responsible for matching data with database structure\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"e8fc0f91-1bdf-4bc5-b488-4f2c169da9c0\",\n      \"name\": \"Split Out For Separate Entries\",\n      \"type\": \"n8n-nodes-base.splitOut\",\n      \"position\": [\n        800,\n        500\n      ],\n      \"parameters\": {\n        \"include\": \"allOtherFields\",\n        \"options\": {},\n        \"fieldToSplitOut\": \"feedback.record\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"9ba7a0b8-80e6-4559-83ec-894533194dc7\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1420,\n        860\n      ],\n      \"parameters\": {\n        \"width\": 394.2691415313225,\n        \"height\": 185.89072080153096,\n        \"content\": \"## Date translate\\nThis line is responsible for translating date format into understandable by MySQL/MariaDB\\n\\nIn next node data is being input into MySQL/MariaDB \"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"96461e30-87f0-48f1-a43f-60185ea1d835\",\n      \"name\": \"Sticky Note4\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1420,\n        1180\n      ],\n      \"parameters\": {\n        \"width\": 394.2691415313225,\n        \"height\": 320.66532897716223,\n        \"content\": \"## Notifications\\nLast two nodes are responsible for sending notifications in case IF inside DMARC report is reported any issue with SPF or DKIM\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"192b95c6-cdfe-4b5e-94e1-94deb728b0e2\",\n      \"name\": \"Slack Post Message On Channel\",\n      \"type\": \"n8n-nodes-base.slack\",\n      \"disabled\": true,\n      \"position\": [\n        1200,\n        1180\n      ],\n      \"parameters\": {\n        \"text\": \"=DMARC evaluation failed for {{ $json.domain }} on  {{ $json.mail_count }} mails with disposition:  {{ $json.evaluated_disposition }}. DKIM:  {{ $json.evaluated_dkim }} SPF:  {{ $json.evaluated_spf }}\",\n        \"select\": \"channel\",\n        \"channelId\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"CCGJA1F1N\",\n          \"cachedResultName\": \"powiadomienia\"\n        },\n        \"otherOptions\": {},\n        \"authentication\": \"oAuth2\"\n      },\n      \"credentials\": {\n        \"slackOAuth2Api\": {\n          \"id\": \"B0jUtT53pVAEPaQM\",\n          \"name\": \"Slack Oauth\"\n        }\n      },\n      \"typeVersion\": 2.2\n    },\n    {\n      \"id\": \"ce400c97-cae4-41db-ad8f-e678fc4a27fe\",\n      \"name\": \"Send Error Notification Email\",\n      \"type\": \"n8n-nodes-base.emailSend\",\n      \"disabled\": true,\n      \"position\": [\n        1200,\n        1380\n      ],\n      \"parameters\": {\n        \"text\": \"DMARC evaluation failed for {{ $json.domain }} on  {{ $json.mail_count }} mails with disposition:  {{ $json.evaluated_disposition }}. DKIM:  {{ $json.evaluated_dkim }} SPF:  {{ $json.evaluated_spf }}\",\n        \"options\": {},\n        \"subject\": \"DMARC problem\",\n        \"emailFormat\": \"text\"\n      },\n      \"typeVersion\": 2.1\n    }\n  ],\n  \"active\": true,\n  \"pinData\": {},\n  \"settings\": {\n    \"callerPolicy\": \"workflowsFromSameOwner\",\n    \"errorWorkflow\": \"5\",\n    \"executionOrder\": \"v1\",\n    \"saveManualExecutions\": true,\n    \"saveExecutionProgress\": true,\n    \"saveDataSuccessExecution\": \"all\"\n  },\n  \"versionId\": \"1add308c-4aef-4a83-a958-bc66dead234f\",\n  \"connections\": {\n    \"Unzip File\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract XML data\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Rename Keys\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Map fields for DB input and parse\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"End date format\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Input into database\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"If issue with DKIM or SPF\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Extract XML data\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Parse XML data to JSON\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Begin format date\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"End date format\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Email Trigger (IMAP)\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Unzip File\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Parse XML data to JSON\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"If multiple records to parse\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"If issue with DKIM or SPF\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Slack Post Message On Channel\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Send Error Notification Email\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"If multiple records to parse\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Split Out For Separate Entries\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Rename column for consistency\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Rename column for consistency\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Map fields for DB input and parse\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Split Out For Separate Entries\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Rename Keys\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Map fields for DB input and parse\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Begin format date\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.emailReadImap",
      "n8n-nodes-base.dateTime",
      "n8n-nodes-base.if",
      "n8n-nodes-base.set",
      "n8n-nodes-base.dateTime",
      "n8n-nodes-base.mySql",
      "n8n-nodes-base.if",
      "n8n-nodes-base.renameKeys",
      "n8n-nodes-base.set",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.compression",
      "n8n-nodes-base.extractFromFile",
      "n8n-nodes-base.xml",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.splitOut",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.slack",
      "n8n-nodes-base.emailSend"
    ],
    "trigger": "email trigger (imap)"
  }
}