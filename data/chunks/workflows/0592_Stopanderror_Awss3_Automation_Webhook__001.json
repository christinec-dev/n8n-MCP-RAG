{
  "source": "0592_Stopanderror_Awss3_Automation_Webhook.json",
  "index": 1,
  "content": "{\n  \"meta\": {\n    \"instanceId\": \"9e331a89ae45a204c6dee51c77131d32a8c962ec20ccf002135ea60bd285dba9\"\n  },\n  \"nodes\": [\n    {\n      \"id\": \"d72750fc-6415-4da6-977a-46d025a91ef9\",\n      \"name\": \"When clicking ‚ÄòTest workflow‚Äô\",\n      \"type\": \"n8n-nodes-base.manualTrigger\",\n      \"position\": [\n        -900,\n        900\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b00e7434-f83e-438e-a47b-12d4a2c4fe5b\",\n      \"name\": \"List Invoices\",\n      \"type\": \"n8n-nodes-base.splitOut\",\n      \"position\": [\n        180,\n        900\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"fieldToSplitOut\": \"data\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"c142f60b-dbbd-444a-b39b-365e9eb1ff58\",\n      \"name\": \"Inject s3 Subpath\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        820,\n        640\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"dca623a6-834c-440f-990a-25bfd9afa2b3\",\n              \"name\": \"_s3_year\",\n              \"type\": \"string\",\n              \"value\": \"={{ DateTime.fromSeconds($json.created).format(\\\"yyyy\\\") }}\"\n            },\n            {\n              \"id\": \"55ab18e0-b2ef-486d-898d-97f671d5049b\",\n              \"name\": \"_s3_folder\",\n              \"type\": \"string\",\n              \"value\": \"={{ $(\\\"Clean and Escape ENV\\\").first().json.subFolder }}\"\n            },\n            {\n              \"id\": \"7f998728-a70e-4495-8d34-3ba72a71986b\",\n              \"name\": \"_s3_month\",\n              \"type\": \"string\",\n              \"value\": \"={{ DateTime.fromSeconds($json.created).format(\\\"MM\\\") }}\"\n            }\n          ]\n        },\n        \"includeOtherFields\": true\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"4cdd4338-7225-442b-8df6-44bebfe6d5e9\",\n      \"name\": \"Set-Subpath\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1000,\n        640\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"f2969361-8ed9-453b-8c71-e5b3c962af20\",\n              \"name\": \"_s3_path\",\n              \"type\": \"string\",\n              \"value\": \"={{ ($json._s3_folder ? $json._s3_folder+\\\"/\\\" : \\\"\\\")+$json._s3_year+\\\"/\\\"+$json._s3_month+\\\"/\\\"+$binary.data.fileName  }}\"\n            }\n          ]\n        },\n        \"includeOtherFields\": true\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"4965110b-0516-4a5d-9b04-8ccbb337f9d5\",\n      \"name\": \"We do only Invoice Objects\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        360,\n        900\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"strict\"\n          },\n          \"combinator\": \"and\",\n          \"conditions\": [\n            {\n              \"id\": \"2bdd8550-526c-4833-872e-b1028019a88a\",\n              \"operator\": {\n                \"name\": \"filter.operator.equals\",\n                \"type\": \"string\",\n                \"operation\": \"equals\"\n              },\n              \"leftValue\": \"={{ $json.object }}\",\n              \"rightValue\": \"invoice\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"def30f79-593f-48b3-b46f-29c5329a59ae\",\n      \"name\": \"It shouldn't be something else\",\n      \"type\": \"n8n-nodes-base.stopAndError\",\n      \"position\": [\n        580,\n        1042.3086136912689\n      ],\n      \"parameters\": {\n        \"errorMessage\": \"Unexpected or missing Invoice Obj\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"927c4bbd-5a57-4929-aebb-b187690108ac\",\n      \"name\": \"ENV*\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        -500,\n        900\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"b2927be9-2b00-4ab8-8938-56b1a0c2e134\",\n              \"name\": \"year\",\n              \"type\": \"number\",\n              \"value\": \"={{ $now.minus(1,\\\"month\\\").format(\\\"yyyy\\\") }}\"\n            },\n            {\n              \"id\": \"89e0c6ee-7b67-405a-b933-5a511cdea94b\",\n              \"name\": \"month\",\n              \"type\": \"number\",\n              \"value\": \"={{ $now.minus(1,\\\"month\\\").format(\\\"MM\\\") }}\"\n            },\n            {\n              \"id\": \"35a218d2-cd20-4388-8bc6-926752289df5\",\n              \"name\": \"subFolder\",\n              \"type\": \"string\",\n              \"value\": \"invoices\"\n            },\n            {\n              \"id\": \"7d18829a-018d-4814-987e-cdbee04896b3\",\n              \"name\": \"bucketName\",\n              \"type\": \"string\",\n              \"value\": \"myBucket\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"dd75af83-6e0a-4685-a3bd-1622e2c800de\",\n      \"name\": \"Download Invoice PDF from Stripe\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        580,\n        640\n      ],\n      \"parameters\": {\n        \"url\": \"={{ $json.invoice_pdf }}\",\n        \"options\": {}\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"30c4090d-043c-4b3b-b86c-df1e10544b2e\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -600,\n        802.3086136912689\n      ],\n      \"parameters\": {\n        \"color\": 4,\n        \"width\": 305.7072653471566,\n        \"height\": 670.9306322684054,\n        \"content\": \"## üëá  Configure here\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n`folderName` *(optional)* = Subfolder for your Invoices, otherwise it will create in root. e.g: \\\"invoices\\\"\\n\\n`bucketName` *(required)* = the S3 Bucket Name, where invoices will be synced in\\n\\n`year` (automatic or hardcore) = \\nthe expression makes sure it will be exporting \\\"last month\\\". Or define a custom year for manual export.\\n\\n`month` (automatic or hardcore) = \\nthe expression makes sure it will be exporting \\\"last month\\\". Or define a custom month for manual export.\\n\\n\\n**EVERYTHING** greater then the **provided date** will be exported. The Day will be always the first of month.\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"4134f369-84de-4019-a014-1d823ec77668\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        780,\n        480\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 362.3514596119466,\n        \"height\": 336.03175807685056,\n        \"content\": \"## Build Pathes\\n\\n*yourFolder/invoiceYear/invoiceMonth/fileName*\\n\\ne.g.: invoices/2024/12/invoice-number-123.pdf\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"c8ecef82-ef73-4920-b9fa-16220009f7d9\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1203.398651655887,\n        482.2657677705912\n      ],\n      \"parameters\": {\n        \"width\": 283.04958764124035,\n        \"height\": 329.9325827943702,\n        \"content\": \"## Upload to Bucket\\n\\n**‚ö†Ô∏è You might want to check Storage Class, ACL, etc.**\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"a0505cc0-8312-46f2-970d-bfabff881ced\",\n      \"name\": \"Every Month the First Day of the Month\",\n      \"type\": \"n8n-nodes-base.scheduleTrigger\",\n      \"position\": [\n        -900,\n        1102.3086136912689\n      ],\n      \"parameters\": {\n        \"rule\": {\n          \"interval\": [\n            {\n              \"field\": \"months\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"53ee7468-f478-4c10-8767-1aa7967b3225\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -100,\n        820\n      ],\n      \"parameters\": {\n        \"width\": 232,\n        \"height\": 256,\n        \"content\": \"### Use Stripe Predefined Credential\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"6055b93d-0462-4d1a-974a-7d31143e6b79\",\n      \"name\": \"Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -1360,\n        780\n      ],\n      \"parameters\": {\n        \"width\": 367.15098241985504,\n        \"height\": 485.66522445338995,\n        \"content\": \"## Instructions\\n\\nThis automation syncs monthly your Invoice PDF from Stripe to a (AWS) S3 Bucket of your choice with the following subPaths (Key):\\n\\n*yourFolder/invoiceYear/invoiceMonth/fileName*\\n\\n\\nFill in your **Credentials and Settings** in the Nodes marked with _\\\"*\\\"_.\\n\\nYou can adjust this Workflow to your needs. You can also override the `year`and `month` in the ENV* Node for manual syncs.\\n\\n![Image](https://let-the-work-flow.com/logo-64.png)\\nEnjoy the Workflow! ‚ù§Ô∏è \\nhttps://let-the-work-flow.com\\nWorkflow Automation & Development\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"c5e5946c-c74f-435f-9664-491bbbca00f2\",\n      \"name\": \"Get all Invoices*\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        -40,\n        900\n      ],\n      \"parameters\": {\n        \"url\": \"https://api.stripe.com/v1/invoices\",\n        \"options\": {},\n        \"sendQuery\": true,\n        \"authentication\": \"predefinedCredentialType\",\n        \"queryParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"limit\",\n              \"value\": \"100\"\n            },\n            {\n              \"name\": \"created[gte]\",\n              \"value\": \"={{ DateTime.fromISO($json.year+\\\"-\\\"+$json.month+\\\"-01T00:00:00\\\").toSeconds() }}\"\n            }\n          ]\n        },\n        \"nodeCredentialType\": \"stripeApi\"\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"5ed183d2-3001-40ef-9dc6-897c6789209a\",\n      \"name\": \"Upload to S3 Bucket*\",\n      \"type\": \"n8n-nodes-base.awsS3\",\n      \"position\": [\n        1280,\n        640\n      ],\n      \"parameters\": {\n        \"fileName\": \"={{ $json._s3_path }}\",\n        \"operation\": \"upload\",\n        \"bucketName\": \"={{ $(\\\"Clean and Escape ENV\\\").first().json.bucketName }}\",\n        \"additionalFields\": {\n          \"storageClass\": \"intelligentTiering\"\n        }\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"04b57622-64b2-4c62-b84b-61d49c3171fb\",\n      \"name\": \"Clean and Escape ENV\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        -240,\n        900\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"2d053eee-92a2-44ee-ad34-b1ad87728285\",\n              \"name\": \"bucketName\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.bucketName.trim().replace(/\\\\\\\\/g, '')  }}\"\n            },\n            {\n              \"id\": \"ccd36bf6-91f3-44af-8b57-3002041c9829\",\n              \"name\": \"subFolder\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.subFolder.trim().replace(/\\\\\\\\/g, '')  }}\"\n            },\n            {\n              \"id\": \"0fb9451f-afc1-4b70-9ec3-f3ac7187c2db\",\n              \"name\": \"month\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.month.toString().padStart(2,\\\"0\\\") }}\"\n            },\n            {\n              \"id\": \"eda1110d-329b-4d12-a089-253ac189aea4\",\n              \"name\": \"year\",\n              \"type\": \"number\",\n              \"value\": \"={{ parseInt($json.year) }}\"\n            }\n          ]\n        },\n        \"includeOtherFields\": true\n      },\n      \"typeVersion\": 3.4\n    }\n  ],\n  \"pinData\": {},\n  \"connections\": {\n    \"ENV*\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Clean and Escape ENV\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Set-Subpath\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Upload to S3 Bucket*\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"List Invoices\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"We do only Invoice Objects\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get all Invoices*\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"List Invoices\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Inject s3 Subpath\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Set-Subpath\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Clean and Escape ENV\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get all Invoices*\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"We do only Invoice Objects\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Download Invoice PDF from Stripe\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"It shouldn't be something else\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Download Invoice PDF from Stripe\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Inject s3 Subpath\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"When clicking ‚ÄòTest workflow‚Äô\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"ENV*\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Every Month the First Day of the Month\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"ENV*\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.manualTrigger",
      "n8n-nodes-base.splitOut",
      "n8n-nodes-base.set",
      "n8n-nodes-base.set",
      "n8n-nodes-base.if",
      "n8n-nodes-base.stopAndError",
      "n8n-nodes-base.set",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.scheduleTrigger",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.awsS3",
      "n8n-nodes-base.set"
    ],
    "trigger": null
  }
}