{
  "source": "0193_Nocodb_Telegram_Create_Webhook.json",
  "index": 1,
  "content": "{\n  \"nodes\": [\n    {\n      \"name\": \"chatID\",\n      \"type\": \"n8n-nodes-base.function\",\n      \"notes\": \"username and language\",\n      \"position\": [\n        -100,\n        680\n      ],\n      \"parameters\": {\n        \"functionCode\": \"// Telegram uses the following language codes: https://en.wikipedia.org/wiki/IETF_language_tag\\r\\n\\r\\nvar data = $node[\\\"Telegram Trigger\\\"].json;\\r\\nconst botlang = [\\\"ru\\\", \\\"en\\\"]; // Update this after adding new language in the dictionary\\r\\n\\r\\n// Assign the default language if the translation is not yet ready\\r\\nvar curlang = botlang.includes(data.message.from.language_code) ? data.message.from.language_code : \\\"en\\\";\\r\\n\\r\\nreturn [{json: {chatID  : data.message.chat.id,\\r\\n                lang    : curlang\\r\\n}}];\"\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Merge\",\n      \"type\": \"n8n-nodes-base.merge\",\n      \"notes\": \"Wait for dictionary to load\",\n      \"position\": [\n        480,\n        460\n      ],\n      \"parameters\": {\n        \"mode\": \"passThrough\"\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Switch\",\n      \"type\": \"n8n-nodes-base.switch\",\n      \"notes\": \"check bot commands\",\n      \"position\": [\n        620,\n        460\n      ],\n      \"parameters\": {\n        \"rules\": {\n          \"rules\": [\n            {\n              \"value2\": \"/start\"\n            },\n            {\n              \"output\": 1,\n              \"value2\": \"/help\"\n            }\n          ]\n        },\n        \"value1\": \"={{$node[\\\"Merge\\\"].json[\\\"message\\\"][\\\"text\\\"]}}\",\n        \"dataType\": \"string\",\n        \"fallbackOutput\": 3\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"IF\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        940,\n        300\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"boolean\": [\n            {\n              \"value1\": \"={{$json[\\\"empty\\\"]}}\",\n              \"value2\": \"={{true}}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1,\n      \"alwaysOutputData\": false\n    },\n    {\n      \"name\": \"msg_greet\",\n      \"type\": \"n8n-nodes-base.telegram\",\n      \"position\": [\n        1260,\n        220\n      ],\n      \"parameters\": {\n        \"text\": \"={{$evaluateExpression($node[\\\"botmessages\\\"].json[\\\"greeting\\\"][$node[\\\"chatID\\\"].json[\\\"lang\\\"]])}}\",\n        \"chatId\": \"={{$node[\\\"Telegram Trigger\\\"].json[\\\"message\\\"][\\\"chat\\\"][\\\"id\\\"]}}\",\n        \"additionalFields\": {}\n      },\n      \"credentials\": {\n        \"telegramApi\": {\n          \"id\": \"12\",\n          \"name\": \"n8n multilang bot\"\n        }\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"msg_welcomeback\",\n      \"type\": \"n8n-nodes-base.telegram\",\n      \"position\": [\n        1260,\n        380\n      ],\n      \"parameters\": {\n        \"text\": \"={{$evaluateExpression($node[\\\"botmessages\\\"].json[\\\"welcomeback\\\"][$node[\\\"chatID\\\"].json[\\\"lang\\\"]])}}\",\n        \"chatId\": \"={{$node[\\\"Telegram Trigger\\\"].json[\\\"message\\\"][\\\"chat\\\"][\\\"id\\\"]}}\",\n        \"additionalFields\": {}\n      },\n      \"credentials\": {\n        \"telegramApi\": {\n          \"id\": \"12\",\n          \"name\": \"n8n multilang bot\"\n        }\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"msg_help\",\n      \"type\": \"n8n-nodes-base.telegram\",\n      \"position\": [\n        1260,\n        540\n      ],\n      \"parameters\": {\n        \"text\": \"={{$evaluateExpression($node[\\\"botmessages\\\"].json[\\\"help\\\"][$node[\\\"chatID\\\"].json[\\\"lang\\\"]])}}\",\n        \"chatId\": \"={{$node[\\\"Telegram Trigger\\\"].json[\\\"message\\\"][\\\"chat\\\"][\\\"id\\\"]}}\",\n        \"additionalFields\": {\n          \"parse_mode\": \"Markdown\"\n        }\n      },\n      \"credentials\": {\n        \"telegramApi\": {\n          \"id\": \"12\",\n          \"name\": \"n8n multilang bot\"\n        }\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"msg_wrongcommand\",\n      \"type\": \"n8n-nodes-base.telegram\",\n      \"position\": [\n        1260,\n        700\n      ],\n      \"parameters\": {\n        \"text\": \"={{$evaluateExpression($node[\\\"botmessages\\\"].json[\\\"wrongcommand\\\"][$node[\\\"chatID\\\"].json[\\\"lang\\\"]])}}\",\n        \"chatId\": \"={{$node[\\\"Telegram Trigger\\\"].json[\\\"message\\\"][\\\"chat\\\"][\\\"id\\\"]}}\",\n        \"additionalFields\": {}\n      },\n      \"credentials\": {\n        \"telegramApi\": {\n          \"id\": \"12\",\n          \"name\": \"n8n multilang bot\"\n        }\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"New user?\",\n      \"type\": \"n8n-nodes-base.function\",\n      \"position\": [\n        780,\n        300\n      ],\n      \"parameters\": {\n        \"functionCode\": \"return [{json: {empty: Object.keys($node[\\\"CheckUser\\\"].json).length == 0}}];\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"CheckUser\",\n      \"type\": \"n8n-nodes-base.nocoDb\",\n      \"position\": [\n        380,\n        680\n      ],\n      \"parameters\": {\n        \"table\": \"TG_users\",\n        \"options\": {\n          \"where\": \"=(TG_account_ID,eq,{{$node[\\\"chatID\\\"].json[\\\"chatID\\\"]}})\"\n        },\n        \"operation\": \"getAll\",\n        \"projectId\": \"n8n_multilang_bot_wzhb\"\n      },\n      \"credentials\": {\n        \"nocoDb\": {\n          \"id\": \"13\",\n          \"name\": \"NocoDB n8n multilang bot\"\n        }\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1,\n      \"alwaysOutputData\": true\n    },\n    {\n      \"name\": \"LoadDictionary\",\n      \"type\": \"n8n-nodes-base.nocoDb\",\n      \"position\": [\n        60,\n        680\n      ],\n      \"parameters\": {\n        \"table\": \"botmessages\",\n        \"options\": {},\n        \"operation\": \"getAll\",\n        \"projectId\": \"n8n_multilang_bot_wzhb\",\n        \"returnAll\": true\n      },\n      \"credentials\": {\n        \"nocoDb\": {\n          \"id\": \"13\",\n          \"name\": \"NocoDB n8n multilang bot\"\n        }\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1,\n      \"alwaysOutputData\": true\n    },\n    {\n      \"name\": \"botmessages\",\n      \"type\": \"n8n-nodes-base.function\",\n      \"position\": [\n        220,\n        680\n      ],\n      \"parameters\": {\n        \"functionCode\": \"\\nlet data = {};\\n\\nfor (item of items) {\\n  data[item.json.botmessage]=item.json;\\n}\\n\\nreturn data;\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Telegram Trigger\",\n      \"type\": \"n8n-nodes-base.telegramTrigger\",\n      \"position\": [\n        240,\n        460\n      ],\n      \"webhookId\": \"21dac5fa-6e6b-43a0-b099-4f57537d2271\",\n      \"parameters\": {\n        \"updates\": [\n          \"message\"\n        ],\n        \"additionalFields\": {}\n      },\n      \"credentials\": {\n        \"telegramApi\": {\n          \"id\": \"12\",\n          \"name\": \"n8n multilang bot\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"HTTP AddUser\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1100,\n        220\n      ],\n      \"parameters\": {\n        \"url\": \"https://database.digigin.eu/api/v1/db/data/noco/n8n_multilang_bot_wzhb/TG_users\",\n        \"options\": {\n          \"bodyContentType\": \"json\"\n        },\n        \"requestMethod\": \"POST\",\n        \"authentication\": \"headerAuth\",\n        \"bodyParametersUi\": {\n          \"parameter\": [\n            {\n              \"name\": \"TG_account_ID\",\n              \"value\": \"={{$node[\\\"chatID\\\"].json[\\\"chatID\\\"]}}\"\n            },\n            {\n              \"name\": \"Last_language_used\",\n              \"value\": \"={{$node[\\\"Telegram Trigger\\\"].json[\\\"message\\\"][\\\"from\\\"][\\\"language_code\\\"]}}\"\n            }\n          ]\n        }\n      },\n      \"credentials\": {\n        \"httpHeaderAuth\": {\n          \"id\": \"21\",\n          \"name\": \"Header Auth NocoDB\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"HTTP UpdateUser\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1100,\n        380\n      ],\n      \"parameters\": {\n        \"url\": \"=https://database.digigin.eu/api/v1/db/data/noco/n8n_multilang_bot_wzhb/TG_users/{{$node[\\\"CheckUser\\\"].json[\\\"id\\\"]}}\",\n        \"options\": {\n          \"bodyContentType\": \"json\"\n        },\n        \"requestMethod\": \"PATCH\",\n        \"authentication\": \"headerAuth\",\n        \"bodyParametersUi\": {\n          \"parameter\": [\n            {\n              \"name\": \"TG_account_ID\",\n              \"value\": \"={{$node[\\\"chatID\\\"].json[\\\"chatID\\\"]}}\"\n            },\n            {\n              \"name\": \"Last_language_used\",\n              \"value\": \"={{$node[\\\"Telegram Trigger\\\"].json[\\\"message\\\"][\\\"from\\\"][\\\"language_code\\\"]}}\"\n            }\n          ]\n        }\n      },\n      \"credentials\": {\n        \"httpHeaderAuth\": {\n          \"id\": \"21\",\n          \"name\": \"Header Auth NocoDB\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"AddUser\",\n      \"type\": \"n8n-nodes-base.nocoDb\",\n      \"disabled\": true,\n      \"position\": [\n        1460,\n        220\n      ],\n      \"parameters\": {\n        \"table\": \"TG_users\",\n        \"fieldsUi\": {\n          \"fieldValues\": [\n            {\n              \"fieldName\": \"TG_account_ID\",\n              \"fieldValue\": \"={{$node[\\\"chatID\\\"].json[\\\"chatID\\\"]}}\"\n            },\n            {\n              \"fieldName\": \"Last_language_used\",\n              \"fieldValue\": \"={{$node[\\\"Telegram Trigger\\\"].json[\\\"message\\\"][\\\"from\\\"][\\\"language_code\\\"]}}\"\n            }\n          ]\n        },\n        \"operation\": \"create\",\n        \"projectId\": \"n8n_multilang_bot_wzhb\"\n      },\n      \"credentials\": {\n        \"nocoDb\": {\n          \"id\": \"13\",\n          \"name\": \"NocoDB n8n multilang bot\"\n        }\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"UpdateUser\",\n      \"type\": \"n8n-nodes-base.nocoDb\",\n      \"disabled\": true,\n      \"position\": [\n        1460,\n        380\n      ],\n      \"parameters\": {\n        \"id\": \"={{$node[\\\"CheckUser\\\"].json[\\\"id\\\"]}}\",\n        \"table\": \"TG_users\",\n        \"fieldsUi\": {\n          \"fieldValues\": [\n            {\n              \"fieldName\": \"TG_account_ID\",\n              \"fieldValue\": \"={{$node[\\\"chatID\\\"].json[\\\"chatID\\\"]}}\"\n            },\n            {\n              \"fieldName\": \"Last_language_used\",\n              \"fieldValue\": \"={{$node[\\\"Telegram Trigger\\\"].json[\\\"message\\\"][\\\"from\\\"][\\\"language_code\\\"]}}\"\n            }\n          ]\n        },\n        \"operation\": \"update\",\n        \"projectId\": \"n8n_multilang_bot_wzhb\"\n      },\n      \"credentials\": {\n        \"nocoDb\": {\n          \"id\": \"13\",\n          \"name\": \"NocoDB n8n multilang bot\"\n        }\n      },\n      \"notesInFlow\": true,\n      \"typeVersion\": 1\n    },\n    {\n      \"name\": \"Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1440,\n        80\n      ],\n      \"parameters\": {\n        \"width\": 440,\n        \"height\": 460,\n        \"content\": \"## What's this?\\nDue to some breaking API changes in NocoDB some of its node options are not working at the moment (MAY 2022). These two nodes were replaced by HTTP request nodes. Functionality is still the same.\"\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"connections\": {\n    \"IF\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"HTTP AddUser\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"HTTP UpdateUser\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Merge\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Switch\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Switch\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"New user?\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"msg_help\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        null,\n        [\n          {\n            \"node\": \"msg_wrongcommand\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"chatID\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"LoadDictionary\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"CheckUser\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Merge\",\n            \"type\": \"main\",\n            \"index\": 1\n          }\n        ]\n      ]\n    },\n    \"New user?\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"IF\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"botmessages\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"CheckUser\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"HTTP AddUser\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"msg_greet\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"LoadDictionary\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"botmessages\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"HTTP UpdateUser\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"msg_welcomeback\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Telegram Trigger\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"chatID\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Merge\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.function",
      "n8n-nodes-base.merge",
      "n8n-nodes-base.switch",
      "n8n-nodes-base.if",
      "n8n-nodes-base.telegram",
      "n8n-nodes-base.telegram",
      "n8n-nodes-base.telegram",
      "n8n-nodes-base.telegram",
      "n8n-nodes-base.function",
      "n8n-nodes-base.nocoDb",
      "n8n-nodes-base.nocoDb",
      "n8n-nodes-base.function",
      "n8n-nodes-base.telegramTrigger",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.nocoDb",
      "n8n-nodes-base.nocoDb",
      "n8n-nodes-base.stickyNote"
    ],
    "trigger": "telegram trigger"
  }
}