{
  "source": "0385_Wait_Code_Send_Scheduled.json",
  "index": 1,
  "content": "{\n  \"meta\": {\n    \"instanceId\": \"cb484ba7b742928a2048bf8829668bed5b5ad9787579adea888f05980292a4a7\"\n  },\n  \"nodes\": [\n    {\n      \"id\": \"fe775b06-0264-49ea-af29-16289fee1100\",\n      \"name\": \"Get events page\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        -660,\n        1160\n      ],\n      \"parameters\": {\n        \"url\": \"={{ $json.location }}/this-month?page={{ $runIndex+1}}\",\n        \"options\": {}\n      },\n      \"typeVersion\": 3\n    },\n    {\n      \"id\": \"c55554f4-f06c-4084-b9c2-454cf290682b\",\n      \"name\": \"Last page?\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        0,\n        1160\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"number\": [\n            {\n              \"value1\": \"={{ $items().length }}\",\n              \"value2\": \"=50\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"3d750b8a-4288-45ac-af2d-24fc6b7126ec\",\n      \"name\": \"Get all events from the page\",\n      \"type\": \"n8n-nodes-base.htmlExtract\",\n      \"position\": [\n        -440,\n        1160\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"trimValues\": true\n        },\n        \"extractionValues\": {\n          \"values\": [\n            {\n              \"key\": \"events\",\n              \"cssSelector\": \"li.event-listings-element\",\n              \"returnArray\": true,\n              \"returnValue\": \"html\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"84b570d5-60ad-4cb1-9428-1cc3372954cb\",\n      \"name\": \"Get each event data\",\n      \"type\": \"n8n-nodes-base.htmlExtract\",\n      \"position\": [\n        420,\n        1140\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"dataPropertyName\": \"events\",\n        \"extractionValues\": {\n          \"values\": [\n            {\n              \"key\": \"date\",\n              \"attribute\": \"datetime\",\n              \"cssSelector\": \"time\",\n              \"returnArray\": true,\n              \"returnValue\": \"attribute\"\n            },\n            {\n              \"key\": \"artist\",\n              \"cssSelector\": \"p.artists strong\"\n            },\n            {\n              \"key\": \"support\",\n              \"cssSelector\": \"p.artists span.support\"\n            },\n            {\n              \"key\": \"location\",\n              \"cssSelector\": \"p.location\"\n            },\n            {\n              \"key\": \"eventLink\",\n              \"attribute\": \"href\",\n              \"cssSelector\": \"a.event-link\",\n              \"returnValue\": \"attribute\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"783555d1-1c9c-4bda-8969-0ac46dced10e\",\n      \"name\": \"Limit to one\",\n      \"type\": \"n8n-nodes-base.itemLists\",\n      \"position\": [\n        420,\n        1300\n      ],\n      \"parameters\": {\n        \"operation\": \"limit\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"fdd1c66b-5e20-4c2d-8c01-38555621ec84\",\n      \"name\": \"Wait 3s\",\n      \"type\": \"n8n-nodes-base.wait\",\n      \"position\": [\n        220,\n        1300\n      ],\n      \"webhookId\": \"617f8c35-66e5-4fca-b974-cf9fc4130d68\",\n      \"parameters\": {\n        \"unit\": \"seconds\",\n        \"amount\": 3\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"49b5b5c7-9645-42cb-89ec-bb9972c8b379\",\n      \"name\": \"Split events\",\n      \"type\": \"n8n-nodes-base.itemLists\",\n      \"position\": [\n        -220,\n        1160\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"fieldToSplitOut\": \"events\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"30b06dc8-d896-4684-9c79-3d845f1041ac\",\n      \"name\": \"Collect all results\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        220,\n        1140\n      ],\n      \"parameters\": {\n        \"jsCode\": \"let results = [],\\n  i = 0;\\n\\ndo {\\n  try {\\n    results = results.concat($items('Split events', 0, i));\\n  } catch (error) {\\n    return results;\\n  }\\n  i++;\\n} while(true);\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"ea9444ad-06a3-4567-9638-ce8ef8bfff23\",\n      \"name\": \"ü§ñ Each month\",\n      \"type\": \"n8n-nodes-base.scheduleTrigger\",\n      \"position\": [\n        -1220,\n        1160\n      ],\n      \"parameters\": {\n        \"rule\": {\n          \"interval\": [\n            {\n              \"field\": \"months\",\n              \"triggerAtHour\": 20\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"73f7295d-c0f7-42b6-8784-3198538e6e48\",\n      \"name\": \"Setup location and email\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        -880,\n        1160\n      ],\n      \"parameters\": {\n        \"values\": {\n          \"string\": [\n            {\n              \"name\": \"location\"\n            },\n            {\n              \"name\": \"email\"\n            }\n          ]\n        },\n        \"options\": {},\n        \"keepOnlySet\": true\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"a3529743-a7fd-4056-80a9-63b0dac259d6\",\n      \"name\": \"üíÑ Lick the stamp\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        620,\n        1140\n      ],\n      \"parameters\": {\n        \"jsCode\": \"const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec' ];\\n\\nlet html = `<table style=\\\"width: 100%\\\">`;\\nfor (const item of $input.all()) {\\n  const eventDate = new Date(item.json.date[0]);\\n  \\n   html += `\\n    <tr>\\n      <td style=\\\"width: 60px; background-color: #2e2e32; font-family: sans-serif\\\">\\n        <a href=\\\"https://www.songkick.com${item.json.eventLink}\\\" style=\\\"color: #dcdfe6; text-decoration: none\\\">\\n          <p style=\\\"font-weight: bold; text-align: center; margin: 5px 0 0; padding: 0 0.5em\\\">${monthNames[eventDate.getMonth()]}</p>\\n          <p style=\\\"font-weight: bold; font-size: 1.5em; text-align: center; margin: 0 0 2px\\\">${eventDate.getDate()}</p>\\n        </a>\\n      </td>\\n      <td style=\\\"background-color: #f2f4f8; font-family: sans-serif; padding: 0.3em 0.5em\\\">\\n        <a href=\\\"https://www.songkick.com${item.json.eventLink}\\\" style=\\\"color: #555555; text-decoration: none\\\">\\n        <div>\\n          <p style=\\\"font-size: 1.2em; margin: 0\\\"><b>${item.json.artist}</b>`\\n\\n  if (item.json.support) {\\n    html = html + `<span style=\\\"color: #7d7d87; margin:0\\\"> + ${item.json.support}</span>`;\\n  }\\n  \\n  html += `\\n          </p><p style=\\\"color: #7d7d87; margin: 0\\\">${item.json.location.split(',')[0].replace(/(\\\\r\\\\n|\\\\n|\\\\r)/gm, \\\"\\\")}</p>\\n        </div>\\n        </a>\\n      </td>\\n  </tr>\\n   `\\n}\\nhtml += '</table>';\\n\\nreturn { \\n  \\\"html\\\": html,\\n  \\\"total\\\": $input.all().length \\n};\\n//$input.all();\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"a8f0e1cf-e8b5-402f-9336-4c623980a315\",\n      \"name\": \"‚úâÔ∏è Send it\",\n      \"type\": \"n8n-nodes-base.gmail\",\n      \"position\": [\n        820,\n        1140\n      ],\n      \"parameters\": {\n        \"sendTo\": \"={{ $('Setup location and email').params[\\\"values\\\"][\\\"string\\\"][1][\\\"value\\\"] }}\",\n        \"message\": \"={{ $json[\\\"html\\\"] }}\",\n        \"options\": {\n          \"senderName\": \"=Monthly event newsletter\"\n        },\n        \"subject\": \"=üì´ This month: {{$json[\\\"total\\\"]}} events!\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"e23fd2fc-baf3-4494-ae4a-ddb51f45ff3c\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -940,\n        1080\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"height\": 230.21423635107112,\n        \"content\": \"### Setup your location link and receiver email(s) here\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"58300fe9-e3b3-452f-b13b-a9296cf05a71\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        800,\n        1060\n      ],\n      \"parameters\": {\n        \"color\": 3,\n        \"height\": 230.21423635107112,\n        \"content\": \"###  Don't forget to connect a GMail account to this node!\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"663147c1-1af0-49f3-9671-3d1d66e7a6f0\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        460,\n        720\n      ],\n      \"parameters\": {\n        \"color\": 4,\n        \"content\": \"## Don't forget to activate the workflow here ‚òùÔ∏è\"\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"pinData\": {},\n  \"connections\": {\n    \"Wait 3s\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Limit to one\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Last page?\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Collect all results\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Wait 3s\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Limit to one\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Setup location and email\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Split events\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Last page?\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get events page\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get all events from the page\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"ü§ñ Each month\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Setup location and email\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Collect all results\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get each event data\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get each event data\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"üíÑ Lick the stamp\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"üíÑ Lick the stamp\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"‚úâÔ∏è Send it\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Setup location and email\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get events page\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get all events from the page\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Split events\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}",
  "metadata": {
    "node_types": [
      "n8n-nodes-base.httpRequest",
      "n8n-nodes-base.if",
      "n8n-nodes-base.htmlExtract",
      "n8n-nodes-base.htmlExtract",
      "n8n-nodes-base.itemLists",
      "n8n-nodes-base.wait",
      "n8n-nodes-base.itemLists",
      "n8n-nodes-base.code",
      "n8n-nodes-base.scheduleTrigger",
      "n8n-nodes-base.set",
      "n8n-nodes-base.code",
      "n8n-nodes-base.gmail",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote",
      "n8n-nodes-base.stickyNote"
    ],
    "trigger": null
  }
}